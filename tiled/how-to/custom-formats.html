

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Add Support for a Custom Format &mdash; tiled 0.1.0a23.post1+g929bb59 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Use Profiles to streamline Python client setup" href="profiles.html" />
    <link rel="prev" title="Serve Trees using Configuration Files" href="configuration.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> tiled
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0a23.post1+g929bb59
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/navigation.html">Navigate with the Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/slicing.html">Load Slices of Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/caching.html">Keep a Local Copy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/export.html">Deliberate Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/serving-files.html">Serve a Directory of Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/search.html">Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/plotly-integration.html">Plot Data in Plotly Chart Studio</a></li>
</ul>
<p class="caption"><span class="caption-text">How To Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Serve Trees using Configuration Files</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Add Support for a Custom Format</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#define-an-exporter">Define an exporter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#register-the-exporter">Register the exporter</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="profiles.html">Use Profiles to streamline Python client setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="direct-client.html">Use Tiled in Python without an HTTP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="scaling.html">Control Speed, Memory Usage, and Disk Usage</a></li>
</ul>
<p class="caption"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/structures.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/access-control.html">Access Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/lineage.html">How Tiled Fits into the Ecosystem</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/service.html">Service-side Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/http-api-overview.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/python-client.html">Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/authentication.html">Authentication Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/commandline.html">Command-line tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/service-configuration.html">Service Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/client-profiles.html">Client Profiles Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/design-documents/index.html">Design Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/min-versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tiled</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Add Support for a Custom Format</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/how-to/custom-formats.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="tex2jax_ignore mathjax_ignore section" id="add-support-for-a-custom-format">
<h1>Add Support for a Custom Format<a class="headerlink" href="#add-support-for-a-custom-format" title="Permalink to this headline">¶</a></h1>
<p>For a given “structure family” (e.g. <code class="docutils literal notranslate"><span class="pre">array</span></code>, <code class="docutils literal notranslate"><span class="pre">dataframe</span></code>) the Tiled server
can provide the data—in whole or in part—in a variety of formats.
See <a class="reference internal" href="../tutorials/export.html"><span class="doc">Deliberate Export</span></a> for a list of the formats supported out of the
box.</p>
<p>To teach Tiled to serve another format, first decide which structure family or
families are appropriate for this format. For example, it makes sense to export
a table an Excel spreadsheet, but it does not generally make sense to export an
N-dimensional array as an Excel spreadsheet. (If you do, you making specific
assumptions about the array.)</p>
<p>For this guide, we’ll take the example of
<a class="reference external" href="https://github.com/XraySpectroscopy/XAS-Data-Interchange/blob/master/specification/spec.md#example-xdi-file">XDI</a>,
which is a formalized text-based format for X-ray Spectroscopy data. As you can
see from the linked example, the file’s contents comprise a single table
and a header of key–value pairs. Therefore, it makes sense to export <code class="docutils literal notranslate"><span class="pre">dataframe</span></code>
structures and their associated metadata into this format.</p>
<p>Take the following simple server configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># config.yml</span>
<span class="nt">trees</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
  <span class="nt">tree</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tiled.examples.xas:tree</span>
</pre></div>
</div>
<p>and serve it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tiled</span> <span class="n">serve</span> <span class="n">config</span> <span class="o">--</span><span class="n">public</span> <span class="n">config</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>As is, we can access the data as CSV, for example.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -H &#39;Accept: text/csv&#39; &#39;http://localhost:8000/dataframe/full/example&#39;
energy,i0,itrans,mutrans
8779.0,149013.7,550643.089065,-1.3070486
8789.0,144864.7,531876.119084,-1.3006104
8799.0,132978.7,489591.10592,-1.3033816
8809.0,125444.7,463051.104096,-1.3059724
8819.0,121324.7,449969.103983,-1.3107085
8829.0,119447.7,444386.117562,-1.3138152
8839.0,119100.7,440176.091039,-1.3072055
8849.0,117707.7,440448.106567,-1.3195882
8859.0,117754.7,442302.10637,-1.3233895
8869.0,117428.7,441944.116528,-1.3253521
8879.0,117383.7,442810.120466,-1.327693
8889.0,117185.7,443658.11566,-1.3312944
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are three equivalent ways to request a format, more formally called a “media type” or a “MIME type”.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1. Use the standard [HTTP `Accept` Header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept).

```
$ curl -H &#39;Accept: text/csv&#39; &#39;http://localhost:8000/dataframe/full/example&#39;
```

2. Place the media type in a `format` query parameter.

```
$ curl &#39;http://localhost:8000/dataframe/full/example?format=text/csv&#39;
```

3. Provide just a file extension. This is user friendly for people who do not know or care what
a &quot;media type&quot; is. The server looks up `csv` in a registry mapping file extensions to media types.

```
$ curl &#39;http://localhost:8000/dataframe/full/example?format=csv&#39;
```
</pre></div>
</div>
</div>
<div class="section" id="define-an-exporter">
<h2>Define an exporter<a class="headerlink" href="#define-an-exporter" title="Permalink to this headline">¶</a></h2>
<p>When a client requests an XDI-formatted response, the Tiled server
will call our custom exporter with two arguments: the structure itself
(in this case, a <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code>) and a dictionary of metadata.
The metadata is freeform as far as Tiled is concerned—its content
and any internal structure is completely up to the user—so if we
have special requirements about what it must contain, we need to
do that validation inside our exporter. We might, for example,
refuse to export (raise an error) if required fields are missing
from the metadata or if the DataFrame we are given does not have the
expected columns.</p>
<p>The exporter must return either <code class="docutils literal notranslate"><span class="pre">str</span></code> or <code class="docutils literal notranslate"><span class="pre">bytes</span></code>.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># exporter.py</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="k">def</span> <span class="nf">serialize_xdi</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Note: This serves its purpose of documenting how to add support for</span>
<span class="sd">    a custom format in Tiled, but the details are just a draft.</span>
<span class="sd">    This will be revised in the future.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# XDI/1.0 tiled/0.1.0a20</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># TODO validation/formatting of metadata</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# /////////////</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# generated by tiled</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# -------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># write column labels</span>
    <span class="c1"># TODO should we expect the index to be set?</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataframe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# &quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># write data</span>
    <span class="n">dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="register-the-exporter">
<h2>Register the exporter<a class="headerlink" href="#register-the-exporter" title="Permalink to this headline">¶</a></h2>
<p>Add new sections to the configuration as follows.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">trees</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
  <span class="nt">tree</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tiled.examples.xas:tree</span>
<span class="nt">media_types</span><span class="p">:</span>
  <span class="nt">dataframe</span><span class="p">:</span>
    <span class="nt">application/x-xdi</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">exporter:serialize_xdi</span>
<span class="nt">file_extensions</span><span class="p">:</span>
  <span class="nt">xdi</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">application/x-xdi</span>
</pre></div>
</div>
<p>First consider the section</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">media_types</span><span class="p">:</span>
  <span class="nt">dataframe</span><span class="p">:</span>
    <span class="nt">application/x-xdi</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">exporter:serialize_xdi</span>
</pre></div>
</div>
<p>The key, <code class="docutils literal notranslate"><span class="pre">application/x-xdi</span></code> is a valid media type. In our case, there is no
registered <a class="reference external" href="https://www.iana.org/assignments/media-types/media-types.xhtml">IANA Media Type</a>
for the format of interest. Thererfore, the standard tells us
to invent one of the form <code class="docutils literal notranslate"><span class="pre">application/x-*</span></code>, as in <code class="docutils literal notranslate"><span class="pre">application/x-xdi</span></code>. There
is, of course, some risk of name collisions when we invent names outside of the
official list, so be specific.</p>
<p>The final section</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">file_extensions</span><span class="p">:</span>
  <span class="nt">xdi</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">application/x-xdi</span>
</pre></div>
</div>
<p>enables the usage</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl &#39;http://...?format=xdi&#39;
</pre></div>
</div>
<p>by mapping <code class="docutils literal notranslate"><span class="pre">&quot;xdi&quot;</span></code> to the media type. This is optional. You can provide
no file extensions for a media type. You can also provide <em>multiple</em>
file extensions that map to the same media type. For example, both
<code class="docutils literal notranslate"><span class="pre">tif</span></code> and <code class="docutils literal notranslate"><span class="pre">tiff</span></code> map to <code class="docutils literal notranslate"><span class="pre">image/tiff</span></code>.</p>
<p>The value, <code class="docutils literal notranslate"><span class="pre">exporter:serialize_xdi</span></code>, is the module or package that our
exporter is defined in, followed by <code class="docutils literal notranslate"><span class="pre">:</span></code> and then the function name.</p>
<p>The Python file where <code class="docutils literal notranslate"><span class="pre">serialize_xdi</span></code> is defined by must in an importable location.
During configuration-parsing, Tiled <em>temporarily</em> adds the directory containing
the config file itself to <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>. This means that we can conveniently
drop <code class="docutils literal notranslate"><span class="pre">exporter.py</span></code> next to <code class="docutils literal notranslate"><span class="pre">config.yml</span></code> and know that it will be found.
For long-term deployments it’s better to place exporters in installable Python
packages (i.e. with a proper <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, etc.) but for prototyping and
development this is much more expedient.</p>
<p>Now if we restart the server again with this updated <code class="docutils literal notranslate"><span class="pre">config.yml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tiled</span> <span class="n">serve</span> <span class="n">config</span> <span class="o">--</span><span class="n">public</span> <span class="n">config</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>we can request the content as XDI in any of these ways:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -H &#39;Accept: application/x-xdi&#39; &#39;http://localhost:8000/dataframe/full/example&#39;
$ curl &#39;http://localhost:8000/dataframe/full/example?format=application/x-xdi&#39;
$ curl &#39;http://localhost:8000/dataframe/full/example?format=xdi&#39;
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="profiles.html" class="btn btn-neutral float-right" title="Use Profiles to streamline Python client setup" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="configuration.html" class="btn btn-neutral float-left" title="Serve Trees using Configuration Files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Bluesky Collaboration.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>