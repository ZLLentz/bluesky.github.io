
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Get Data from a Run &mdash; databroker 1.2.5.post9+gf7b9672d documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Navigate Metadata in a Run" href="get-metadata.html" />
    <link rel="prev" title="Find Runs in a Catalog" href="search-and-lookup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> databroker
          </a>
              <div class="version">
                1.2.5.post9+gf7b9672d
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="search-and-lookup.html">Find Runs in a Catalog</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Get Data from a Run</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#set-up-for-tutorial">Set up for Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-s-in-the-run">What’s in the Run?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-the-data">Get the data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#handle-large-data">Handle large data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="get-metadata.html">Navigate Metadata in a Run</a></li>
<li class="toctree-l1"><a class="reference internal" href="export.html">Export Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/download-data-samples.html">How to download some Catalogs with data samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/file-backed-catalog.html">How to create a new Catalog backed by files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/store-data-from-run-engine.html">How to store data from the Run Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/store-analysis-results.html">How to store analysis results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/mongo-backed-catalog.html">How to create a new Catalog backed by MongoDB</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/v2-transition.html">What are the API versions v0, v1, v2?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/local-and-remote-use-cases.html">How can it be used locally and remotely?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/relationship-to-intake.html">What is Databroker’s relationship to Intake?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/v2.html">New (v2) API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/v1.html">Original (v1 / v0) API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/configuration.html">Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/changelog.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bluesky Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io">Homepage</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bluesky">GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://gitter.im/NSLS-II/DAMA">Gitter</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">databroker</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Get Data from a Run</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/get-data.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="get-data-from-a-run">
<h1>Get Data from a Run<a class="headerlink" href="#get-data-from-a-run" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial we will:</p>
<ul class="simple">
<li><p>Load all the data from a small Run and do some basic math and visualization.</p></li>
<li><p>Load and visualize just a slice of data from a 1 GB dataset, without loading
the whole dataset.</p></li>
</ul>
<section id="set-up-for-tutorial">
<h2>Set up for Tutorial<a class="headerlink" href="#set-up-for-tutorial" title="Permalink to this headline">¶</a></h2>
<p>Before you begin, install <code class="docutils literal notranslate"><span class="pre">databroker</span></code> and <code class="docutils literal notranslate"><span class="pre">databroker-pack</span></code>, following the
<a class="reference internal" href="install.html"><span class="doc">Installation Tutorial</span></a>.</p>
<p>Start your favorite interactive Python environment, such as <code class="docutils literal notranslate"><span class="pre">ipython</span></code> or
<code class="docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">lab</span></code>.</p>
<p>For this tutorial, we’ll use a catalog of publicly available, openly licensed
sample data. Specifically, it is high-quality transmission XAS data from all
over the periodical table.</p>
<p>This utility downloads it and makes it discoverable to Databroker.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span> <span class="nn">databroker.tutorial_utils</span>

<span class="gp">In [2]: </span><span class="n">databroker</span><span class="o">.</span><span class="n">tutorial_utils</span><span class="o">.</span><span class="n">fetch_BMM_example</span><span class="p">()</span>
<span class="gh">Out[2]: </span><span class="go">bluesky-tutorial-BMM:</span>
<span class="go">  args:</span>
<span class="go">    name: bluesky-tutorial-BMM</span>
<span class="go">    paths:</span>
<span class="go">    - /home/runner/.local/share/bluesky_tutorial_data/bluesky-tutorial-BMM/documents/*.msgpack</span>
<span class="go">    root_map: {}</span>
<span class="go">  description: &#39;&#39;</span>
<span class="go">  driver: databroker._drivers.msgpack.BlueskyMsgpackCatalog</span>
<span class="go">  metadata:</span>
<span class="go">    catalog_dir: /home/runner/.local/share/intake/</span>
<span class="go">    generated_by:</span>
<span class="go">      library: databroker_pack</span>
<span class="go">      version: 0.3.0</span>
<span class="go">    relative_paths:</span>
<span class="go">    - ./documents/*.msgpack</span>
</pre></div>
</div>
<p>Access the catalog as assign it to a variable for convenience.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [3]: </span><span class="kn">import</span> <span class="nn">databroker</span>

<span class="gp">In [4]: </span><span class="n">catalog</span> <span class="o">=</span> <span class="n">databroker</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;bluesky-tutorial-BMM&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Let’s take a Run from this Catalog.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [5]: </span><span class="n">run</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="mi">23463</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="what-s-in-the-run">
<h2>What’s in the Run?<a class="headerlink" href="#what-s-in-the-run" title="Permalink to this headline">¶</a></h2>
<p>The Run’s “pretty display”, shown by IPython and Jupyter and some other
similar tools, shows us a summary.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [6]: </span><span class="n">run</span>
<span class="gh">Out[6]: </span><span class="go"></span>
<span class="go">BlueskyRun</span>
<span class="go">  uid=&#39;4393404b-8986-4c75-9a64-d7f6949a9344&#39;</span>
<span class="go">  exit_status=&#39;success&#39;</span>
<span class="go">  2020-03-07 10:29:49.483 -- 2020-03-07 10:41:20.546</span>
<span class="go">  Streams:</span>
<span class="go">    * primary</span>
<span class="go">    * baseline</span>
</pre></div>
</div>
<p>Each run contains logical “tables” of data called <em>streams</em>. We can see them in
the summary above, and we iterate over them programmatically with a <code class="docutils literal notranslate"><span class="pre">for</span></code>
loop or with <code class="docutils literal notranslate"><span class="pre">list</span></code>.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [7]: </span><span class="nb">list</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
<span class="gh">Out[7]: </span><span class="go">[&#39;primary&#39;, &#39;baseline&#39;]</span>
</pre></div>
</div>
</section>
<section id="get-the-data">
<h2>Get the data<a class="headerlink" href="#get-the-data" title="Permalink to this headline">¶</a></h2>
<p>Access a stream by name. This returns an <a class="reference external" href="https://xarray.pydata.org/">xarray</a> Dataset.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [8]: </span><span class="n">ds</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="gp">In [9]: </span><span class="n">ds</span>
<span class="gh">Out[9]: </span><span class="go"></span>
<span class="go">&lt;xarray.Dataset&gt;</span>
<span class="go">Dimensions:                   (time: 411)</span>
<span class="go">Coordinates:</span>
<span class="go">  * time                      (time) float64 1.584e+09 1.584e+09 ... 1.584e+09</span>
<span class="go">Data variables:</span>
<span class="go">    I0                        (time) float64 135.2 135.0 134.8 ... 99.55 99.31</span>
<span class="go">    It                        (time) float64 123.2 123.3 123.5 ... 38.25 38.27</span>
<span class="go">    Ir                        (time) float64 55.74 55.98 56.2 ... 9.683 9.711</span>
<span class="go">    dwti_dwell_time           (time) float64 1.0 1.0 1.0 1.0 ... 1.0 1.0 1.0 1.0</span>
<span class="go">    dwti_dwell_time_setpoint  (time) float64 1.0 1.0 1.0 1.0 ... 1.0 1.0 1.0 1.0</span>
<span class="go">    dcm_energy                (time) float64 8.133e+03 8.143e+03 ... 9.075e+03</span>
<span class="go">    dcm_energy_setpoint       (time) float64 8.133e+03 8.143e+03 ... 9.075e+03</span>
</pre></div>
</div>
<p>Access columns, as in <code class="docutils literal notranslate"><span class="pre">ds[&quot;I0&quot;]</span></code>. This returns an <a class="reference external" href="https://xarray.pydata.org/">xarray</a> DataArray.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [10]: </span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;I0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>  <span class="c1"># Just show the first couple elements.</span>
<span class="gh">Out[10]: </span><span class="go"></span>
<span class="go">&lt;xarray.DataArray &#39;I0&#39; (time: 5)&gt;</span>
<span class="go">array([135.16644077, 134.97916279, 134.78557224, 134.63573771,</span>
<span class="go">       134.70294218])</span>
<span class="go">Coordinates:</span>
<span class="go">  * time     (time) float64 1.584e+09 1.584e+09 1.584e+09 1.584e+09 1.584e+09</span>
<span class="go">Attributes:</span>
<span class="go">    object:   quadem1</span>
</pre></div>
</div>
<p>Do math on columns.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [11]: </span><span class="n">normed</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;I0&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;It&quot;</span><span class="p">]</span>

<span class="gp">In [12]: </span><span class="n">normed</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>  <span class="c1"># Just show the first couple elements.</span>
<span class="gh">Out[12]: </span><span class="go"></span>
<span class="go">&lt;xarray.DataArray (time: 5)&gt;</span>
<span class="go">array([1.09747111, 1.0943401 , 1.09134056, 1.08832374, 1.08528768])</span>
<span class="go">Coordinates:</span>
<span class="go">  * time     (time) float64 1.584e+09 1.584e+09 1.584e+09 1.584e+09 1.584e+09</span>
</pre></div>
</div>
<p>Visualize them. There are couple ways to do this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The plot() method on xarray.DataArray</span>
<span class="n">ds</span><span class="p">[</span><span class="s2">&quot;I0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../tutorials/get-data-1.py">Source code</a>, <a class="reference external" href="../tutorials/get-data-1.png">png</a>, <a class="reference external" href="../tutorials/get-data-1.hires.png">hires.png</a>, <a class="reference external" href="../tutorials/get-data-1.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/get-data-1.png" class="plot-directive" src="../_images/get-data-1.png" />
</figure>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The plot accessor on xarray.Dataset</span>
<span class="n">ds</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;dcm_energy&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;I0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../tutorials/get-data-2.py">Source code</a>, <a class="reference external" href="../tutorials/get-data-2.png">png</a>, <a class="reference external" href="../tutorials/get-data-2.hires.png">hires.png</a>, <a class="reference external" href="../tutorials/get-data-2.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/get-data-2.png" class="plot-directive" src="../_images/get-data-2.png" />
</figure>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using matplotlib directly</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;dcm_energy&quot;</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;It&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;I0&quot;</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;dcm_energy&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;log(It / I0)&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../tutorials/get-data-3.py">Source code</a>, <a class="reference external" href="../tutorials/get-data-3.png">png</a>, <a class="reference external" href="../tutorials/get-data-3.hires.png">hires.png</a>, <a class="reference external" href="../tutorials/get-data-3.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/get-data-3.png" class="plot-directive" src="../_images/get-data-3.png" />
</figure>
<p>These <a class="reference external" href="https://xarray.pydata.org/">xarray</a> DataArray objects bundle a numpy (or numpy-like) array with
some additional metadata and coordinates. To access the underlying array
directly, use the <code class="docutils literal notranslate"><span class="pre">data</span></code> attribute.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [13]: </span><span class="nb">type</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;I0&quot;</span><span class="p">])</span>
<span class="gh">Out[13]: </span><span class="go">xarray.core.dataarray.DataArray</span>

<span class="gp">In [14]: </span><span class="nb">type</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;I0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="gh">Out[14]: </span><span class="go">numpy.ndarray</span>
</pre></div>
</div>
<p>Looking again at this Run</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [15]: </span><span class="n">run</span>
<span class="gh">Out[15]: </span><span class="go"></span>
<span class="go">BlueskyRun</span>
<span class="go">  uid=&#39;4393404b-8986-4c75-9a64-d7f6949a9344&#39;</span>
<span class="go">  exit_status=&#39;success&#39;</span>
<span class="go">  2020-03-07 10:29:49.483 -- 2020-03-07 10:41:20.546</span>
<span class="go">  Streams:</span>
<span class="go">    * primary</span>
<span class="go">    * baseline</span>
</pre></div>
</div>
<p>we see it has a second stream, “baseline”. Reading that, we notice that columns
it contains, its dimensions, and its coordinates are different from the ones in
“primary”. That’s why it’s in a different stream.  The “baseline” stream is a
conventional name for snapshots taken at the very beginning and end of a
procedure. We see a long list of instruments with two data points each—before
and after.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [16]: </span><span class="n">run</span><span class="o">.</span><span class="n">baseline</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="gh">Out[16]: </span><span class="go"></span>
<span class="go">&lt;xarray.Dataset&gt;</span>
<span class="go">Dimensions:                           (time: 2)</span>
<span class="go">Coordinates:</span>
<span class="go">  * time                              (time) float64 1.584e+09 1.584e+09</span>
<span class="go">Data variables: (12/35)</span>
<span class="go">    xafs_linxs                        (time) float64 -112.6 -112.6</span>
<span class="go">    xafs_linxs_user_setpoint          (time) float64 -112.6 -112.6</span>
<span class="go">    xafs_linxs_kill_cmd               (time) float64 1.0 1.0</span>
<span class="go">    compton_shield_temperature        (time) float64 28.0 29.0</span>
<span class="go">    xafs_wheel                        (time) float64 -2.655e+03 -2.655e+03</span>
<span class="go">    xafs_wheel_user_setpoint          (time) float64 -2.655e+03 -2.655e+03</span>
<span class="go">    ...                                ...</span>
<span class="go">    xafs_liny                         (time) float64 102.9 102.9</span>
<span class="go">    xafs_liny_user_setpoint           (time) float64 102.9 102.9</span>
<span class="go">    xafs_liny_kill_cmd                (time) float64 1.0 1.0</span>
<span class="go">    xafs_pitch                        (time) float64 1.735 1.735</span>
<span class="go">    xafs_pitch_user_setpoint          (time) float64 1.735 1.735</span>
<span class="go">    xafs_pitch_kill_cmd               (time) float64 1.0 1.0</span>
</pre></div>
</div>
<p>Different Runs can have different streams, but “primary” and “baseline” are the
two most common.</p>
<p>With that, we have accessed all the data from this run.</p>
</section>
<section id="handle-large-data">
<h2>Handle large data<a class="headerlink" href="#handle-large-data" title="Permalink to this headline">¶</a></h2>
<p>The example data we have been using so far has no large arrays in it. For this
section we will download a second Catalog with one Run in it that contains
image data. It’s 1 GB (uncompressed), which is large enough to exercise the
tools involved. These same techniques scale to much larger datasets.</p>
<p>The large arrays require an extra reader, which we can get from the package
<code class="docutils literal notranslate"><span class="pre">area-detector-handlers</span></code> using pip on conda.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install area-detector-handlers
<span class="c1"># or...</span>
conda install -c nsls2forge area-detector-handlers
</pre></div>
</div>
<p>Scientificaly, this is Resonant Soft X-ray Scattering (RSoXS) data. (<a class="reference external" href="https://github.com/bluesky/data-samples/blob/master/catalogs/RSOXS/README.md">Details</a>.)</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [17]: </span><span class="kn">import</span> <span class="nn">databroker.tutorial_utils</span>

<span class="gp">In [18]: </span><span class="n">databroker</span><span class="o">.</span><span class="n">tutorial_utils</span><span class="o">.</span><span class="n">fetch_RSOXS_example</span><span class="p">()</span>
</pre></div>
</div>
<p>Access the new Catalog and assign this Run to a variable.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [19]: </span><span class="kn">import</span> <span class="nn">databroker</span>

<span class="gp">In [20]: </span><span class="n">run</span> <span class="o">=</span> <span class="n">databroker</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;bluesky-tutorial-RSOXS&#39;</span><span class="p">][</span><span class="s1">&#39;777b44a&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>In the previous example, we used <code class="docutils literal notranslate"><span class="pre">run.primary.read()</span></code> at this point. That
method reads all the data from the “primary” stream from storage into memory.
This can be inconvenient if:</p>
<ol class="arabic simple">
<li><p>The data is so large it does not all fit into memory (RAM) at once. Reading
it would prompt a <code class="docutils literal notranslate"><span class="pre">MemoryError</span></code> (best case) or cause Python to crash
(worst case).</p></li>
<li><p>You only need a subset of the data for your analysis. Reading all of it
would waste time.</p></li>
</ol>
<p>In these situations, we can summon up an <a class="reference external" href="https://xarray.pydata.org/">xarray</a> backed by <em>placeholders</em>
(<a class="reference external" href="https://dask.org/">dask</a> arrays). These act like normal numpy arrays in many respects, but
internally they divide the data up intelligently into chunks. They only load
the each chunk if and when it is actually needed for a computation.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [21]: </span><span class="n">lazy_ds</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">to_dask</span><span class="p">()</span>
</pre></div>
</div>
<p>Comparing <code class="docutils literal notranslate"><span class="pre">lazy_ds[&quot;Synced_waxs_image&quot;].data</span></code> to <code class="docutils literal notranslate"><span class="pre">ds[&quot;I0&quot;].data</span></code> from the
previous section, we see that the “lazy” variant contains <code class="docutils literal notranslate"><span class="pre">&lt;dask.array</span> <span class="pre">...&gt;</span></code>
and the original contains ordinary numpy <code class="docutils literal notranslate"><span class="pre">array</span></code>.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [22]: </span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;I0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># array</span>
<span class="gh">Out[22]: </span><span class="go"></span>
<span class="go">array([135.16644077, 134.97916279, 134.78557224, 134.63573771,</span>
<span class="go">       134.70294218])</span>

<span class="gp">In [23]: </span><span class="n">lazy_ds</span><span class="p">[</span><span class="s2">&quot;Synced_waxs_image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># dask.array, a placeholder</span>
<span class="gh">Out[23]: </span><span class="go">dask.array&lt;stack, shape=(128, 1, 1024, 1026), dtype=float64, chunksize=(1, 1, 1024, 1026), chunktype=numpy.ndarray&gt;</span>
</pre></div>
</div>
<p>As an example of what’s possible, we can subtract from this image series the
mean of an image series taken while the shutter was closed (“dark” images).</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [24]: </span><span class="n">corrected</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">to_dask</span><span class="p">()[</span><span class="s2">&quot;Synced_waxs_image&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">run</span><span class="o">.</span><span class="n">dark</span><span class="o">.</span><span class="n">to_dask</span><span class="p">()[</span><span class="s2">&quot;Synced_waxs_image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

<span class="gp">In [25]: </span><span class="n">corrected</span>
<span class="gh">Out[25]: </span><span class="go"></span>
<span class="go">&lt;xarray.DataArray &#39;Synced_waxs_image&#39; (time: 128, dim_3: 1, dim_4: 1024,</span>
<span class="go">                                       dim_5: 1026)&gt;</span>
<span class="go">dask.array&lt;sub, shape=(128, 1, 1024, 1026), dtype=float64, chunksize=(1, 1, 1024, 1026), chunktype=numpy.ndarray&gt;</span>
<span class="go">Coordinates:</span>
<span class="go">  * time     (time) float64 1.574e+09 1.574e+09 ... 1.574e+09 1.574e+09</span>
<span class="go">Dimensions without coordinates: dim_3, dim_4, dim_5</span>

<span class="gp">In [26]: </span><span class="n">middle_image</span> <span class="o">=</span> <span class="n">corrected</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># Pull out a 2D slice.</span>

<span class="gp">In [27]: </span><span class="n">middle_image</span>
<span class="gh">Out[27]: </span><span class="go"></span>
<span class="go">&lt;xarray.DataArray &#39;Synced_waxs_image&#39; (dim_4: 1024, dim_5: 1026)&gt;</span>
<span class="go">dask.array&lt;getitem, shape=(1024, 1026), dtype=float64, chunksize=(1024, 1026), chunktype=numpy.ndarray&gt;</span>
<span class="go">Coordinates:</span>
<span class="go">    time     float64 1.574e+09</span>
<span class="go">Dimensions without coordinates: dim_4, dim_5</span>
</pre></div>
</div>
<p>At this point, <em>no data has yet been read</em>. We are still working with
placeholders, building up an expression of work to be done in the future.
Finally, when we plot it or otherwise hand it off to code that will treat it as
normal array, the data will be loaded and processed (in chunks) and finally
give us a normal numpy array as a result. When only a sub-slice of the data is
actually used—as is the case in this example—only the relevant chunk(s)
will ever be loaded. This can save a lot of time and memory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>

<span class="c1"># Plot a slice from the middle as an image with a log-scaled color transfer.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">middle_image</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../tutorials/get-data-4.py">Source code</a>, <a class="reference external" href="../tutorials/get-data-4.png">png</a>, <a class="reference external" href="../tutorials/get-data-4.hires.png">hires.png</a>, <a class="reference external" href="../tutorials/get-data-4.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/get-data-4.png" class="plot-directive" src="../_images/get-data-4.png" />
</figure>
<p>We can force that processing to happen explicitly by calling <code class="docutils literal notranslate"><span class="pre">.compute()</span></code>.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [28]: </span><span class="n">middle_image</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="gh">Out[28]: </span><span class="go"></span>
<span class="go">&lt;xarray.DataArray &#39;Synced_waxs_image&#39; (dim_4: 1024, dim_5: 1026)&gt;</span>
<span class="go">array([[ -9.33333333,  10.        , -12.33333333, ..., -19.        ,</span>
<span class="go">        -22.        , -17.        ],</span>
<span class="go">       [-30.66666667,   2.33333333,   0.66666667, ..., -20.33333333,</span>
<span class="go">          2.66666667,  12.66666667],</span>
<span class="go">       [ -0.33333333, -16.66666667, -23.66666667, ..., -26.33333333,</span>
<span class="go">         15.66666667,  -7.66666667],</span>
<span class="go">       ...,</span>
<span class="go">       [ 10.        ,   0.33333333,  -9.66666667, ..., -22.66666667,</span>
<span class="go">        -37.66666667, -25.33333333],</span>
<span class="go">       [ -3.33333333,  -7.66666667,  -7.33333333, ...,   6.        ,</span>
<span class="go">        -32.        , -12.        ],</span>
<span class="go">       [ -5.        ,  -4.        ,  -2.33333333, ...,  -7.        ,</span>
<span class="go">         16.33333333,  -6.        ]])</span>
<span class="go">Coordinates:</span>
<span class="go">    time     float64 1.574e+09</span>
<span class="go">Dimensions without coordinates: dim_4, dim_5</span>
</pre></div>
</div>
<p>Notice that we now see <code class="docutils literal notranslate"><span class="pre">array</span></code> in there instead of
<code class="docutils literal notranslate"><span class="pre">&lt;dask.array&gt;</span></code>. This is how we know that it’s a normal array in memory, not a
placeholder for future work.</p>
<p>For more, see the <a class="reference external" href="https://xarray.pydata.org/">xarray</a> documentation and the <a class="reference external" href="https://dask.org/">dask</a> documentation. A good
entry point is the example covering <a class="reference external" href="https://examples.dask.org/array.html">Dask Arrays</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="search-and-lookup.html" class="btn btn-neutral float-left" title="Find Runs in a Catalog" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="get-metadata.html" class="btn btn-neutral float-right" title="Navigate Metadata in a Run" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015 Brookhaven National Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>