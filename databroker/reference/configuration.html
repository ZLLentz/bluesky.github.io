
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configuration Reference &mdash; databroker 1.2.5.post15+g5fbc5eb1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Changelog" href="changelog.html" />
    <link rel="prev" title="databroker.temp_config" href="../generated/databroker.temp_config.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> databroker
          </a>
              <div class="version">
                1.2.5.post15+g5fbc5eb1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/install.html">Installation Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/search-and-lookup.html">Find Runs in a Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/get-data.html">Get Data from a Run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/get-metadata.html">Navigate Metadata in a Run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/export.html">Export Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/download-data-samples.html">How to download some Catalogs with data samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/file-backed-catalog.html">How to create a new Catalog backed by files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/store-data-from-run-engine.html">How to store data from the Run Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/store-analysis-results.html">How to store analysis results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/mongo-backed-catalog.html">How to create a new Catalog backed by MongoDB</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/v2-transition.html">What are the API versions v0, v1, v2?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/local-and-remote-use-cases.html">How can it be used locally and remotely?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/relationship-to-intake.html">What is Databroker’s relationship to Intake?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="v2.html">New (v2) API</a></li>
<li class="toctree-l1"><a class="reference internal" href="v1.html">Original (v1 / v0) API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Configuration Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#current-best-practice">Current Best Practice</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#catalog-file-search-path">Catalog File Search Path</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optional-parameters">Optional Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#driver-specific-parameters">Driver-Specific Parameters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#msgpack-example">Msgpack Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jsonl-newline-delimited-json-example">JSONL (Newline-delimited JSON) Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mongodb-example">MongoDB Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-configuration-via-python-package">Advanced: Configuration via Python Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="#legacy-v0-style-configuration">Legacy (v0-style) configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#search-path">Search path</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">MongoDB Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sqlite-example">SQLite Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Optional Parameters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#migrating-sqlite-or-hdf5-storage-to-a-format-supported-by-v2-v1">Migrating sqlite or HDF5 storage to a format supported by v2 / v1</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bluesky Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io">Homepage</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bluesky">GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://gitter.im/NSLS-II/DAMA">Gitter</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">databroker</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Configuration Reference</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/reference/configuration.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="configuration-reference">
<h1>Configuration Reference<a class="headerlink" href="#configuration-reference" title="Permalink to this headline">¶</a></h1>
<p>This covers configuration for both “old” (v0) and “new” (v2 / v1) Databroker
implementations and interfaces.</p>
<section id="current-best-practice">
<h2>Current Best Practice<a class="headerlink" href="#current-best-practice" title="Permalink to this headline">¶</a></h2>
<p>Databroker uses <a class="reference external" href="https://intake.readthedocs.io/en/latest/">intake</a>’s configuration system.</p>
<section id="catalog-file-search-path">
<h3>Catalog File Search Path<a class="headerlink" href="#catalog-file-search-path" title="Permalink to this headline">¶</a></h3>
<p>We rely on <a class="reference external" href="https://pypi.org/project/appdirs/">appdirs</a> to detect local conventions for the location of
application configuration files.  Thus, its configuration file search path is
dependent on the OS and the software environment. It can be queried like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 -c <span class="s2">&quot;import databroker; print(databroker.catalog_search_path())&quot;</span>
</pre></div>
</div>
<p>Within these directories, Databroker looks for YAML files. The filenames are
not meaningful to Databroker.</p>
<p>The general structure of a catalog YAML file is a nested dictionary of
data “sources”. Each source name is mapped to information for accessing that
data, which includes a type of “driver” and some keyword arguments to pass to
it. A “driver” is generally associated with a particular storage format.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sources</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">SOME_NAME</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SOME_DRIVER</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">SOME_PARAMETER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VALUE</span><span class="w"></span>
<span class="w">      </span><span class="nt">ANOTHER_PARAMETER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VALUE</span><span class="w"></span>
<span class="w">  </span><span class="nt">ANOTHER_NAME</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SOME_DRIVER</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">SOME_PARAMETER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VALUE</span><span class="w"></span>
<span class="w">      </span><span class="nt">ANOTHER_PARAMETER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VALUE</span><span class="w"></span>
</pre></div>
</div>
<p>As shown, multiple sources can be specified in one file. All sources found in
all the YAML files in the search path will be included as top-level entries in
<code class="docutils literal notranslate"><span class="pre">databroker.catalog</span></code>.</p>
</section>
<section id="optional-parameters">
<span id="optional-driver-parameters"></span><h3>Optional Parameters<a class="headerlink" href="#optional-parameters" title="Permalink to this headline">¶</a></h3>
<p>All Databroker “drivers” accept the following arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">handler_registry</span></code> —
If ommitted or <code class="docutils literal notranslate"><span class="pre">None</span></code>, the result of
<a class="reference internal" href="v2.html#databroker.core.discover_handlers" title="databroker.core.discover_handlers"><code class="xref py py-func docutils literal notranslate"><span class="pre">discover_handlers()</span></code></a> is used. See
<a class="reference external" href="https://blueskyproject.io/event-model/external.html" title="(in Bluesky Event Model v1.17.2.post7+g54d8907)"><span>External Assets</span></a> for background on the role of “handlers”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">root_map</span></code> —
This is passed to <code class="xref py py-func docutils literal notranslate"><span class="pre">event_model.Filler()</span></code> to account for temporarily
moved/copied/remounted files. Any resources which have a <code class="docutils literal notranslate"><span class="pre">root</span></code> matching a
key in <code class="docutils literal notranslate"><span class="pre">root_map</span></code> will be loaded using the mapped value in <code class="docutils literal notranslate"><span class="pre">root_map</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">transforms</span></code> —
A dict that maps any subset of the keys {start, stop, resource, descriptor}
to a function that accepts a document of the corresponding type and
returns it, potentially modified. This feature is for patching up
erroneous metadata. It is intended for quick, temporary fixes that
may later be applied permanently to the data at rest
(e.g., via a database migration).</p></li>
</ul>
<p>Specific drivers require format-specific arguments, shown in the following
subsections.</p>
</section>
<section id="driver-specific-parameters">
<h3>Driver-Specific Parameters<a class="headerlink" href="#driver-specific-parameters" title="Permalink to this headline">¶</a></h3>
<section id="msgpack-example">
<h4>Msgpack Example<a class="headerlink" href="#msgpack-example" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://msgpack.org/index.html">Msgpack</a> is a binary file format.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sources</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">ENTRY_NAME</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluesky-msgpack-catalog</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;DESTINATION_DIRECTORY/*.msgpack&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">ENTRY_NAME</span></code> is a name of the entry that will appear in
<code class="docutils literal notranslate"><span class="pre">databroker.catalog</span></code>, and <code class="docutils literal notranslate"><span class="pre">DESTINATION_DIRECTORY</span></code> is a directory of msgpack
files generated by <a class="reference external" href="https://github.com/bluesky/suitcase-msgpack">suitcase-msgpack</a>, as illustrated in the previous section.</p>
<p>Note that the value of <code class="docutils literal notranslate"><span class="pre">paths</span></code> is a list. Multiple directories can be grouped
into one “source”.</p>
</section>
<section id="jsonl-newline-delimited-json-example">
<h4>JSONL (Newline-delimited JSON) Example<a class="headerlink" href="#jsonl-newline-delimited-json-example" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://jsonlines.org/">JSONL</a> is a text-based format in which each line is a
valid JSON. Unlike ordinary JSON, it is suitable for streaming. This storage is
much slower than msgpack, but the format is human-readable.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sources</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">ENTRY_NAME</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluesky-jsonl-catalog</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;DESTINATION_DIRECTORY/*.jsonl&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">ENTRY_NAME</span></code> is a name of the entry that will appear in
<code class="docutils literal notranslate"><span class="pre">databroker.catalog</span></code> and <code class="docutils literal notranslate"><span class="pre">DESTINATION_DIRECTORY</span></code> is a directory of
newline-delimited JSON files generated by <a class="reference external" href="https://github.com/bluesky/suitcase-jsonl">suitcase-jsonl</a>.</p>
<p>Note that the value of <code class="docutils literal notranslate"><span class="pre">paths</span></code> is a list. Multiple directories can be grouped
into one “source”.</p>
</section>
<section id="mongodb-example">
<h4>MongoDB Example<a class="headerlink" href="#mongodb-example" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://www.mongodb.com/">MongoDB</a> is the recommended storage format for
large-scale deployments because it supports fast search.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sources</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">ENTRY_NAME</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bluesky-mongo-normalized-catalog</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">metadatastore_db</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongodb://HOST:PORT/MDS_DATABASE_NAME</span><span class="w"></span>
<span class="w">      </span><span class="nt">asset_registry_db</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongodb://HOST:PORT/ASSETS_DATABASE_NAME</span><span class="w"></span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">CATALOG_NAME</span></code> is a name of the entry that will appear in
<code class="docutils literal notranslate"><span class="pre">databroker.catalog</span></code>. The two datbase URIs, <code class="docutils literal notranslate"><span class="pre">metadatastore_db</span></code> and
<code class="docutils literal notranslate"><span class="pre">asset_registry_db</span></code>, are distinct only for historical reasons. For new
deployments, we recommend that you set them to the same value—i.e. that
you use one database shared by both.</p>
<p>If you are using Databroker on the same system where you are running
MongoDB, then the URI would be <code class="docutils literal notranslate"><span class="pre">mongodb://localhost:27017/DATABASE_NAME</span></code>
where <code class="docutils literal notranslate"><span class="pre">DATABASE_NAME</span></code> is fully up to you.</p>
<p>The driver’s name, <code class="docutils literal notranslate"><span class="pre">bluesky-mongo-normalized-catalog</span></code>, differentiates it from
the <code class="docutils literal notranslate"><span class="pre">bluesky-mongo-embedded-catalog</span></code>, an experimental alternative way of
original bluesky documents into MongoDB documents and collections. It is still
under evaluation and not yet recommended for use in production.</p>
</section>
</section>
</section>
<section id="advanced-configuration-via-python-package">
<h2>Advanced: Configuration via Python Package<a class="headerlink" href="#advanced-configuration-via-python-package" title="Permalink to this headline">¶</a></h2>
<p>To distribute catalogs to users, it may be more convenient to provide an
installable Python package, rather than placing YAML files in specific
locations on the user’s machine.  To achieve this, a Python package can
advertise catalog objects using the <code class="docutils literal notranslate"><span class="pre">'intake.catalogs'</span></code> entrypoint. Here is a
minimal example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># setup.py</span>
<span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>

<span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;example&#39;</span><span class="p">,</span>
      <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;intake.catalogs&#39;</span><span class="p">:</span>
          <span class="p">[</span><span class="s1">&#39;ENTRY_NAME = example:catalog_instance&#39;</span><span class="p">]},</span>
      <span class="n">py_modules</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;example&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example.py</span>

<span class="c1"># Create an object named `catalog_instance` which is referenced in the</span>
<span class="c1"># setup.py, and will be discovered by Databroker. How the instance is</span>
<span class="c1"># created, and what type of catalog it is, is completely up to the</span>
<span class="c1"># implementation. This is just one possible example.</span>

<span class="kn">import</span> <span class="nn">intake</span>

<span class="c1"># Look up a driver class by its name in the registry.</span>
<span class="n">catalog_class</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;bluesky-mongo-normalized-catalog&#39;</span><span class="p">]</span>

<span class="n">catalog_instance</span> <span class="o">=</span> <span class="n">catalog_class</span><span class="p">(</span>
    <span class="n">metadatastore_db</span><span class="o">=</span><span class="s1">&#39;mongodb://...&#39;</span><span class="p">,</span> <span class="n">asset_registry_db</span><span class="o">=</span><span class="s1">&#39;mongodb://...&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">entry_points</span></code> parameter in the <code class="docutils literal notranslate"><span class="pre">setup(...)</span></code> is a feature supported by
Python packaging. When this package is installed, a special file inside the
distribution, <code class="docutils literal notranslate"><span class="pre">entry_points.txt</span></code>, will advertise that is has catalogs.
DataBroker will discover these and add them to <code class="docutils literal notranslate"><span class="pre">databroker.catalog</span></code>. Note
that Databroker does <em>not</em> need to actually <em>import</em> the package to discover
its catalogs. The package will only be imported if and when the catalog is
accessed. Thus, the overhead of this discovery process is low.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Some critical details of Python’s entrypoints feature:</p>
<ul class="simple">
<li><p>Note the unusual syntax of the entrypoints. Each item is given as one long
string, with the <code class="docutils literal notranslate"><span class="pre">=</span></code> as part of the string. Modules are separated by
<code class="docutils literal notranslate"><span class="pre">.</span></code>, and the final object name is preceded by <code class="docutils literal notranslate"><span class="pre">:</span></code>.</p></li>
<li><p>The right hand side of the equals sign must point to where the object is
<em>actually defined</em>. If <code class="docutils literal notranslate"><span class="pre">catalog_instance</span></code> is defined in
<code class="docutils literal notranslate"><span class="pre">foo/bar.py</span></code> and imported into <code class="docutils literal notranslate"><span class="pre">foo/__init__.py</span></code> you might expect
<code class="docutils literal notranslate"><span class="pre">foo:catalog_instance</span></code> to work, but it does not. You must spell out
<code class="docutils literal notranslate"><span class="pre">foo.bar:catalog_instance</span></code>.</p></li>
</ul>
</div>
</section>
<section id="legacy-v0-style-configuration">
<h2>Legacy (v0-style) configuration<a class="headerlink" href="#legacy-v0-style-configuration" title="Permalink to this headline">¶</a></h2>
<p>For backward-compatibility, configuration files specifying MongoDB storage are
discovered and included in <code class="docutils literal notranslate"><span class="pre">databroker.catalog</span></code>. Other legacy formats
(SQLite, HDF5) are only accessible via v0. See
<a class="reference internal" href="../explanations/v2-transition.html#v2-transition"><span class="std std-ref">What are the API versions v0, v1, v2?</span></a>.</p>
<section id="search-path">
<h3>Search path<a class="headerlink" href="#search-path" title="Permalink to this headline">¶</a></h3>
<p>The search path for legacy configuration files differs from the new standard
search path. It is, in order of highest precedence to lowest:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">~/.config/databroker</span></code> (under the user’s home directory)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python/../etc/databroker</span></code>, where <code class="docutils literal notranslate"><span class="pre">python</span></code> is the current Python binary
reported by <code class="docutils literal notranslate"><span class="pre">sys.executable</span></code> (This allows config to be provided inside a
virtual environment.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/databroker/</span></code></p></li>
</ul>
<p>NOTE: For Windows, we only look in: <code class="docutils literal notranslate"><span class="pre">%APPDATA%\databroker</span></code>.</p>
<p>A configuration file must be located in one of these directories, and it must
be named with the extension <code class="docutils literal notranslate"><span class="pre">.yml</span></code>. Configuration files are formatted as YAML
files.</p>
</section>
<section id="id1">
<h3>MongoDB Example<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>This configuration file sets up a databroker that connects to a MongoDB server.
This requires more work to set up.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;heavyweight</span><span class="nv"> </span><span class="s">shared</span><span class="nv"> </span><span class="s">database&#39;</span><span class="w"></span>
<span class="nt">metadatastore</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;databroker.headersource.mongo&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;MDS&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;localhost&#39;</span><span class="w"></span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27017</span><span class="w"></span>
<span class="w">        </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;some_example_database&#39;</span><span class="w"></span>
<span class="w">        </span><span class="nt">timezone</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;US/Eastern&#39;</span><span class="w"></span>
<span class="nt">assets</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;databroker.assets.mongo&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Registry&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;localhost&#39;</span><span class="w"></span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27017</span><span class="w"></span>
<span class="w">        </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;some_example_database&#39;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="sqlite-example">
<h3>SQLite Example<a class="headerlink" href="#sqlite-example" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Storage in sqlite is deprecated, and not supported by the v2 or v1
interfaces. See <a class="reference internal" href="#migration-from-v0-storage"><span class="std std-ref">Migrating sqlite or HDF5 storage to a format supported by v2 / v1</span></a>.</p>
</div>
<p>This configuration file sets up a simple databroker backed by sqlite files.
This can be used immediately with no extra setup or installation.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;lightweight</span><span class="nv"> </span><span class="s">personal</span><span class="nv"> </span><span class="s">database&#39;</span><span class="w"></span>
<span class="nt">metadatastore</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;databroker.headersource.sqlite&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;MDS&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">directory</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;some_directory&#39;</span><span class="w"></span>
<span class="w">        </span><span class="nt">timezone</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;US/Eastern&#39;</span><span class="w"></span>
<span class="nt">assets</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;databroker.assets.sqlite&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Registry&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">dbpath</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;some_directory/assets.sqlite&#39;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id2">
<h3>Optional Parameters<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>With reference to the <a class="reference internal" href="#optional-driver-parameters"><span class="std std-ref">Optional Parameters</span></a>, there are some
differences in the legacy configuration files.</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">root_map</span></code> parameters is the same, and should given as a top-level key
(a peer of <code class="docutils literal notranslate"><span class="pre">assets</span></code>).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">handler_registry</span></code> parameters is spelled <code class="docutils literal notranslate"><span class="pre">handlers</span></code> and has its
contents specified differently, splitting up the module from the class. It
is, like <code class="docutils literal notranslate"><span class="pre">root_map</span></code> a top-level key.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">handlers</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">FOO</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;databroker.assets.path_only_handlers&#39;</span><span class="w"></span>
<span class="w">        </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;RawHandler&#39;</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">transforms</span></code> parameter is not supported in legacy configuration.</p></li>
</ul>
</section>
</section>
<section id="migrating-sqlite-or-hdf5-storage-to-a-format-supported-by-v2-v1">
<span id="migration-from-v0-storage"></span><h2>Migrating sqlite or HDF5 storage to a format supported by v2 / v1<a class="headerlink" href="#migrating-sqlite-or-hdf5-storage-to-a-format-supported-by-v2-v1" title="Permalink to this headline">¶</a></h2>
<p>The implementation in <code class="docutils literal notranslate"><span class="pre">databroker.v0</span></code> interfaces with storage in MongoDB,
sqlite, or HDF5.  The implementations in <code class="docutils literal notranslate"><span class="pre">databroker.v1</span></code> and
<code class="docutils literal notranslate"><span class="pre">databroker.v2</span></code> drop support for sqlite and HDF5 and add support for <a class="reference external" href="http://jsonlines.org/">JSONL</a>
(newline-delimited JSON) and <a class="reference external" href="https://msgpack.org/index.html">msgpack</a>. For binary file-based storage, we
recommend using msgpack. Data can be migrated from sqlite or HDF5 to msgpack
like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">databroker</span> <span class="kn">import</span> <span class="n">Broker</span>
<span class="kn">import</span> <span class="nn">suitcase.msgpack</span>

<span class="c1"># If the config file associated with YOUR_BROKER_NAME specifies sqlite or</span>
<span class="c1"># HDF5 storage, then this will return a databroker.v0.Broker instance.</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Broker</span><span class="o">.</span><span class="n">named</span><span class="p">(</span><span class="n">YOUR_BROKER_NAME</span><span class="p">)</span>
<span class="c1"># Loop through every run in the old Broker.</span>
<span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">db</span><span class="p">():</span>
    <span class="c1"># Load all the documents out of this run from their existing format and</span>
    <span class="c1"># write them into one file located at</span>
    <span class="c1"># `&lt;DESTINATION_DIRECTORY&gt;/&lt;uid&gt;.msgpack`.</span>
    <span class="n">suitcase</span><span class="o">.</span><span class="n">msgpack</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">documents</span><span class="p">(),</span> <span class="n">DESTINATION_DIRECTORY</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../generated/databroker.temp_config.html" class="btn btn-neutral float-left" title="databroker.temp_config" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="changelog.html" class="btn btn-neutral float-right" title="Changelog" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015 Brookhaven National Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>