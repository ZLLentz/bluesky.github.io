
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>What is Databroker’s relationship to Intake? &mdash; databroker 1.2.5.post15+g5fbc5eb1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="New (v2) API" href="../reference/v2.html" />
    <link rel="prev" title="How can it be used locally and remotely?" href="local-and-remote-use-cases.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> databroker
          </a>
              <div class="version">
                1.2.5.post15+g5fbc5eb1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/install.html">Installation Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/search-and-lookup.html">Find Runs in a Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/get-data.html">Get Data from a Run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/get-metadata.html">Navigate Metadata in a Run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/export.html">Export Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/download-data-samples.html">How to download some Catalogs with data samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/file-backed-catalog.html">How to create a new Catalog backed by files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/store-data-from-run-engine.html">How to store data from the Run Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/store-analysis-results.html">How to store analysis results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/mongo-backed-catalog.html">How to create a new Catalog backed by MongoDB</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="v2-transition.html">What are the API versions v0, v1, v2?</a></li>
<li class="toctree-l1"><a class="reference internal" href="local-and-remote-use-cases.html">How can it be used locally and remotely?</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">What is Databroker’s relationship to Intake?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#intake-concepts">Intake Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#databroker-concepts">DataBroker Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scaling-intake-catalogs">Scaling Intake Catalogs</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/v2.html">New (v2) API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/v1.html">Original (v1 / v0) API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/configuration.html">Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/changelog.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bluesky Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io">Homepage</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bluesky">GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://gitter.im/NSLS-II/DAMA">Gitter</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">databroker</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>What is Databroker’s relationship to Intake?</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/explanations/relationship-to-intake.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="what-is-databroker-s-relationship-to-intake">
<h1>What is Databroker’s relationship to Intake?<a class="headerlink" href="#what-is-databroker-s-relationship-to-intake" title="Permalink to this headline">¶</a></h1>
<section id="intake-concepts">
<h2>Intake Concepts<a class="headerlink" href="#intake-concepts" title="Permalink to this headline">¶</a></h2>
<p>Intake has a notion of Catalogs. Catalogs are roughly dict-like. Iterating over
a Catalog yields the names of its entries, which are strings. Iterating over
<code class="docutils literal notranslate"><span class="pre">catalog.items()</span></code> yields <code class="docutils literal notranslate"><span class="pre">(name,</span> <span class="pre">Entry)</span></code> pairs. An Entry is roughly like
a <code class="docutils literal notranslate"><span class="pre">functools.partial</span></code> with metadata and intake-specific semantics. When an
Entry is opened, by calling it <code class="docutils literal notranslate"><span class="pre">entry.get()</span></code> or, equivalently and more
succinctly, <code class="docutils literal notranslate"><span class="pre">entry()</span></code>, it returns its content. The content could be another
Catalog or a DataSource.</p>
<p>Calling <code class="docutils literal notranslate"><span class="pre">.read()</span></code> on a DataSource returns some in-memory representation, such
as a numpy array, pandas DataFrame, or xarray.Dataset. Calling <code class="docutils literal notranslate"><span class="pre">.to_dask()</span></code>
return the “lazy” dask-backed equivalent structure.</p>
</section>
<section id="databroker-concepts">
<h2>DataBroker Concepts<a class="headerlink" href="#databroker-concepts" title="Permalink to this headline">¶</a></h2>
<p>DataBroker represents a Bluesky “Event Stream”, a logical table of data, as a
DataSource, <a class="reference internal" href="../reference/v2.html#databroker.core.BlueskyEventStream" title="databroker.core.BlueskyEventStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlueskyEventStream</span></code></a>. Calling
<a class="reference internal" href="../reference/v2.html#databroker.core.BlueskyEventStream.read" title="databroker.core.BlueskyEventStream.read"><code class="xref py py-meth docutils literal notranslate"><span class="pre">BlueskyEventStream.read()</span></code></a> returns an xarray Dataset backed by numpy
arrays; calling <a class="reference internal" href="../reference/v2.html#databroker.core.BlueskyEventStream.to_dask" title="databroker.core.BlueskyEventStream.to_dask"><code class="xref py py-meth docutils literal notranslate"><span class="pre">BlueskyEventStream.to_dask()</span></code></a> returns an xarray Dataset
backed by dask arrays.</p>
<p>DataBroker represents a Bluesky Run, sometimes loosely referred to as a “scan”,
as a Catalog of Event Streams, <a class="reference internal" href="../reference/v2.html#databroker.core.BlueskyRun" title="databroker.core.BlueskyRun"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlueskyRun</span></code></a>. For example, the entries in
a <a class="reference internal" href="../reference/v2.html#databroker.core.BlueskyRun" title="databroker.core.BlueskyRun"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlueskyRun</span></code></a> might have the names <code class="docutils literal notranslate"><span class="pre">'primary'</span></code> and <code class="docutils literal notranslate"><span class="pre">'baseline'</span></code>.
The entries always contain instances of <a class="reference internal" href="../reference/v2.html#databroker.core.BlueskyEventStream" title="databroker.core.BlueskyEventStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlueskyEventStream</span></code></a>.
<a class="reference internal" href="../reference/v2.html#databroker.core.BlueskyRun" title="databroker.core.BlueskyRun"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlueskyRun</span></code></a> extends the standard Catalog interface with a special
method :meth:BlueskyRun.documents`. This returns a generator that yields
<code class="docutils literal notranslate"><span class="pre">(name,</span> <span class="pre">doc)</span></code> pairs, recreating the stream of documents that would have been
emitted during data acquisition. (This is akin to <code class="docutils literal notranslate"><span class="pre">Header.documents()</span></code> in
DataBroker v0.x.)</p>
<p><a class="reference internal" href="../reference/v2.html#databroker.core.BlueskyEventStream" title="databroker.core.BlueskyEventStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlueskyEventStream</span></code></a> and <a class="reference internal" href="../reference/v2.html#databroker.core.BlueskyRun" title="databroker.core.BlueskyRun"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlueskyRun</span></code></a> should never be
instantiated by the user. They have complex signatures, and they are agnostic
to the storage mechanism; they could be backed by objects in memory, files, or
databases.</p>
<p>Continuing to move up the hierarchy, we get to catalogs whose Entries contain
<a class="reference internal" href="../reference/v2.html#databroker.core.BlueskyRun" title="databroker.core.BlueskyRun"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlueskyRun</span></code></a> instances. Each entry’s name is the corresponding RunStart
<code class="docutils literal notranslate"><span class="pre">uid</span></code>. The Catalogs at this level of the hierarchy include:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../reference/v2.html#databroker._drivers.jsonl.BlueskyJSONLCatalog" title="databroker._drivers.jsonl.BlueskyJSONLCatalog"><code class="xref py py-class docutils literal notranslate"><span class="pre">_drivers.jsonl.BlueskyJSONLCatalog</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/v2.html#databroker._drivers.msgpack.BlueskyMsgpackCatalog" title="databroker._drivers.msgpack.BlueskyMsgpackCatalog"><code class="xref py py-class docutils literal notranslate"><span class="pre">_drivers.msgpack.BlueskyMsgpackCatalog</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/v2.html#databroker._drivers.mongo_normalized.BlueskyMongoCatalog" title="databroker._drivers.mongo_normalized.BlueskyMongoCatalog"><code class="xref py py-class docutils literal notranslate"><span class="pre">_drivers.mongo_normalized.BlueskyMongoCatalog</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/v2.html#databroker._drivers.mongo_embedded.BlueskyMongoCatalog" title="databroker._drivers.mongo_embedded.BlueskyMongoCatalog"><code class="xref py py-class docutils literal notranslate"><span class="pre">_drivers.mongo_embedded.BlueskyMongoCatalog</span></code></a></p></li>
</ul>
<p>Notice that these are located in an internal package, <code class="docutils literal notranslate"><span class="pre">_drivers</span></code>.  Except for
testing purposes, they should never be directly imported. They should be
accessed by their name from intake’s driver registry as in:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">intake</span>
<span class="bp">cls</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;bluesky-jsonl-catalog&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>At some point in the future, once the internal APIs stabilize, these classes
and their specific dependencies (msgpack, pymongo, etc.) will be moved out of
databroker into separate packages. Avoid directly importing from <code class="docutils literal notranslate"><span class="pre">_drivers</span></code>
so that this change will not break your code.</p>
</section>
<section id="scaling-intake-catalogs">
<h2>Scaling Intake Catalogs<a class="headerlink" href="#scaling-intake-catalogs" title="Permalink to this headline">¶</a></h2>
<p>To make Catalogs scale to tens of thousands of entries, override the methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__iter__</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__getitem__</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__contains__</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__len__</span></code></p></li>
</ul>
<p>A simple intake Catalog populates an internal dictionary, <code class="docutils literal notranslate"><span class="pre">Catalog._entries</span></code>,
mapping entry names to <code class="xref py py-class docutils literal notranslate"><span class="pre">LocalCatalogEntry</span></code> objects. This approach does
not scale to catalogs with large number of entries, where merely populating the
keys of the <code class="docutils literal notranslate"><span class="pre">Catalog._entries</span></code> dict is expensive. To customize the type of
<code class="docutils literal notranslate"><span class="pre">_entries</span></code> override <code class="xref py py-meth docutils literal notranslate"><span class="pre">Catalog._make_entries_container()</span></code> and return a
dict-<em>like</em> object. This object must support iteration (looping through part or
all of the catalog in order) and random access (requesting a specific entry by
name) by implementing <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> respectively.</p>
<p>It should also implement <code class="docutils literal notranslate"><span class="pre">__contains__</span></code> because, similarly, if
<code class="docutils literal notranslate"><span class="pre">__contains__</span></code> is specifically implemented, Python will iterate through all the
entries and check each in turn. In this case, it is likely more efficient to
implement a <code class="docutils literal notranslate"><span class="pre">__contains__</span></code> method that uses <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> to determine
whether a given key is contained.</p>
<p>Finally, the Catalog itself should implement <code class="docutils literal notranslate"><span class="pre">__len__</span></code>. If it is not
implemented, intake may obtain a Catalog’s length by iterating through it
entirely, which may be costly. If a more efficient approach is possible (e.g. a
COUNT query) it should be implemented.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="local-and-remote-use-cases.html" class="btn btn-neutral float-left" title="How can it be used locally and remotely?" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../reference/v2.html" class="btn btn-neutral float-right" title="New (v2) API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015 Brookhaven National Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>