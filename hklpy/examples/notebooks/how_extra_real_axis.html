<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to add extra motors to a diffractometer class &mdash; hklpy 0+untagged.1.gc04df81.dirty documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Rename the axes of a 4-circle diffractometer" href="var_e4cv_renamed_axes.html" />
    <link rel="prev" title="Diffractometer “Parameters”" href="how_additional_parameters.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> hklpy
          </a>
              <div class="version">
                0+untagged.1.gc04df81.dirty
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Core Functionality</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Ready-to-Use Devices</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../ready_to_use.html">Ready-to-Use Devices</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#diffractometer-geometries">Diffractometer Geometries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#how-to-guides">How-to Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="how_additional_parameters.html">Diffractometer “Parameters”</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">How to add extra motors to a diffractometer class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#imports">Imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#standard-4-circle">Standard 4-circle</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-additional-positioner">Add additional positioner</a></li>
<li class="toctree-l4"><a class="reference internal" href="#can-we-add-other-pseudo-axes">Can we add other pseudo axes?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-additional-signals-and-devices">Add additional Signals and Devices</a></li>
<li class="toctree-l4"><a class="reference internal" href="#challenges">Challenges</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#variations">Variations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tests-and-comparisons">Tests and Comparisons</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">hklpy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Examples</a> &raquo;</li>
      <li>How to add extra motors to a diffractometer class</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/examples/notebooks/how_extra_real_axis.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-to-add-extra-motors-to-a-diffractometer-class">
<h1>How to add extra motors to a diffractometer class<a class="headerlink" href="#how-to-add-extra-motors-to-a-diffractometer-class" title="Permalink to this headline">¶</a></h1>
<p>Sometimes, it is desired to add additional motor(s) (or other
components) to a subclass of
<a class="reference external" href="https://blueskyproject.io/hklpy/diffract.html#hkl.diffract.Diffractometer">hkl.diffract.Diffractometer()</a>.</p>
<p><strong>Objective</strong></p>
<p>Add one or more real positioners to the standard positioners of the
4-circle diffractometer (E4CV geometry). Use simulated motors for the
example (no EPICS required).</p>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<p>Since the <em>hklpy</em> package is a thin interface to the <em>hkl</em> library
(compiled C++ code), we need to <strong>first</strong> load the
<em>gobject-introspection</em> package (<code class="docutils literal notranslate"><span class="pre">gi</span></code>, by name) and name our required
code and version.</p>
<p>This is needed <em>every</em> time before the <em>hkl</em> package is first imported.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gi</span>
<span class="n">gi</span><span class="o">.</span><span class="n">require_version</span><span class="p">(</span><span class="s1">&#39;Hkl&#39;</span><span class="p">,</span> <span class="s1">&#39;5.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Import the additional ophyd and hklpy needed for the example.</p>
</section>
<section id="standard-4-circle">
<h2>Standard 4-circle<a class="headerlink" href="#standard-4-circle" title="Permalink to this headline">¶</a></h2>
<p>First, we start with the setup of a <a class="reference external" href="https://blueskyproject.io/hklpy/examples/notebooks/geo_e4cv.html#define-this-diffractometer">4-circle
diffractometer</a>
(E4CV is the name of the geometry). The <a class="reference external" href="https://blueskyproject.io/hklpy/geometry_tables.html#geometries-indexed-by-number-of-circles">E4CV
geometry</a>
requires these real positioners for the diffractometer circles:
<code class="docutils literal notranslate"><span class="pre">omega</span></code>, <code class="docutils literal notranslate"><span class="pre">chi</span></code>, <code class="docutils literal notranslate"><span class="pre">phi</span></code>, and <code class="docutils literal notranslate"><span class="pre">tth</span></code>. For simulated axes without
using EPICS, we use the
<a class="reference external" href="https://blueskyproject.io/ophyd/positioners.html#softpositioner">ophyd.SoftPositioner</a>.
We’ll use the (default) <a class="reference external" href="https://blueskyproject.io/hklpy/geometry_tables.html#e4cv-table">hkl calculation
engine</a>
which requires pseudo-positioners <code class="docutils literal notranslate"><span class="pre">h</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span></code>, and <code class="docutils literal notranslate"><span class="pre">l</span></code>. These
pseudo-positioners are provided by the <code class="docutils literal notranslate"><span class="pre">hkl.geometries.SimMixin</span></code>
class.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hkl</span> <span class="kn">import</span> <span class="n">E4CV</span><span class="p">,</span> <span class="n">SimMixin</span>
<span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">SoftPositioner</span>
<span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">Component</span>

<span class="k">class</span> <span class="nc">FourCircle</span><span class="p">(</span><span class="n">SimMixin</span><span class="p">,</span> <span class="n">E4CV</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Our 4-circle.  Eulerian, vertical scattering orientation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the reciprocal axes are defined by SimMixin</span>

    <span class="n">omega</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">tth</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, create the diffractometer object.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fourc</span> <span class="o">=</span> <span class="n">FourCircle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fourc&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fourc</span> <span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fourc</span> <span class="o">=</span> <span class="n">FourCircle</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fourc&#39;</span><span class="p">,</span> <span class="n">settle_time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">egu</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">,</span> <span class="n">read_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;h.readback&#39;</span><span class="p">,</span> <span class="s1">&#39;h.setpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;k.readback&#39;</span><span class="p">,</span> <span class="s1">&#39;k.setpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;l.readback&#39;</span><span class="p">,</span> <span class="s1">&#39;l.setpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;omega&#39;</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;tth&#39;</span><span class="p">],</span> <span class="n">configuration_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;energy_units&#39;</span><span class="p">,</span> <span class="s1">&#39;energy_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry_name&#39;</span><span class="p">,</span> <span class="s1">&#39;class_name&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_name&#39;</span><span class="p">,</span> <span class="s1">&#39;lattice&#39;</span><span class="p">,</span> <span class="s1">&#39;lattice_reciprocal&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;UB&#39;</span><span class="p">,</span> <span class="s1">&#39;reflections_details&#39;</span><span class="p">,</span> <span class="s1">&#39;ux&#39;</span><span class="p">,</span> <span class="s1">&#39;uy&#39;</span><span class="p">,</span> <span class="s1">&#39;uz&#39;</span><span class="p">,</span> <span class="s1">&#39;diffractometer_name&#39;</span><span class="p">,</span> <span class="s1">&#39;_hklpy_version&#39;</span><span class="p">,</span> <span class="s1">&#39;_pseudos&#39;</span><span class="p">,</span> <span class="s1">&#39;_reals&#39;</span><span class="p">,</span> <span class="s1">&#39;_constraints&#39;</span><span class="p">,</span> <span class="s1">&#39;_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;orientation_attrs&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">],</span> <span class="n">concurrent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Show the configuration of this diffractometer.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fourc</span><span class="o">.</span><span class="n">wh</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=====================</span> <span class="o">=========</span> <span class="o">=========</span>
<span class="n">term</span>                  <span class="n">value</span>     <span class="n">axis_type</span>
<span class="o">=====================</span> <span class="o">=========</span> <span class="o">=========</span>
<span class="n">diffractometer</span>        <span class="n">fourc</span>
<span class="n">sample</span> <span class="n">name</span>           <span class="n">main</span>
<span class="n">energy</span> <span class="p">(</span><span class="n">keV</span><span class="p">)</span>          <span class="mf">8.05092</span>
<span class="n">wavelength</span> <span class="p">(</span><span class="n">angstrom</span><span class="p">)</span> <span class="mf">1.54000</span>
<span class="n">calc</span> <span class="n">engine</span>           <span class="n">hkl</span>
<span class="n">mode</span>                  <span class="n">bissector</span>
<span class="n">h</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">k</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">l</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">omega</span>                 <span class="mi">0</span>         <span class="n">real</span>
<span class="n">chi</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="n">phi</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="n">tth</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="o">=====================</span> <span class="o">=========</span> <span class="o">=========</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">pyRestTable</span><span class="o">.</span><span class="n">rest_table</span><span class="o">.</span><span class="n">Table</span> <span class="n">at</span> <span class="mh">0x7f2c26669910</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="add-additional-positioner">
<h2>Add additional positioner<a class="headerlink" href="#add-additional-positioner" title="Permalink to this headline">¶</a></h2>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">FourCircle()</span></code> class, defined above, as the base class
when we add a positioner.</p>
<section id="first-subclass-fourcircle">
<h3>First, subclass <code class="docutils literal notranslate"><span class="pre">FourCircle</span></code><a class="headerlink" href="#first-subclass-fourcircle" title="Permalink to this headline">¶</a></h3>
<p>Let’s start by first creating and testing the subclass without an extra
positioner.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EnhancedFourCircle</span><span class="p">(</span><span class="n">FourCircle</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">e4c</span> <span class="o">=</span> <span class="n">EnhancedFourCircle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;e4c&quot;</span><span class="p">)</span>
<span class="n">e4c</span><span class="o">.</span><span class="n">wh</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=====================</span> <span class="o">=========</span> <span class="o">=========</span>
<span class="n">term</span>                  <span class="n">value</span>     <span class="n">axis_type</span>
<span class="o">=====================</span> <span class="o">=========</span> <span class="o">=========</span>
<span class="n">diffractometer</span>        <span class="n">e4c</span>
<span class="n">sample</span> <span class="n">name</span>           <span class="n">main</span>
<span class="n">energy</span> <span class="p">(</span><span class="n">keV</span><span class="p">)</span>          <span class="mf">8.05092</span>
<span class="n">wavelength</span> <span class="p">(</span><span class="n">angstrom</span><span class="p">)</span> <span class="mf">1.54000</span>
<span class="n">calc</span> <span class="n">engine</span>           <span class="n">hkl</span>
<span class="n">mode</span>                  <span class="n">bissector</span>
<span class="n">h</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">k</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">l</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">omega</span>                 <span class="mi">0</span>         <span class="n">real</span>
<span class="n">chi</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="n">phi</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="n">tth</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="o">=====================</span> <span class="o">=========</span> <span class="o">=========</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">pyRestTable</span><span class="o">.</span><span class="n">rest_table</span><span class="o">.</span><span class="n">Table</span> <span class="n">at</span> <span class="mh">0x7f2c6bd27190</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Compare these tables for the <code class="docutils literal notranslate"><span class="pre">fourc</span></code> and <code class="docutils literal notranslate"><span class="pre">e4c</span></code>, they are identical
except for the name difference.</p>
</section>
<section id="customize-the-subclass">
<h3>Customize the subclass<a class="headerlink" href="#customize-the-subclass" title="Permalink to this headline">¶</a></h3>
<p>Following a pattern, we simply add a <em>spinner</em> motor to the class and
create a new diffractometer object. Our simulated <em>spinner</em> will use
<code class="docutils literal notranslate"><span class="pre">rotations</span></code> as units and we’ll set it up to allow +/- 10,000
rotations. We’ll show you the first attempt (but <strong>do NOT execute this
code</strong> for reasons explained below):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EnhancedFourCircle</span><span class="p">(</span><span class="n">FourCircle</span><span class="p">):</span>
    <span class="n">spinner</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span> <span class="n">egu</span><span class="o">=</span><span class="s2">&quot;rotations&quot;</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">e4c</span> <span class="o">=</span> <span class="n">EnhancedFourCircle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;e4c&quot;</span><span class="p">)</span>
<span class="n">e4c</span><span class="o">.</span><span class="n">wh</span><span class="p">()</span>
</pre></div>
</div>
<p>But, if you actually execute this code, you crash the Python kernel
directly with no ability to interrupt that failure. (So we only <em>show</em>
you this code and do not provide it in an executable notebook cell.)</p>
<p><strong>Q</strong>: What goes wrong? <strong>A</strong>: The <code class="docutils literal notranslate"><span class="pre">Diffractometer</span></code> class is a
subclass of the
<a class="reference external" href="https://blueskyproject.io/ophyd/positioners.html?highlight=pseudopositioner#pseudopositioner">ophyd.PseudoPositioner</a>.
The PseudoPositioner maintains the transforms between the <em>real</em> axes
and the <em>pseudo</em> axes through <code class="docutils literal notranslate"><span class="pre">.forward()</span></code> and <code class="docutils literal notranslate"><span class="pre">.inverse()</span></code>
transformation methods. These two methods expect a fixed set of axis
names, yet the new <code class="docutils literal notranslate"><span class="pre">spinner</span></code> Component has been added to the list of
real axes. This extra real axis cause the failure observed. That error
<em>would</em> get caught by Python under other circumstances. Since
<code class="docutils literal notranslate"><span class="pre">Diffractometer.forward()</span></code> and <code class="docutils literal notranslate"><span class="pre">Diffractometer.inverse()</span></code> call the
underlying <em>libhkl</em> code with the full list of real positioners, and
that code does not handle this error gracefully, so the entire Python
process crashes out, without further diagnostic.</p>
<p><strong>Q</strong>: How <em>should</em> it be done so Python does not crash? <strong>A</strong>: The
<code class="docutils literal notranslate"><span class="pre">PseudoPositioner</span></code> has a feature for exactly this case: <code class="docutils literal notranslate"><span class="pre">._real</span></code> is
a list of the names of the Components that are needed specifically by
<code class="docutils literal notranslate"><span class="pre">.forward()</span></code> and <code class="docutils literal notranslate"><span class="pre">.inverse()</span></code>. (In our 4-circle example, this would
be <code class="docutils literal notranslate"><span class="pre">_real</span> <span class="pre">=</span> <span class="pre">[&quot;omega&quot;,</span> <span class="pre">&quot;chi&quot;,</span> <span class="pre">&quot;phi&quot;,</span> <span class="pre">&quot;tth&quot;]</span></code>) If we define this list in
our subclass, <em>then</em> we can add as many <em>real</em> components as we wish.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EnhancedFourCircle</span><span class="p">(</span><span class="n">FourCircle</span><span class="p">):</span>
    <span class="n">_real</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">,</span> <span class="s2">&quot;chi&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="s2">&quot;tth&quot;</span><span class="p">]</span>
    <span class="n">spinner</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span> <span class="n">egu</span><span class="o">=</span><span class="s2">&quot;rotations&quot;</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">e4c</span> <span class="o">=</span> <span class="n">EnhancedFourCircle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;e4c&quot;</span><span class="p">)</span>
<span class="n">e4c</span><span class="o">.</span><span class="n">wh</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=====================</span> <span class="o">=========</span> <span class="o">==========</span>
<span class="n">term</span>                  <span class="n">value</span>     <span class="n">axis_type</span>
<span class="o">=====================</span> <span class="o">=========</span> <span class="o">==========</span>
<span class="n">diffractometer</span>        <span class="n">e4c</span>
<span class="n">sample</span> <span class="n">name</span>           <span class="n">main</span>
<span class="n">energy</span> <span class="p">(</span><span class="n">keV</span><span class="p">)</span>          <span class="mf">8.05092</span>
<span class="n">wavelength</span> <span class="p">(</span><span class="n">angstrom</span><span class="p">)</span> <span class="mf">1.54000</span>
<span class="n">calc</span> <span class="n">engine</span>           <span class="n">hkl</span>
<span class="n">mode</span>                  <span class="n">bissector</span>
<span class="n">h</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">k</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">l</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">omega</span>                 <span class="mi">0</span>         <span class="n">real</span>
<span class="n">chi</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="n">phi</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="n">tth</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="n">spinner</span>               <span class="mi">0</span>         <span class="n">additional</span>
<span class="o">=====================</span> <span class="o">=========</span> <span class="o">==========</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">pyRestTable</span><span class="o">.</span><span class="n">rest_table</span><span class="o">.</span><span class="n">Table</span> <span class="n">at</span> <span class="mh">0x7f2c2562c5b0</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Show that we can still use both <code class="docutils literal notranslate"><span class="pre">.forward()</span></code> and <code class="docutils literal notranslate"><span class="pre">.inverse()</span></code>
methods.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fourc</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fourc</span><span class="o">.</span><span class="n">inverse</span><span class="p">((</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span> <span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fourc</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">PosCalcE4CV</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="mf">44.99999999999999</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="mf">45.00000000000001</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="mf">89.99999999999999</span><span class="p">,</span> <span class="n">tth</span><span class="o">=</span><span class="mf">89.99999999999999</span><span class="p">)</span>
<span class="n">fourc</span><span class="o">.</span><span class="n">inverse</span><span class="p">((</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span> <span class="o">=</span> <span class="n">FourCirclePseudoPos</span><span class="p">(</span><span class="n">h</span><span class="o">=-</span><span class="mf">1.0461952917773851e-16</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">6.123233995736767e-17</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="can-we-add-other-pseudo-axes">
<h2>Can we add other pseudo axes?<a class="headerlink" href="#can-we-add-other-pseudo-axes" title="Permalink to this headline">¶</a></h2>
<p><strong>Q</strong>: With this capability to add additional Components as real
positioners, can we add axes to the pseudo positioners?</p>
<p><strong>A</strong>: Unfortunately,
<a class="reference external" href="https://github.com/bluesky/ophyd/issues/924#issuecomment-718177332">no</a>.
That capability is not built into the ophyd PseudoPositioner at this
time.</p>
</section>
<section id="add-additional-signals-and-devices">
<h2>Add additional Signals and Devices<a class="headerlink" href="#add-additional-signals-and-devices" title="Permalink to this headline">¶</a></h2>
<p>Finally, we add additional Signals and Devices as Components as a
demonstration.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Device</span>
<span class="kn">from</span> <span class="nn">ophyd.signal</span> <span class="kn">import</span> <span class="n">SignalRO</span>

<span class="k">class</span> <span class="nc">XYStage</span><span class="p">(</span><span class="n">Device</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">105</span><span class="p">),</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">105</span><span class="p">),</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">solenoid_lock</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EnhancedFourCircle</span><span class="p">(</span><span class="n">FourCircle</span><span class="p">):</span>
    <span class="n">_real</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">,</span> <span class="s2">&quot;chi&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="s2">&quot;tth&quot;</span><span class="p">]</span>
    <span class="n">spinner</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span> <span class="n">egu</span><span class="o">=</span><span class="s2">&quot;rotations&quot;</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">some_signal</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">other_signal</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SignalRO</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">XYStage</span><span class="p">)</span>

<span class="n">e4c</span> <span class="o">=</span> <span class="n">EnhancedFourCircle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;e4c&quot;</span><span class="p">)</span>
<span class="n">e4c</span><span class="o">.</span><span class="n">wh</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=====================</span> <span class="o">=========</span> <span class="o">==========</span>
<span class="n">term</span>                  <span class="n">value</span>     <span class="n">axis_type</span>
<span class="o">=====================</span> <span class="o">=========</span> <span class="o">==========</span>
<span class="n">diffractometer</span>        <span class="n">e4c</span>
<span class="n">sample</span> <span class="n">name</span>           <span class="n">main</span>
<span class="n">energy</span> <span class="p">(</span><span class="n">keV</span><span class="p">)</span>          <span class="mf">8.05092</span>
<span class="n">wavelength</span> <span class="p">(</span><span class="n">angstrom</span><span class="p">)</span> <span class="mf">1.54000</span>
<span class="n">calc</span> <span class="n">engine</span>           <span class="n">hkl</span>
<span class="n">mode</span>                  <span class="n">bissector</span>
<span class="n">h</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">k</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">l</span>                     <span class="mf">0.0</span>       <span class="n">pseudo</span>
<span class="n">omega</span>                 <span class="mi">0</span>         <span class="n">real</span>
<span class="n">chi</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="n">phi</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="n">tth</span>                   <span class="mi">0</span>         <span class="n">real</span>
<span class="n">spinner</span>               <span class="mi">0</span>         <span class="n">additional</span>
<span class="o">=====================</span> <span class="o">=========</span> <span class="o">==========</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">pyRestTable</span><span class="o">.</span><span class="n">rest_table</span><span class="o">.</span><span class="n">Table</span> <span class="n">at</span> <span class="mh">0x7f2c255e21f0</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="challenges">
<h2>Challenges<a class="headerlink" href="#challenges" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">EpicsMotor</span></code> instead of <code class="docutils literal notranslate"><span class="pre">SoftPositioner</span></code> (and connect with
PVs of your EPICS system.)</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">EpicsSignal</span></code> instead of <code class="docutils literal notranslate"><span class="pre">Signal</span></code></p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">EpicsSignalRO</span></code> instead of <code class="docutils literal notranslate"><span class="pre">SignalRO</span></code></p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="how_additional_parameters.html" class="btn btn-neutral float-left" title="Diffractometer “Parameters”" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="var_e4cv_renamed_axes.html" class="btn btn-neutral float-right" title="Rename the axes of a 4-circle diffractometer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014-2021, Brookhaven National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>