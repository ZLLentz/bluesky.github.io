<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bluesky_queueserver.manager.profile_ops &mdash; bluesky-queueserver 0.post1+g95ab474 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> bluesky-queueserver
          </a>
              <div class="version">
                0.post1+g95ab474
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial (Demo)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_history.html">Release History</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction_for_users.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features_and_config.html">Features and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflow.html">Submitting and Managing Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../startup_code.html">Organizing Bluesky Startup Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ipython.html">Using IPython Startup Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../item_validation.html">Validation of Queue Items</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plan_annotation.html">Annotating Bluesky Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli_tools.html">Command-Line Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application Developer's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../interacting_with_qs.html">Interacting with Queue Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../re_manager_api.html">Run Engine Manager API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">bluesky-queueserver</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>bluesky_queueserver.manager.profile_ops</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bluesky_queueserver.manager.profile_ops</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">runpy</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">jsonschema</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">pydantic</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">from</span> <span class="nn">numpydoc.docscrape</span> <span class="kn">import</span> <span class="n">NumpyDocString</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">bluesky_queueserver</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">qserver_version</span> <span class="o">=</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">__version__</span>


<span class="k">def</span> <span class="nf">get_default_startup_dir</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the path to the default profile collection that is distributed with the package.</span>
<span class="sd">    The function does not guarantee that the directory exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pc_path</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;bluesky_queueserver&quot;</span><span class="p">,</span> <span class="s2">&quot;profile_collection_sim/&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pc_path</span>


<span class="n">_patch1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">import sys</span>
<span class="s2">import logging</span>
<span class="s2">from bluesky_queueserver.manager.profile_tools import global_user_namespace</span>
<span class="s2">logger_patch = logging.Logger(__name__)</span>

<span class="s2">global_user_namespace.set_user_namespace(user_ns=locals(), use_ipython=False)</span>

<span class="s2">try:</span>
<span class="s2">    pass  # Prevent errors when patching an empty file</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_patch2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    class IPDummy:</span>
<span class="s2">        def __init__(self, user_ns):</span>
<span class="s2">            self.user_ns = user_ns</span>

<span class="s2">            # May be this should be some meaningful logger (used by &#39;configure_bluesky_logging&#39;)</span>
<span class="s2">            self.log = logging.Logger(&#39;ipython_patch&#39;)</span>


<span class="s2">    def get_ipython_patch():</span>
<span class="s2">        ip_dummy = IPDummy(global_user_namespace.user_ns)</span>
<span class="s2">        return ip_dummy</span>

<span class="s2">    get_ipython = get_ipython_patch</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_patch3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">except BaseException as ex:</span>
<span class="s2">    # Save exception data</span>
<span class="s2">    __plan_exc_info = sys.exc_info()</span>

<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_patch_profile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Patch the profile (.py file from a beamline profile collection).</span>
<span class="sd">    Patching includes placing the code in the file in ``try..except..` block</span>
<span class="sd">    and inserting patch for ``get_ipython()`` function after the line</span>
<span class="sd">    ``from IPython import get_python``.</span>

<span class="sd">    The patched file is saved to the temporary file ``qserver/profile_temp.py``</span>
<span class="sd">    in standard directory for the temporary files. For Linux it is ``/tmp``.</span>
<span class="sd">    It is assumed that files in profile collection are processed one by one, so</span>
<span class="sd">    overwriting the same temporary file is a good way to eliminate resource leaks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_name: str</span>
<span class="sd">        full path to the patched file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        full path to the patched temporary file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># On Linux the temporary .py file will be always &#39;/tmp/qserver/profile_temp.py&#39;</span>
    <span class="c1">#   On other systems the file will be placed in appropriate location, but</span>
    <span class="c1">#   it will always be the same file.</span>
    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="s2">&quot;qserver&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tmp_fln</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;profile_temp.py&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fln_in</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">fln_in</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">GetIPythonUsed</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
        <span class="n">NOT_PRESENT</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">IMPORTED</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">CALLED</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">is_get_ipython_in_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if ``get_ipython()`` is imported or called in the line&quot;&quot;&quot;</span>
        <span class="c1"># It is assumed that commenting is done using #</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">GetIPythonUsed</span><span class="o">.</span><span class="n">NOT_PRESENT</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[^#]*IPython[^#]+get_ipython&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">GetIPythonUsed</span><span class="o">.</span><span class="n">IMPORTED</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[^#]*get_ipython&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">GetIPythonUsed</span><span class="o">.</span><span class="n">CALLED</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">patch_before_first_line</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the code file needs to be patched before the first line.</span>
<span class="sd">        The file should be patched if ``get_ipython`` is called before it is imported.</span>
<span class="sd">        Otherwise it should be patched each time it is imported</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="n">is_get_ipython</span> <span class="o">=</span> <span class="n">is_get_ipython_in_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_get_ipython</span> <span class="o">==</span> <span class="n">GetIPythonUsed</span><span class="o">.</span><span class="n">IMPORTED</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">is_get_ipython</span> <span class="o">==</span> <span class="n">GetIPythonUsed</span><span class="o">.</span><span class="n">CALLED</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># &#39;get_ipython()&#39; was not found.Don&#39;t patch the file.</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">apply_patch2</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="n">patch2_lines</span> <span class="o">=</span> <span class="n">_patch2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">patch2_lines</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">lp</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_prefix</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># Returns the sequence of spaces and tabs at the beginning of the code line</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">s</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">prefix</span>

    <span class="n">patch_first</span> <span class="o">=</span> <span class="n">patch_before_first_line</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_fln</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fln_out</span><span class="p">:</span>
        <span class="c1"># insert &#39;try ..&#39;</span>
        <span class="n">fln_out</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">_patch1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">patch_first</span><span class="p">:</span>
            <span class="n">apply_patch2</span><span class="p">(</span><span class="n">fln_out</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="n">fln_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_get_ipython_in_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="n">GetIPythonUsed</span><span class="o">.</span><span class="n">IMPORTED</span><span class="p">:</span>
                <span class="c1"># Keep the same indentation as in the preceding line</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">get_prefix</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">apply_patch2</span><span class="p">(</span><span class="n">fln_out</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="c1"># insert &#39;except ..&#39;</span>
        <span class="n">fln_out</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">_patch3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tmp_fln</span>


<span class="c1"># Discard RE and db from the profile namespace (if they exist).</span>
<span class="k">def</span> <span class="nf">_discard_re_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discard RE and db from the profile namespace (if they exist).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_re</span><span class="p">:</span>
        <span class="n">nspace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;RE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">nspace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_profile_collection</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">patch_profiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load profile collection located at the specified path. The collection consists of</span>
<span class="sd">    .py files started with &#39;DD-&#39;, where D is a digit (e.g. 05-file.py). The files</span>
<span class="sd">    are alphabetically sorted before execution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: str</span>
<span class="sd">        path to profile collection</span>
<span class="sd">    patch_profiles: boolean</span>
<span class="sd">        enable/disable patching profiles. At this point there is no reason not to</span>
<span class="sd">        patch profiles.</span>
<span class="sd">    keep_re: boolean</span>
<span class="sd">        Indicates if ``RE`` and ``db`` defined in the module should be kept (``True``)</span>
<span class="sd">        or removed (``False``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        namespace in which the profile collection was executed</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        path does not exist or the profile collection contains no valid startup files</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create the list of files to load</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load the profile collection. Path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; is not a directory.&quot;</span><span class="p">)</span>

    <span class="n">file_pattern_py</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;*.py&quot;</span><span class="p">)</span>
    <span class="n">file_pattern_ipy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;*.ipy&quot;</span><span class="p">)</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_pattern_py</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_pattern_ipy</span><span class="p">)</span>
    <span class="n">file_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Sort in alphabetical order</span>

    <span class="c1"># If the profile collection contains no startup files, it is very likely</span>
    <span class="c1">#   that the profile collection directory is specified incorrectly.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The directory &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; contains no startup files (mask &#39;[0-9][0-9]*.py&#39;).&quot;</span><span class="p">)</span>

    <span class="c1"># Add original path to the profile collection to allow local imports</span>
    <span class="c1">#   from the patched temporary file.</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="c1"># We don&#39;t want to add/remove the path if it is already in `sys.path` for some reason.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">path_is_set</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path_is_set</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Load the files into the namespace &#39;nspace&#39;.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading startup file &#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&#39; ...&quot;</span><span class="p">)</span>
            <span class="n">fln_tmp</span> <span class="o">=</span> <span class="n">_patch_profile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">if</span> <span class="n">patch_profiles</span> <span class="k">else</span> <span class="n">file</span>
            <span class="n">nspace</span> <span class="o">=</span> <span class="n">runpy</span><span class="o">.</span><span class="n">run_path</span><span class="p">(</span><span class="n">fln_tmp</span><span class="p">,</span> <span class="n">nspace</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;__plan_exc_info&quot;</span> <span class="ow">in</span> <span class="n">nspace</span><span class="p">:</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="n">nspace</span><span class="p">[</span><span class="s2">&quot;__plan_exc_info&quot;</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">_discard_re_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path_is_set</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">nspace</span>


<span class="k">def</span> <span class="nf">load_startup_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populate namespace by import a module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    module_name: str</span>
<span class="sd">        name of the module to import</span>
<span class="sd">    keep_re: boolean</span>
<span class="sd">        Indicates if ``RE`` and ``db`` defined in the module should be kept (``True``)</span>
<span class="sd">        or removed (``False``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        namespace that contains objects loaded from the module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>

    <span class="n">_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
    <span class="n">nspace</span> <span class="o">=</span> <span class="n">_module</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="n">_discard_re_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nspace</span>


<span class="k">class</span> <span class="nc">StartupLoadingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">ScriptLoadingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">def</span> <span class="nf">load_startup_script</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_local_imports</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populate namespace by import a module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    script_path : str</span>
<span class="sd">        full path to the startup script</span>
<span class="sd">    keep_re : boolean</span>
<span class="sd">        Indicates if ``RE`` and ``db`` defined in the module should be kept (``True``)</span>
<span class="sd">        or removed (``False``).</span>
<span class="sd">    enable_local_imports : boolean</span>
<span class="sd">        If ``False``, local imports from the script will not work. Setting to ``True``</span>
<span class="sd">        enables local imports.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        namespace that contains objects loaded from the module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load the script &#39;</span><span class="si">{</span><span class="n">script_path</span><span class="si">}</span><span class="s2">&#39;: script was not found&quot;</span><span class="p">)</span>

    <span class="n">nspace</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">enable_local_imports</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">script_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>  <span class="c1"># Needed to make local imports work.</span>
        <span class="c1"># Save the list of available modules</span>
        <span class="n">sm_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">nspace_global</span><span class="p">,</span> <span class="n">nspace_local</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">exec</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">nspace_global</span><span class="p">,</span> <span class="n">nspace_local</span><span class="p">)</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="n">nspace_global</span>
        <span class="n">nspace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nspace_local</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StartupLoadingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error encountered executing startup script at &#39;</span><span class="si">{</span><span class="n">script_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">enable_local_imports</span><span class="p">:</span>
            <span class="c1"># Delete data on all modules that were loaded by the script.</span>
            <span class="c1"># We don&#39;t need them anymore. Modules will be reloaded from disk if</span>
            <span class="c1">#   the script is executed again.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sm_keys</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting the key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">_discard_re_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nspace</span>


<span class="k">def</span> <span class="nf">load_worker_startup_code</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span> <span class="n">startup_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startup_module_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startup_script_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load worker startup code. Possible sources: startup directory (IPython-style profile collection),</span>
<span class="sd">    startup script or startup module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    startup_dir : str</span>
<span class="sd">        Name of the directory that contains startup files.</span>
<span class="sd">    startup_module_name : str</span>
<span class="sd">        Name of the startup module.</span>
<span class="sd">    startup_script_path : str</span>
<span class="sd">        Path to startup script.</span>
<span class="sd">    keep_re: boolean</span>
<span class="sd">        Indicates if ``RE`` and ``db`` defined in the module should be kept (``True``)</span>
<span class="sd">        or removed (``False``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nspace : dict</span>
<span class="sd">       Dictionary with loaded namespace data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">[</span><span class="n">startup_dir</span><span class="p">,</span> <span class="n">startup_module_name</span><span class="p">,</span> <span class="n">startup_script_path</span><span class="p">]])</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source of the startup code was not specified or multiple sources were specified.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">startup_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading RE Worker startup code from directory &#39;</span><span class="si">%s</span><span class="s2">&#39; ...&quot;</span><span class="p">,</span> <span class="n">startup_dir</span><span class="p">)</span>
        <span class="n">startup_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">startup_dir</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Startup directory: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">startup_dir</span><span class="p">)</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="n">load_profile_collection</span><span class="p">(</span><span class="n">startup_dir</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">startup_module_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading RE Worker startup code from module &#39;</span><span class="si">%s</span><span class="s2">&#39; ...&quot;</span><span class="p">,</span> <span class="n">startup_module_name</span><span class="p">)</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="n">load_startup_module</span><span class="p">(</span><span class="n">startup_module_name</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">startup_script_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading RE Worker startup code from script &#39;</span><span class="si">%s</span><span class="s2">&#39; ...&quot;</span><span class="p">,</span> <span class="n">startup_script_path</span><span class="p">)</span>
        <span class="n">startup_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">startup_script_path</span><span class="p">))</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="n">load_startup_script</span><span class="p">(</span><span class="n">startup_script_path</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Source of startup information is not specified. RE Worker will be started with empty environment.&quot;</span>
        <span class="p">)</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="n">nspace</span>


<span class="k">def</span> <span class="nf">extract_script_root_path</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">startup_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startup_module_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startup_script_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The function returns path to the root directory for local imports based on the source of</span>
<span class="sd">    startup files. The function returns ``None`` if root directory does not exist (e.g. when</span>
<span class="sd">    startup scripts are imported from the module). The root directory is a parameter of</span>
<span class="sd">    ``load_script_into_existing_nspace`` function. The startup code locations are checked</span>
<span class="sd">    in the same order as in ``load_worker_startup_code`` function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    startup_dir : str</span>
<span class="sd">        Name of the directory that contains startup files.</span>
<span class="sd">    startup_module_name : str</span>
<span class="sd">        Name of the startup module.</span>
<span class="sd">    startup_script_path : str</span>
<span class="sd">        Path to startup script.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or None</span>
<span class="sd">        Path to the root directory of startup files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">startup_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">startup_dir</span>
    <span class="k">elif</span> <span class="n">startup_module_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">startup_script_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">startup_script_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">load_script_into_existing_nspace</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">enable_local_imports</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">script_root_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_re</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the script into the existing namespace ``nspace``. The script is expected to be executable</span>
<span class="sd">    in the current namespace. An exception is raised if execution of the script fails. The code</span>
<span class="sd">    calling this function is responsible for capturing exceptions and displaying or storing the error</span>
<span class="sd">    messages in the convenient form.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    script: str</span>
<span class="sd">        Valid Python script, which is executable in the existing namespace.</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        The existing namespace.</span>
<span class="sd">    enable_local_imports: boolean</span>
<span class="sd">        Enable/disable local imports when loading the script (``True/False``).</span>
<span class="sd">    script_root_path: str or None</span>
<span class="sd">        Root path (hypothetic location of the script) to use for local imports. The root directory</span>
<span class="sd">        is returned by the ``extract_script_root_path`` function.</span>
<span class="sd">    update_re: boolean</span>
<span class="sd">        Update the ``RE`` and ``db`` in ``nspace`` if they are changed in the script if ``True``,</span>
<span class="sd">        discard those objects otherwise.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exceptions may be raised by the ``exec`` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>

    <span class="n">root_path_exists</span> <span class="o">=</span> <span class="n">script_root_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">script_root_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">enable_local_imports</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">root_path_exists</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The path </span><span class="si">{</span><span class="n">script_root_path</span><span class="si">!r}</span><span class="s2"> does not exist. Local imports will not work.&quot;</span><span class="p">)</span>

    <span class="n">use_local_imports</span> <span class="o">=</span> <span class="n">enable_local_imports</span> <span class="ow">and</span> <span class="n">root_path_exists</span>

    <span class="k">if</span> <span class="n">use_local_imports</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">script_root_path</span><span class="p">)</span>  <span class="c1"># Needed to make local imports work.</span>
        <span class="c1"># Save the list of available modules</span>
        <span class="n">sm_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">nspace_local</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">nspace_local</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ScriptLoadingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load stript: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">update_re</span><span class="p">:</span>
            <span class="c1"># Discard &#39;RE&#39; and &#39;db&#39;</span>
            <span class="k">if</span> <span class="s2">&quot;RE&quot;</span> <span class="ow">in</span> <span class="n">nspace_local</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">nspace_local</span><span class="p">[</span><span class="s2">&quot;RE&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;db&quot;</span> <span class="ow">in</span> <span class="n">nspace_local</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">nspace_local</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">]</span>

        <span class="c1"># A script may be partially loaded into the environment in case it fails.</span>
        <span class="c1">#   This is &#39;realistic&#39; behavior, similar to what happens in IPython.</span>
        <span class="c1">#   So make sure that all components that were loaded successfully are properly</span>
        <span class="c1">#   added to the environment.</span>
        <span class="n">nspace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nspace_local</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_local_imports</span><span class="p">:</span>
            <span class="c1"># Delete data on all modules that were loaded by the script.</span>
            <span class="c1"># We don&#39;t need them anymore. Modules will be reloaded from disk if</span>
            <span class="c1">#   the script is executed again.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sm_keys</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting the key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">script_root_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plans_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract plans from the namespace. Currently the function returns the dict of callable objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        Namespace that may contain plans.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict(str: callable)</span>
<span class="sd">        Dictionary of Bluesky plans</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plans</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">nspace</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">plans</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="k">return</span> <span class="n">plans</span>


<span class="k">def</span> <span class="nf">devices_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract signals and devices from the namespace. Currently the function returns the dict of</span>
<span class="sd">    namespace items of types inherited from ophyd.ophydobj.OphydObject objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        Namespace that may contain plans and devices.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict(str: callable)</span>
<span class="sd">        Dictionary that maps device names to device objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">protocols</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">bluesky_queueserver.manager._protocols</span> <span class="k">as</span> <span class="nn">protocols</span>

    <span class="n">devices</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">nspace</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">protocols</span><span class="o">.</span><span class="n">Readable</span><span class="p">,</span> <span class="n">protocols</span><span class="o">.</span><span class="n">Flyable</span><span class="p">)):</span>
            <span class="n">devices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="k">return</span> <span class="n">devices</span>


<span class="k">def</span> <span class="nf">prepare_plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">plans_in_nspace</span><span class="p">,</span> <span class="n">devices_in_nspace</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare the plan for execution: replace the device names (str) in the plan specification</span>
<span class="sd">    by references to ophyd objects; replace plan name by the reference to the plan.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan : dict</span>
<span class="sd">        Plan specification. Keys: `name` (str) - plan name, `args` - plan args,</span>
<span class="sd">        `kwargs` - plan kwargs. The plan parameters must contain ``user_group``.</span>
<span class="sd">    plans_in_nspace : dict(str, callable)</span>
<span class="sd">        Dictionary of existing plans from the RE workspace.</span>
<span class="sd">    devices_in_nspace : dict(str, ophyd.Device)</span>
<span class="sd">        Dictionary of existing devices from RE workspace.</span>
<span class="sd">    allowed_plans : dict(str, dict)</span>
<span class="sd">        Dictionary of allowed plans that maps group name to dictionary of plans allowed</span>
<span class="sd">        to the members of the group (group name can be found in ``plan[&quot;user_group&quot;]``.</span>
<span class="sd">    allowed_devices : dict(str, dict)</span>
<span class="sd">        Dictionary of allowed devices that maps group name to dictionary of devices allowed</span>
<span class="sd">        to the members of the group.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Parsed plan specification that contains references to plans and Ophyd devices.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        Raised in case parsing was not successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">plan_name</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">plan_args</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">plan</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">plan_kwargs</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;kwargs&quot;</span> <span class="ow">in</span> <span class="n">plan</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">plan_meta</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;meta&quot;</span> <span class="ow">in</span> <span class="n">plan</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s2">&quot;user_group&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No user group is specified in parameters for the plan &#39;</span><span class="si">{</span><span class="n">plan_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">user_group</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;user_group&quot;</span><span class="p">]</span>  <span class="c1"># User group is REQUIRED parameter of the plan</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_plans</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">user_group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_devices</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lists of allowed plans and devices is not defined for the user group &#39;</span><span class="si">{</span><span class="n">user_group</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">group_plans</span> <span class="o">=</span> <span class="n">allowed_plans</span><span class="p">[</span><span class="n">user_group</span><span class="p">]</span>
    <span class="n">group_devices</span> <span class="o">=</span> <span class="n">allowed_devices</span><span class="p">[</span><span class="n">user_group</span><span class="p">]</span>

    <span class="c1"># Run full validation of parameters (same as during plan submission)</span>
    <span class="n">success</span><span class="p">,</span> <span class="n">errmsg</span> <span class="o">=</span> <span class="n">validate_plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="o">=</span><span class="n">group_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="o">=</span><span class="n">group_devices</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation of plan parameters failed: </span><span class="si">{</span><span class="n">errmsg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create the signature based on EXISTING plan from the workspace</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">plans_in_nspace</span><span class="p">[</span><span class="n">plan_name</span><span class="p">])</span>

    <span class="c1"># Compare parameters in the signature and in the list of allowed plans. Make sure that the parameters</span>
    <span class="c1">#   in the list of allowed plans are a subset of the existing parameters (otherwise the plan can not</span>
    <span class="c1">#   be started). This not full validation.</span>
    <span class="n">existing_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">_</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">allowed_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">_</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">group_plans</span><span class="p">[</span><span class="n">plan_name</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]])</span>
    <span class="n">extra_names</span> <span class="o">=</span> <span class="n">allowed_names</span> <span class="o">-</span> <span class="n">existing_names</span>
    <span class="k">if</span> <span class="n">extra_names</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plan description in the list of allowed plans has extra parameters </span><span class="si">{</span><span class="n">extra_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Bind arguments of the plan</span>
    <span class="n">bound_args</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">plan_args</span><span class="p">,</span> <span class="o">**</span><span class="n">plan_kwargs</span><span class="p">)</span>
    <span class="c1"># Separate dictionary for the default values define in the annotation decorator</span>
    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Apply the default values defined in the annotation decorator. Default values defined in</span>
    <span class="c1">#   the decorator may still be converted to device references (e.g. str-&gt;ophyd.Device).</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">group_plans</span><span class="p">[</span><span class="n">plan_name</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_defined_in_decorator&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
                <span class="n">default_value</span> <span class="o">=</span> <span class="n">_process_default_value</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">])</span>
                <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">default_value</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">ref_from_name</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">allowed_items</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">allowed_items</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">items_in_nspace</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">items_in_nspace</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">process_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">allowed_items</span><span class="p">):</span>
        <span class="c1"># Recursively process lists (iterables) and dictionaries</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">ref_from_name</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">allowed_items</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">v</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_argument</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">allowed_items</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">v_original</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v_original</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_argument</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">allowed_items</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">process_parameter_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">group_plans</span><span class="p">,</span> <span class="n">group_devices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a parameter value ``value`` based on parameter description ``pp``</span>
<span class="sd">        (``pp = allowed_plans[&lt;plan_name&gt;][&lt;param_name&gt;]``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;annotation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">:</span>
            <span class="c1"># No annotation - attempt to convert all strings to devices</span>
            <span class="n">sel_item_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">group_devices</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">group_plans</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;plans&quot;</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;devices&quot;</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]):</span>
            <span class="c1"># &#39;Custom&#39; annotation: attempt to convert strings only to the devices</span>
            <span class="c1">#    and plans that are part of the description.</span>
            <span class="n">pname_list</span><span class="p">,</span> <span class="n">dname_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">pname_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">dname_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>
            <span class="c1"># Make sure the names are  in the allowed list</span>
            <span class="n">pname_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pname_list</span> <span class="k">if</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">group_plans</span><span class="p">])</span>
            <span class="n">dname_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dname_list</span> <span class="k">if</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">group_devices</span><span class="p">])</span>
            <span class="n">sel_item_list</span> <span class="o">=</span> <span class="n">pname_list</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dname_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If annotation (from decorator or function signature) does not contain</span>
            <span class="c1">#   lists of devices or plans, then don&#39;t attempt to do the conversion</span>
            <span class="n">sel_item_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sel_item_list</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">process_argument</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">sel_item_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="c1"># Existing items include existing devices and existing plans</span>
    <span class="n">items_in_nspace</span> <span class="o">=</span> <span class="n">devices_in_nspace</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">items_in_nspace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plans_in_nspace</span><span class="p">)</span>

    <span class="n">plan_func</span> <span class="o">=</span> <span class="n">process_argument</span><span class="p">(</span><span class="n">plan_name</span><span class="p">,</span> <span class="n">plans_in_nspace</span><span class="p">,</span> <span class="n">group_plans</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Plan &#39;</span><span class="si">{</span><span class="n">plan_name</span><span class="si">}</span><span class="s2">&#39; is not allowed or does not exist&quot;</span>

    <span class="c1"># Map names to parameter descriptions</span>
    <span class="n">param_descriptions</span> <span class="o">=</span> <span class="p">{</span><span class="n">_</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">group_plans</span><span class="p">[</span><span class="n">plan_name</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]}</span>
    <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span>
        <span class="c1"># Fetch parameter description ({} if parameter is not found)</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">param_descriptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_parameter_value</span><span class="p">(</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">group_plans</span><span class="p">,</span> <span class="n">group_devices</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">default_params</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">default_params</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span>
        <span class="c1"># Fetch parameter description ({} if parameter is not found)</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">group_plans</span><span class="p">[</span><span class="n">plan_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">default_params</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_parameter_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">group_plans</span><span class="p">,</span> <span class="n">group_devices</span><span class="p">)</span>

    <span class="n">plan_args_parsed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bound_args</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">plan_kwargs_parsed</span> <span class="o">=</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">kwargs</span>
    <span class="n">plan_kwargs_parsed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default_params</span><span class="p">)</span>

    <span class="c1"># If metadata is a list of dictionaries, then merge the dictionaries into one</span>
    <span class="c1">#   with dictionaries with lower index having higher priority.</span>
    <span class="n">success_meta</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_meta</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">plan_meta</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">success_meta</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">success_meta</span><span class="p">:</span>
            <span class="n">plan_meta</span> <span class="o">=</span> <span class="n">p</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_meta</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">success_meta</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">success_meta</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Plan metadata must be a dictionary or a list of dictionaries: &#39;</span><span class="si">{</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">plan_meta</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while parsing the plan: </span><span class="si">{</span><span class="n">err_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plan_prepared</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;callable&quot;</span><span class="p">:</span> <span class="n">plan_func</span><span class="p">,</span>
        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">plan_args_parsed</span><span class="p">,</span>
        <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="n">plan_kwargs_parsed</span><span class="p">,</span>
        <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="n">plan_meta</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">plan_prepared</span>


<span class="k">def</span> <span class="nf">prepare_function</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">func_info</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">user_group_permissions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare function for execution in the worker namespace. Returned dictionary</span>
<span class="sd">    contains reference to the callable object in the namespace, list of args and</span>
<span class="sd">    dictionary of kwargs. The function may check if the user is allowed to</span>
<span class="sd">    execute the function if ``user_group_permissions`` is provided (not ``None``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func_info: dict</span>
<span class="sd">        Dictionary which contains keys: ``name``, ``user_group``, ``args`` (optional)</span>
<span class="sd">        and ``kwargs`` (optional).</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        Reference to the RE Worker namespace.</span>
<span class="sd">    user_group_permissions: dict or None</span>
<span class="sd">        Dictionary that contains user group permissions. User permissions are not checked</span>
<span class="sd">        if ``None``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Function data: ``callable`` is a reference to a callable object in RE Worker namespace,</span>
<span class="sd">        ``args`` is list of args and ``kwargs`` is a dictionary of kwargs.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        Error while preparing the function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">func_info</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No function name is specified: </span><span class="si">{</span><span class="n">func_info</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;user_group&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">func_info</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No user group is specified in parameters for the function: </span><span class="si">{</span><span class="n">func_info</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">func_name</span> <span class="o">=</span> <span class="n">func_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">user_group</span> <span class="o">=</span> <span class="n">func_info</span><span class="p">[</span><span class="s2">&quot;user_group&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">user_group_permissions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_if_function_allowed</span><span class="p">(</span>
            <span class="n">func_name</span><span class="p">,</span> <span class="n">group_name</span><span class="o">=</span><span class="n">user_group</span><span class="p">,</span> <span class="n">user_group_permissions</span><span class="o">=</span><span class="n">user_group_permissions</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">func_name</span><span class="si">!r}</span><span class="s2"> is not allowed for users from </span><span class="si">{</span><span class="n">user_group</span><span class="si">!r}</span><span class="s2"> user group&quot;</span><span class="p">)</span>

    <span class="n">func_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">func_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">func_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">if</span> <span class="n">func_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nspace</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">func_name</span><span class="si">!r}</span><span class="s2"> is not found in the worker namespace&quot;</span><span class="p">)</span>

    <span class="n">func_callable</span> <span class="o">=</span> <span class="n">nspace</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span>

    <span class="c1"># Following are basic checks to avoid most common errors. The list of check can be expanded.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">func_callable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object </span><span class="si">{</span><span class="n">func_name</span><span class="si">!r}</span><span class="s2"> defined in worker namespace is not callable&quot;</span><span class="p">)</span>
    <span class="c1"># Generator functions defined in the worker namespace are plans, which return generators</span>
    <span class="c1">#   when called. There is no point in calling those functions directly.</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">func_callable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object </span><span class="si">{</span><span class="n">func_name</span><span class="si">!r}</span><span class="s2"> defined in worker namespace is a generator function&quot;</span><span class="p">)</span>

    <span class="n">func_prepared</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;callable&quot;</span><span class="p">:</span> <span class="n">func_callable</span><span class="p">,</span>
        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">func_args</span><span class="p">,</span>
        <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="n">func_kwargs</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">func_prepared</span>


<span class="c1"># ===============================================================================</span>
<span class="c1">#   Validation of plan parameters</span>


<span class="k">def</span> <span class="nf">_convert_str_to_number</span><span class="p">(</span><span class="n">value_in</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpret a string ``value_in`` as ``int`` or ``float`` (whichever is sufficient).</span>
<span class="sd">    Raise the exception if conversion fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try to convert string value to float</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_in</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value_out</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_in</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value &#39;</span><span class="si">{</span><span class="n">value_in</span><span class="si">}</span><span class="s2">&#39; is not a string (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value_in</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_out</span><span class="p">)</span> <span class="o">==</span> <span class="n">value_out</span><span class="p">:</span>
            <span class="n">value_out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_out</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to interpret the value </span><span class="si">{</span><span class="n">value_in</span><span class="si">!r}</span><span class="s2"> as integer or float number: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value_out</span>


<span class="k">def</span> <span class="nf">_compare_types</span><span class="p">(</span><span class="n">object_in</span><span class="p">,</span> <span class="n">object_out</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares types of parameters. If both parameters are iterables (list or tuple),</span>
<span class="sd">    then the function is recursively called for each element. A set of rules is</span>
<span class="sd">    applied to types to determine if the types are matching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_in</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_out</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_in</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_out</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">o_in</span><span class="p">,</span> <span class="n">o_out</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">object_in</span><span class="p">,</span> <span class="n">object_out</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_compare_types</span><span class="p">(</span><span class="n">o_in</span><span class="p">,</span> <span class="n">o_out</span><span class="p">):</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This should never happen, since &#39;object_out&#39; is obtained by</span>
            <span class="c1">#   applying transformations on &#39;object_in&#39;, but it is still</span>
            <span class="c1">#   good to check to avoid exceptions.</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># This is the set of rules used to determine if types are matching.</span>
        <span class="c1">#   Types are required to be identical, except in the following cases:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_out</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">object_in</span><span class="p">)):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># &#39;int&#39; is allowed to be converted to float</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_out</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_in</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Conversion to Enum is valid (parameters often contain values, that are converted to Enums).</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">object_out</span><span class="p">),</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">)</span> <span class="ow">and</span> <span class="n">object_in</span> <span class="o">==</span> <span class="n">object_out</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">match</span>


<span class="k">def</span> <span class="nf">_compare_in_out</span><span class="p">(</span><span class="n">kwargs_in</span><span class="p">,</span> <span class="n">kwargs_out</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares input and output kwargs for ``pydantic`` model. Accumulates and returns</span>
<span class="sd">    the error message that includes the data on all parameters with mismatching types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">match</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs_out</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs_in</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">_compare_types</span><span class="p">(</span><span class="n">kwargs_in</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="n">msg</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Incorrect parameter type: key=&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;value=&#39;</span><span class="si">{</span><span class="n">kwargs_in</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">kwargs_in</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="si">}</span><span class="s2">), &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;interpreted as &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">match</span><span class="p">,</span> <span class="n">msg</span>


<span class="k">def</span> <span class="nf">_check_ranges</span><span class="p">(</span><span class="n">kwargs_in</span><span class="p">,</span> <span class="n">param_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if each parameter in ``kwargs_in`` is within the range limited by</span>
<span class="sd">    the minimum and maximum values if the range is specified in plan parameter</span>
<span class="sd">    descriptions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">process_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">):</span>
        <span class="c1"># Recursively process lists (iterables) and dictionaries.</span>
        <span class="c1"># Raises the exception if any found number is out of range.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="n">out_of_range</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">v_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="n">v_min</span><span class="p">):</span>
                <span class="n">out_of_range</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">v_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">v_max</span><span class="p">):</span>
                <span class="n">out_of_range</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">out_of_range</span><span class="p">:</span>
                <span class="n">s_v_min</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v_min</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">v_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;-inf&quot;</span>
                <span class="n">s_v_max</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v_max</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">v_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;inf&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is out of range [</span><span class="si">{</span><span class="n">s_v_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">s_v_max</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">process_argument</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">process_argument</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>

    <span class="n">match</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">v_min</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">v_max</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Perform check only if the parameter value is passed to the plan and</span>
        <span class="c1">#   v_max or v_min is specified.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">kwargs_in</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">v_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v_min</span> <span class="o">=</span> <span class="n">_convert_str_to_number</span><span class="p">(</span><span class="n">v_min</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v_max</span> <span class="o">=</span> <span class="n">_convert_str_to_number</span><span class="p">(</span><span class="n">v_max</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">process_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="n">msg</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Parameter value is out of range: key=&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, &quot;</span> <span class="sa">f</span><span class="s2">&quot;value=&#39;</span><span class="si">{</span><span class="n">kwargs_in</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">match</span><span class="p">,</span> <span class="n">msg</span>


<span class="k">def</span> <span class="nf">_process_annotation</span><span class="p">(</span><span class="n">encoded_annotation</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process annotation encoded the same way as in the descriptions of existing plans.</span>
<span class="sd">    Returns reference to the annotation (type object) and the list temporary types</span>
<span class="sd">    that needs to be deleted once the processing (parameter validation) is complete.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    encoded_annotation : dict</span>
<span class="sd">        Dictionary that contains encoded annotation. The dictionary may contain the following</span>
<span class="sd">        keys: ``type`` - type represented as a string, ``devices`` - a dictionary that maps</span>
<span class="sd">        device types and lists of device names, ``plans`` - similar dictionary for plan types</span>
<span class="sd">        and ``enums`` - similar dictionary for simple enums (strings).</span>
<span class="sd">    ns : dict</span>
<span class="sd">        Namespace that is used to evaluate the annotations. Custom types with unique names</span>
<span class="sd">        may be added to the namesace by the function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>
<span class="sd">        Type reconstructed from annotation.</span>
<span class="sd">    dict</span>
<span class="sd">        Namespace dictionary with created types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Namespace that contains the types created in the process of processing the annotation</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s2">&quot;typing&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="n">typing</span><span class="p">})</span>
    <span class="k">if</span> <span class="s2">&quot;enum&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="n">enum</span><span class="p">})</span>
    <span class="k">if</span> <span class="s2">&quot;NoneType&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;NoneType&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)})</span>

    <span class="n">annotation_type_str</span> <span class="o">=</span> <span class="s2">&quot;&lt;not-specified&gt;&quot;</span>
    <span class="n">annotation_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">encoded_annotation</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Type is not specififed&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that the annotation does not have any unsupported keys</span>
        <span class="n">allowed_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="s2">&quot;enums&quot;</span><span class="p">)</span>
        <span class="n">invalid_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">encoded_annotation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
                <span class="n">invalid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invalid_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Annotation contains unsupported keys: </span><span class="si">{</span><span class="n">invalid_keys</span><span class="si">}</span><span class="s2">. Supported keys: </span><span class="si">{</span><span class="n">allowed_keys</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">annotation_type_str</span> <span class="o">=</span> <span class="n">encoded_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>  <span class="c1"># Required!</span>
        <span class="n">devices</span> <span class="o">=</span> <span class="n">encoded_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">plans</span> <span class="o">=</span> <span class="n">encoded_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">enums</span> <span class="o">=</span> <span class="n">encoded_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enums&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">devices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">items</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plans</span><span class="p">)</span>
        <span class="n">items</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">enums</span><span class="p">)</span>

        <span class="c1"># Create types</span>
        <span class="k">for</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="c1"># The dictionary value for the devices/plans may be a list(tuple) of items</span>
            <span class="c1">#   or None. If the value is None, then any device or plan will be accepted.</span>
            <span class="c1">#   The list of device or plan names will be used to construct enum.Enum</span>
            <span class="c1">#   type, which is used to verify if the name in args or kwargs matches</span>
            <span class="c1">#   one of the arguments.</span>
            <span class="k">if</span> <span class="n">items</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Create temporary unique type name</span>
                <span class="n">type_name</span> <span class="o">=</span> <span class="n">type_name_base</span> <span class="o">=</span> <span class="n">item_name</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># Try the original name first</span>
                    <span class="k">if</span> <span class="n">type_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">type_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">type_name_base</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span><span class="si">}</span><span class="s2">_&quot;</span>

                <span class="c1"># Replace all occurrences of the type nae in the custom annotation.</span>
                <span class="n">annotation_type_str</span> <span class="o">=</span> <span class="n">annotation_type_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>

                <span class="c1"># Create temporary type as a subclass of enum.Enum, e.g.</span>
                <span class="c1"># enum.Enum(&#39;Device&#39;, {&#39;det1&#39;: &#39;det1&#39;, &#39;det2&#39;: &#39;det2&#39;, &#39;det3&#39;: &#39;det3&#39;})</span>
                <span class="n">type_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;enum.Enum(&#39;</span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2">&#39;, </span><span class="se">{{</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="n">item_name</span><span class="p">]:</span>
                    <span class="n">type_code</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&#39;: &#39;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&#39;,&quot;</span>
                <span class="n">type_code</span> <span class="o">+=</span> <span class="s2">&quot;})&quot;</span>
                <span class="n">ns</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">type_code</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Accept any device or plan: any string will be accepted without</span>
                <span class="c1">#   verification.</span>
                <span class="n">annotation_type_str</span> <span class="o">=</span> <span class="n">annotation_type_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">)</span>

        <span class="c1"># Once all the types are created,  execute the code for annotation.</span>
        <span class="n">annotation_type</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">annotation_type_str</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process annotation &#39;</span><span class="si">{</span><span class="n">annotation_type_str</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">annotation_type</span><span class="p">,</span> <span class="n">ns</span>


<span class="k">def</span> <span class="nf">_process_default_value</span><span class="p">(</span><span class="n">encoded_default_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluates the default value represented as a string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    encoded_default_value : str</span>
<span class="sd">        Default value represented as a string (e.g. &quot;10&quot; or &quot;&#39;some-str&#39;&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    p_default</span>
<span class="sd">        Default value.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised if evaluation of the string containing the default value fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p_default</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">encoded_default_value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decode the default value &#39;</span><span class="si">{</span><span class="n">encoded_default_value</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_default</span>


<span class="k">def</span> <span class="nf">_decode_parameter_types_and_defaults</span><span class="p">(</span><span class="n">param_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode parameter types and default values by using string representations of</span>
<span class="sd">    types and defaults stored in list of available devices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters : list(dict)</span>
<span class="sd">        List of dictionaries that contains annotations and default values of parameters.</span>
<span class="sd">        Used keys of the dictionaries: ``annotation`` and ``default``. If ``annotation``</span>
<span class="sd">        key is missing, then the the type is set to ``typing.Any``. If ``default`` is</span>
<span class="sd">        missing, then the default value is set to ``inspect.Parameter.empty``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Mapping of parameter names to the dictionaries containing type (``type`` key)</span>
<span class="sd">        and default value (``default`` key).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">decoded_types_and_defaults</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;name&#39; key in the parameter description </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;annotation&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">p_type</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_process_annotation</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_type</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span>

        <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">p_default</span> <span class="o">=</span> <span class="n">_process_default_value</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_default</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>

        <span class="n">decoded_types_and_defaults</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">p_type</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">p_default</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">decoded_types_and_defaults</span>


<span class="k">def</span> <span class="nf">construct_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">params_decoded</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct the list of ``inspect.Parameter`` parameters based on the parameter list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param_list : list(dict)</span>
<span class="sd">        List of item (plan) parameters as it is stored in the list of existing plans.</span>
<span class="sd">        Used keys of each parameter dictionary: ``name``, ``kind``, ``default``,</span>
<span class="sd">        ``annotation``.</span>
<span class="sd">    params_decoded : dict or None</span>
<span class="sd">        Dictionary that maps parameter name to the decoded parameter type</span>
<span class="sd">        and default value. The dictionary is created by calling</span>
<span class="sd">        ``_decode_parameter_types_and_defaults()``.  If the value is ``None``,</span>
<span class="sd">        then the decoded parameters are created automatically from the list ``param_list``.</span>
<span class="sd">        The parameter is intended for cases when the instantiated values are used repeatedly</span>
<span class="sd">        to avoid unnecessary multiple calls to ``_decode_parameter_types_and_defaults()``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    parameters : inspect.Parameters</span>
<span class="sd">        Item (plan) parameters represented in the form accepted by ``inspect.Signature``:</span>
<span class="sd">        ``sig=inspect.Signature(parameters)``.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exceptions with meaningful error messages are generated if parameters can not be</span>
<span class="sd">    instantiated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">params_decoded</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params_decoded</span> <span class="o">=</span> <span class="n">_decode_parameter_types_and_defaults</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
            <span class="n">p_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">p_kind</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kind&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">p_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Description for parameter contains no key &#39;name&#39;: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_kind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Description for parameter contains no key &#39;kind&#39;: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># The following values are ALWAYS created by &#39;_instantiate_parameter_types_and_defaults&#39;</span>
            <span class="n">p_type</span> <span class="o">=</span> <span class="n">params_decoded</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="n">p_default</span> <span class="o">=</span> <span class="n">params_decoded</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>

            <span class="n">param</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">p_name</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">p_kind</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">p_default</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">p_type</span><span class="p">)</span>
            <span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to construct &#39;inspect.Parameters&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parameters</span>


<span class="k">def</span> <span class="nf">pydantic_construct_model_class</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct the &#39;pydantic&#39; model based on parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters : inspect.Parameters</span>
<span class="sd">        Parameters of the plan with annotations created by ``_create_parameters`` function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    class</span>
<span class="sd">        Dynamically created Pydantic model class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="o">...</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;annotation&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">annotation</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_kwargs</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_kwargs</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="s2">&quot;Model&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pydantic_validate_model</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">pydantic_model_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the function parameters using &#39;pydantic&#39; model based</span>
<span class="sd">    (by instantiating the model using model class and bound model parameters).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kwargs: dict</span>
<span class="sd">        Bound parameters of the function call.</span>
<span class="sd">    pydantic_model_class : class</span>
<span class="sd">        Pydantic model class (created using ``pydantic_construct_model_class()``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    class</span>
<span class="sd">        Constructed Pydantic model class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Verify the arguments by instantiating the &#39;pydantic&#39; model</span>
    <span class="k">return</span> <span class="n">pydantic_model_class</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_validate_plan_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">call_args</span><span class="p">,</span> <span class="n">call_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate plan parameters based on parameter annotations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param_list: dict</span>
<span class="sd">        The list of parameters with annotations (including custom annotations if available).</span>
<span class="sd">    call_args: list</span>
<span class="sd">        &#39;args&#39; of the plan</span>
<span class="sd">    call_kwargs: dict</span>
<span class="sd">        &#39;kwargs&#39; of the plan</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Bound arguments of the called plan.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        Exception is raised if the plan is invalid. The exception message contains</span>
<span class="sd">        information on the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Reconstruct &#39;inspect.Parameter&#39; parameters based on the parameter list</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">construct_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>

        <span class="c1"># Create signature based on the list of parameters</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

        <span class="c1"># Verify the list of parameters based on signature.</span>
        <span class="n">bound_args</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">call_args</span><span class="p">,</span> <span class="o">**</span><span class="n">call_kwargs</span><span class="p">)</span>

        <span class="n">pydantic_model_class</span> <span class="o">=</span> <span class="n">pydantic_construct_model_class</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">pydantic_validate_model</span><span class="p">(</span><span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">pydantic_model_class</span><span class="p">)</span>

        <span class="c1"># The next step: match types of the output value of the pydantic model with input</span>
        <span class="c1">#   types. &#39;Pydantic&#39; is converting types whenever possible, but we need precise</span>
        <span class="c1">#   type checking with a fiew exceptions</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">_compare_in_out</span><span class="p">(</span><span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in argument types: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Finally check the ranges of parameters that have min. and max. are defined</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">_check_ranges</span><span class="p">(</span><span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">param_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Argument values are out of range: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="k">return</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span>


<span class="k">def</span> <span class="nf">filter_plan_description</span><span class="p">(</span><span class="n">plan_description</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter plan description from the list of existing plans (modify parameters</span>
<span class="sd">    ``plan[&quot;annotation&quot;][&quot;plans&quot;]`` and ``plan[&quot;annotation&quot;][&quot;devices&quot;]``)</span>
<span class="sd">    to include only plans and devices from the lists of allowed plans and allowed devices</span>
<span class="sd">    for the given group. Creates and returns a modified copy of the plan.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan_description: dict</span>
<span class="sd">        The dictionary containing plan description from the list of existing plans</span>
<span class="sd">    allowed_plans: dict or None</span>
<span class="sd">        The dictionary with allowed plans: key - plan name. If None, then</span>
<span class="sd">        all plans are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        plans are allowed.</span>
<span class="sd">    allowed_devices: dict or None</span>
<span class="sd">        The dictionary with allowed devices: key - device name. If None, then</span>
<span class="sd">        all devices are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        devices are allowed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The dictionary with modified plan description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plan_description</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">plan_description</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">plan_description</span><span class="p">:</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="n">plan_description</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span>

        <span class="c1"># Filter &#39;devices&#39; and &#39;plans&#39; entries of &#39;param_list&#39;. Leave only plans that are</span>
        <span class="c1">#   in &#39;allowed_plans&#39; and devices that are in &#39;allowed_devices&#39;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;annotation&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">allowed_plans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;plans&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]):</span>
                    <span class="n">p_plans</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">][</span><span class="s2">&quot;plans&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">p_type</span> <span class="ow">in</span> <span class="n">p_plans</span><span class="p">:</span>
                        <span class="n">p_plans</span><span class="p">[</span><span class="n">p_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">p_plans</span><span class="p">[</span><span class="n">p_type</span><span class="p">]</span> <span class="k">if</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">allowed_plans</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">allowed_devices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;devices&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]):</span>
                    <span class="n">p_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">][</span><span class="s2">&quot;devices&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">p_type</span> <span class="ow">in</span> <span class="n">p_dev</span><span class="p">:</span>
                        <span class="n">p_dev</span><span class="p">[</span><span class="n">p_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">p_dev</span><span class="p">[</span><span class="n">p_type</span><span class="p">]</span> <span class="k">if</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">allowed_devices</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plan_description</span>


<span class="k">def</span> <span class="nf">_filter_allowed_plans</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply ``filter_plan_description`` to each plan in the list of allowed plans so that</span>
<span class="sd">    only the allowed plans and devices are left in the enums for ``plans`` and ``devices``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    allowed_plans: dict or None</span>
<span class="sd">        The dictionary with allowed plans: key - plan name. If None, then</span>
<span class="sd">        all plans are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        plans are allowed.</span>
<span class="sd">    allowed_devices: dict or None</span>
<span class="sd">        The dictionary with allowed devices: key - device name. If None, then</span>
<span class="sd">        all devices are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        devices are allowed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">       The modified copy of ``allowed_plans``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">filter_plan_description</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="o">=</span><span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="o">=</span><span class="n">allowed_devices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">allowed_plans</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>


<div class="viewcode-block" id="validate_plan"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.validate_plan.html#bluesky_queueserver.validate_plan">[docs]</a><span class="k">def</span> <span class="nf">validate_plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the dictionary of plan parameters. The function is called before the plan</span>
<span class="sd">    is added to the queue. The function can also be called by the client application</span>
<span class="sd">    to validate a plan before it is submitted to the queue. The dictionaries</span>
<span class="sd">    ``allowed_plans`` and ``allowed_devices`` must contain plans and devices</span>
<span class="sd">    that are allowed for the user and can be downloaded from the server.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan: dict</span>
<span class="sd">        The dictionary of plan parameters</span>
<span class="sd">    allowed_plans: dict or None</span>
<span class="sd">        The dictionary with allowed plans: key - plan name. If None, then</span>
<span class="sd">        all plans are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        plans are allowed.</span>
<span class="sd">    allowed_devices: dict or None</span>
<span class="sd">        The dictionary with allowed devices: key - device name. If None, then</span>
<span class="sd">        all devices are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        devices are allowed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        Indicates if validation was successful (``True``) or failed (``False``).</span>
<span class="sd">    str</span>
<span class="sd">        Error message that explains the reason for validation failure. Empty string</span>
<span class="sd">        if validation is successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># If there is no list of allowed plans (it is None), then consider the plan valid.</span>
        <span class="k">if</span> <span class="n">allowed_plans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Verify that plan name is in the list of allowed plans</span>
            <span class="n">plan_name</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">plan_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_plans</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Plan &#39;</span><span class="si">{</span><span class="n">plan</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; is not in the list of allowed plans.&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">plan_description</span> <span class="o">=</span> <span class="n">allowed_plans</span><span class="p">[</span><span class="n">plan_name</span><span class="p">]</span>
            <span class="c1"># Plan description should contain only allowed plans and devices as parameters at</span>
            <span class="c1">#   this point. But run the filtering again just in case.</span>
            <span class="n">plan_description</span> <span class="o">=</span> <span class="n">filter_plan_description</span><span class="p">(</span>
                <span class="n">plan_description</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="o">=</span><span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="o">=</span><span class="n">allowed_devices</span>
            <span class="p">)</span>
            <span class="n">param_list</span> <span class="o">=</span> <span class="n">plan_description</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span>

            <span class="n">call_args</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">call_kwargs</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="n">_validate_plan_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="o">=</span><span class="n">param_list</span><span class="p">,</span> <span class="n">call_args</span><span class="o">=</span><span class="n">call_args</span><span class="p">,</span> <span class="n">call_kwargs</span><span class="o">=</span><span class="n">call_kwargs</span><span class="p">)</span>

        <span class="c1"># Check if supplied plan metadata is a dictionary or a list of dictionaries.</span>
        <span class="k">if</span> <span class="s2">&quot;meta&quot;</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">:</span>
            <span class="n">meta_msg</span> <span class="o">=</span> <span class="s2">&quot;Plan parameter &#39;meta&#39; must be a dictionary or a list of dictionaries&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">meta_msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">meta_msg</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Plan validation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Plan: </span><span class="si">{</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">msg</span></div>


<span class="k">def</span> <span class="nf">bind_plan_arguments</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">plan_args</span><span class="p">,</span> <span class="n">plan_kwargs</span><span class="p">,</span> <span class="n">plan_parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bind plan arguments given as ``plan_args`` and ``plan_kwargs`` to plan parameters.</span>
<span class="sd">    The function contains shortened version of code executed in ``validate_plan`` function.</span>
<span class="sd">    The dictionary of bound arguments can be accessed as ``bound_args.arguments``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan_args : list</span>
<span class="sd">        A list containing plan args</span>
<span class="sd">    plan_kwargs : dict</span>
<span class="sd">        A dictionary containing plan kwargs</span>
<span class="sd">    plan_parameters : dict</span>
<span class="sd">        A dictionary containing description of plan signature. The dictionary is the entry</span>
<span class="sd">        of ``allowed_plans`` dictionary (e.g. ``allowed_plans[&#39;count&#39;]``)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bound_args : inspect.BoundArgument</span>
<span class="sd">        Bound arguments of the plan.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        Arguments could not be bound to plan parameters (raised by ``inspect.Signature.bind``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">param_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">plan_parameters</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">construct_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>
    <span class="c1"># Create signature based on the list of parameters</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
    <span class="c1"># Verify the list of parameters based on signature.</span>
    <span class="n">bound_args</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">plan_args</span><span class="p">,</span> <span class="o">**</span><span class="n">plan_kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bound_args</span>


<span class="k">def</span> <span class="nf">_parse_docstring</span><span class="p">(</span><span class="n">docstring</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse docstring of a function using ``numpydoc``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    docstring: str or None</span>
<span class="sd">        Docstring to be parsed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary that contains the extracted data. Returns ``{}`` if ``docstring`` is ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">doc_annotation</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">docstring</span><span class="p">:</span>

        <span class="c1"># Make sure that the first line of the docstring is properly indented, otherwise it is</span>
        <span class="c1">#   incorrectly parsed by &#39;numpydoc&#39; (new line is optional).</span>
        <span class="c1"># Find the minimum</span>
        <span class="n">ds_split</span> <span class="o">=</span> <span class="n">docstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ds_split</span> <span class="o">=</span> <span class="n">ds_split</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># Ignore the first line</span>
        <span class="n">n_indent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ds_split</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>  <span class="c1"># Don&#39;t process empty strings (that contain only spaces)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">n_indent</span> <span class="o">=</span> <span class="n">n</span> <span class="k">if</span> <span class="n">n_indent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n_indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_indent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">docstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">n_indent</span> <span class="o">+</span> <span class="n">docstring</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="n">NumpyDocString</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;Summary&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
            <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;Parameters&quot;</span><span class="p">]</span>
        <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">desc</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="c1"># Remove &#39;*&#39; (should not be part of the name, but used in some plan annotations)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">params_to_str</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Assembles return type info into one string. This joins the description</span>
<span class="sd">            of return parameters into one string.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; : &quot;</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">desc</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">desc</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">desc</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">_</span> <span class="k">if</span> <span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="n">p_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p_list</span><span class="p">)</span>

        <span class="n">returns</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;Returns&quot;</span><span class="p">]</span>
        <span class="n">yields</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;Yields&quot;</span><span class="p">]</span>
        <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;returns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">p_str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">yields</span><span class="p">:</span>
            <span class="n">p_str</span> <span class="o">=</span> <span class="n">params_to_str</span><span class="p">(</span><span class="n">yields</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">returns</span><span class="p">:</span>
            <span class="n">p_str</span> <span class="o">=</span> <span class="n">params_to_str</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p_str</span><span class="p">:</span>
            <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;returns&quot;</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_str</span>

    <span class="k">return</span> <span class="n">doc_annotation</span>


<span class="k">def</span> <span class="nf">_process_plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns parameters of a plan. The function accepts callable object that implements the plan</span>
<span class="sd">    and returns the dictionary with descriptions of the plan and plan parameters. The function</span>
<span class="sd">    extracts the parameters and their annotations from the plan signature and plan and parameter</span>
<span class="sd">    descriptions from the docstring. If the plan is decorated with``parameter_annotation_decorator``,</span>
<span class="sd">    then the specifications of plan and parameter descriptions and parameter annotations passed</span>
<span class="sd">    to the decorator override the descriptions from the docstring and Python parameter annotations</span>
<span class="sd">    from the function header.</span>

<span class="sd">    Limitation on the support types of the plan parameters and the default values that could be</span>
<span class="sd">    used in function signatures. Parameter types must be native Python types (such as ``int``,</span>
<span class="sd">    ``float``, ``str``, etc.) or generic types based on Python native types</span>
<span class="sd">    (``typing.List[typing.Union[int, str]]``). The operation of recreating the type from its</span>
<span class="sd">    string representation using ``eval`` and the namespace with imported ``typing`` module</span>
<span class="sd">    and ``NoneType`` type should be successful. The default values are reconstructed using</span>
<span class="sd">    ``ast.literal_eval`` and the operation ``ast.literal_eval(f&quot;{v!r}&quot;)`` must run successfully.</span>

<span class="sd">    The description of the plan is represented as a Python dictionary in the following format</span>
<span class="sd">    (all elements are optional unless they are labeled as REQUIRED):</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        {</span>
<span class="sd">            &quot;name&quot;: &lt;plan name&gt;  # REQUIRED</span>
<span class="sd">            &quot;module&quot;: &lt;module name&gt;  # whenever available</span>
<span class="sd">            &quot;description&quot;: &lt;plan description (multiline text)&gt;</span>
<span class="sd">            &quot;properties&quot;: {  # REQUIRED, may be empty</span>
<span class="sd">                &quot;is_generator&quot;: &lt;boolean that indicates if this is a generator function&gt;</span>
<span class="sd">            }</span>
<span class="sd">            &quot;parameters&quot;: [  # REQUIRED, may be empty</span>
<span class="sd">                &lt;param_name_1&gt;: {</span>
<span class="sd">                     &quot;name&quot;: &lt;parameter name&gt;  # REQUIRED</span>
<span class="sd">                     &quot;description&quot;: &lt;parameter description&gt;</span>
<span class="sd">                     # For values of the &#39;kind&#39; see documentation for &#39;inspect.Parameter&#39;</span>
<span class="sd">                     &quot;kind&quot;: {  # REQUIRED</span>
<span class="sd">                         &quot;name&quot;: &lt;string representation&gt;</span>
<span class="sd">                         &quot;value&quot;: &lt;integer representation&gt;</span>
<span class="sd">                     }</span>
<span class="sd">                     &quot;annotation&quot;: {</span>
<span class="sd">                         # &#39;type&#39; is REQUIRED if annotation is present</span>
<span class="sd">                         &quot;type&quot;: &lt;parameter type represented as a string&gt;</span>
<span class="sd">                         # Enums for devices, plans and simple enums are in the same format as</span>
<span class="sd">                         #   the &#39;parameter_annotation_decorator&#39;.</span>
<span class="sd">                         &quot;devices&quot;: &lt;dict of device types (lists of device names)&gt;</span>
<span class="sd">                         &quot;plans&quot;: &lt;dict of plan types (lists of plan names)&gt;</span>
<span class="sd">                         &quot;enums&quot;: &lt;dict of enum types (lists of strings)&gt;</span>
<span class="sd">                     }</span>
<span class="sd">                     &quot;default&quot;: &lt;string representation of the default value&gt;</span>
<span class="sd">                     &quot;default_defined_in_decorator&quot;: boolean  # True if the default value is defined</span>
<span class="sd">                                                              # in decorator, otherwise False/not set</span>
<span class="sd">                     &quot;min&quot;: &lt;string representing int or float&gt;</span>
<span class="sd">                     &quot;max&quot;: &lt;string representing int or float&gt;</span>
<span class="sd">                     &quot;step&quot;: &lt;string representing int or float&gt;</span>
<span class="sd">                }</span>
<span class="sd">                &lt;parameter_name_2&gt;: ...</span>
<span class="sd">                &lt;parameter_name_3&gt;: ...</span>
<span class="sd">                ...</span>
<span class="sd">            ]</span>
<span class="sd">        }</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan: callable</span>
<span class="sd">        Reference to the function implementing the plan</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        Prepared dictionary of existing devices (returned by the function ``_prepare_devices``.</span>
<span class="sd">        The dictionary is used to create lists of devices for built-in custom types</span>
<span class="sd">        ``AllDetectors``, ``AllMotors``, ``AllFlyers``. If it is known that built-in plans</span>
<span class="sd">        are not used, then empty dictionary can be passed instead of the list of existing devices.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with plan parameters.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Error occurred while creating plan description.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">convert_annotation_to_string</span><span class="p">(</span><span class="n">annotation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ignore the type if it can not be properly reconstructed using &#39;eval&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="n">typing</span><span class="p">,</span> <span class="s2">&quot;NoneType&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)}</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
            <span class="c1"># This should take care of the Python base types such as &#39;int&#39;, &#39;float&#39; etc.</span>
            <span class="n">a_str</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This will work for generic types like &#39;typing.List[int]&#39;</span>
            <span class="n">a_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation</span><span class="si">!r}</span><span class="s2">&quot;</span>

        <span class="c1"># Verify if the type could be recreated by evaluating the string during validation.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">an</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">a_str</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">an</span> <span class="o">!=</span> <span class="n">annotation</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Ignore the type if it can not be recreated.</span>
            <span class="n">a_str</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">a_str</span>

    <span class="k">def</span> <span class="nf">convert_expression_to_string</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expression_role</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise &#39;ValueError&#39; if the string representation of the value can not be evaluated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">role_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; of </span><span class="si">{</span><span class="n">expression_role</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">expression_role</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="n">s_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">s_value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If default value can not be accepted, then the plan is considered invalid.</span>
            <span class="c1">#    Processing should be interrupted.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The expression (</span><span class="si">{</span><span class="n">s_value</span><span class="si">}</span><span class="s2">) can not be evaluated with &#39;ast.literal_eval()&#39;: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;unsupported type</span><span class="si">{</span><span class="n">role_str</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">s_value</span>

    <span class="k">def</span> <span class="nf">assemble_custom_annotation</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assemble annotation from decorator parameters. It will be stored as a separate dictionary.</span>
<span class="sd">        Returns ``None`` if there is no annotation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;annotation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parameter</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="s2">&quot;enums&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">parameter</span><span class="p">:</span>
                <span class="n">annotation</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">parameter</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="c1"># Add lists of device names for built-in types</span>
        <span class="n">built_in_types</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;AllDetectors&quot;</span><span class="p">,</span> <span class="s2">&quot;AllMotors&quot;</span><span class="p">,</span> <span class="s2">&quot;AllFlyers&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">btype</span> <span class="ow">in</span> <span class="n">built_in_types</span><span class="p">:</span>
            <span class="n">type_found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">nvchars</span> <span class="o">=</span> <span class="s2">&quot;[^_A-Za-z0-9]&quot;</span>
            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">nvchars</span><span class="p">),</span> <span class="p">(</span><span class="n">nvchars</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">nvchars</span><span class="p">,</span> <span class="n">nvchars</span><span class="p">)):</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start</span><span class="si">}{</span><span class="n">btype</span><span class="si">}{</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]):</span>
                    <span class="n">type_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">type_found</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;devices&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
                    <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;devices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># If annotation already contains type definition for &#39;built-in&#39; type</span>
                <span class="c1">#   then no name list is created.</span>
                <span class="k">if</span> <span class="n">btype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;devices&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;AllDetectors&quot;</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">_btype</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_readable&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_movable&quot;</span><span class="p">]</span>

                    <span class="k">elif</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;AllMotors&quot;</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">_btype</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_readable&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_movable&quot;</span><span class="p">]</span>

                    <span class="k">elif</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;AllFlyers&quot;</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">_btype</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_flyable&quot;</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in processing algorithm: unsupported built-in type &#39;</span><span class="si">{</span><span class="n">btype</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="n">device_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">existing_devices</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">condition</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>

                    <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;devices&quot;</span><span class="p">][</span><span class="n">btype</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_names</span>

        <span class="k">return</span> <span class="n">annotation</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
    <span class="n">docstring</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="s2">&quot;__doc__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">param_annotation</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="s2">&quot;_custom_parameter_annotation_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">doc_annotation</span> <span class="o">=</span> <span class="n">_parse_docstring</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">plan</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">module_name</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="vm">__module__</span>
    <span class="k">if</span> <span class="n">module_name</span> <span class="o">!=</span> <span class="s2">&quot;&lt;run_path&gt;&quot;</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">module_name</span><span class="p">})</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="c1"># Properties</span>
        <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;is_generator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgenerator</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>

        <span class="c1"># Plan description</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">param_annotation</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">desc</span> <span class="ow">and</span> <span class="n">doc_annotation</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">doc_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>

        <span class="c1"># Function parameters</span>
        <span class="n">use_docstring</span> <span class="o">=</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">doc_annotation</span>
        <span class="n">use_custom</span> <span class="o">=</span> <span class="n">param_annotation</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">param_annotation</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">working_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">working_dict</span><span class="p">)</span>

            <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>

            <span class="c1"># Parameter description (attempt to get it from the decorator, then from docstring)</span>
            <span class="n">desc</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">default_defined_in_decorator</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">use_custom</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]):</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">assemble_custom_annotation</span><span class="p">(</span>
                    <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">_</span>
                        <span class="k">if</span> <span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="n">convert_expression_to_string</span><span class="p">(</span>
                            <span class="n">_</span><span class="p">,</span>
                            <span class="n">expression_role</span><span class="o">=</span><span class="s2">&quot;default value in decorator&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">default</span><span class="p">:</span>
                        <span class="n">default_defined_in_decorator</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">_</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">_</span>
                        <span class="k">if</span> <span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="n">convert_expression_to_string</span><span class="p">(</span>
                            <span class="n">_</span><span class="p">,</span>
                            <span class="n">expression_role</span><span class="o">=</span><span class="s2">&quot;min value in decorator&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">_</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">_</span>
                        <span class="k">if</span> <span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="n">convert_expression_to_string</span><span class="p">(</span>
                            <span class="n">_</span><span class="p">,</span>
                            <span class="n">expression_role</span><span class="o">=</span><span class="s2">&quot;max value in decorator&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">_</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">_</span>
                        <span class="k">if</span> <span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="n">convert_expression_to_string</span><span class="p">(</span>
                            <span class="n">_</span><span class="p">,</span>
                            <span class="n">expression_role</span><span class="o">=</span><span class="s2">&quot;step value in decorator&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">desc</span> <span class="ow">and</span> <span class="n">use_docstring</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]):</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">annotation</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">convert_annotation_to_string</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
                    <span class="c1"># The case when annotation does exist (otherwise it is None)</span>
                    <span class="n">annotation</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">annotation</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># The default value in the decorator overrides the default value in the header,</span>
                <span class="c1">#   not replace it. Therefore the default value is required in the header if</span>
                <span class="c1">#   one is specified in the decorator.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing default value for the parameter &#39;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; in the plan signature: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;The default value </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> is specified in the annotation decorator, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;there for a default value is required in the plan header.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">default</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="n">convert_expression_to_string</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">expression_role</span><span class="o">=</span><span class="s2">&quot;default value&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
                <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>

            <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
                <span class="c1"># Verify that the encoded type could be decoded.</span>
                <span class="n">_process_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>  <span class="c1"># May raises exception</span>
                <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span>

            <span class="k">if</span> <span class="n">default</span><span class="p">:</span>
                <span class="c1"># Verify that the encoded representation of the default can be decoded.</span>
                <span class="n">_process_default_value</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>  <span class="c1"># May raises exception</span>
                <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>
                <span class="k">if</span> <span class="n">default_defined_in_decorator</span><span class="p">:</span>
                    <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;default_defined_in_decorator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># &#39;min&#39;, &#39;max&#39; and &#39;step&#39; (may exist only in decorator)</span>
            <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Attempt to convert to number (use the same function as during validation)</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">_convert_str_to_number</span><span class="p">(</span><span class="n">vmin</span><span class="p">)</span>
                    <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vmin</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># Save as a string</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process min. value: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">_convert_str_to_number</span><span class="p">(</span><span class="n">vmax</span><span class="p">)</span>
                    <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vmax</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process max. value: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="n">_convert_str_to_number</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                    <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process step value: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create description of plan &#39;</span><span class="si">{</span><span class="n">plan</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">_prepare_plans</span><span class="p">(</span><span class="n">plans</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare dictionary of existing plans for saving to YAML file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plans : dict</span>
<span class="sd">        Dictionary of plans extracted from the workspace</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        Prepared dictionary of existing devices (returned by the function ``_prepare_devices``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary that maps plan names to plan descriptions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_process_plan</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">plans</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">def</span> <span class="nf">_prepare_devices</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare dictionary of existing devices for saving to YAML file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">protocols</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">bluesky_queueserver.manager._protocols</span> <span class="k">as</span> <span class="nn">protocols</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;is_readable&quot;</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">protocols</span><span class="o">.</span><span class="n">Readable</span><span class="p">),</span>
            <span class="s2">&quot;is_movable&quot;</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">protocols</span><span class="o">.</span><span class="n">Movable</span><span class="p">),</span>
            <span class="s2">&quot;is_flyable&quot;</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">protocols</span><span class="o">.</span><span class="n">Flyable</span><span class="p">),</span>
            <span class="s2">&quot;classname&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">devices</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">existing_plans_and_devices_from_nspace</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">nspace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate lists of existing plans and devices from namespace. The namespace</span>
<span class="sd">    must be in the form returned by ``load_worker_startup_code()``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nspace : dict</span>
<span class="sd">        Namespace that contains plans and devices</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    existing_plans : dict</span>
<span class="sd">        Dictionary of descriptions of existing plans</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        Dictionary of descriptions of existing devices</span>
<span class="sd">    plans_in_nspace : dict</span>
<span class="sd">        Dictionary of plans in namespace</span>
<span class="sd">    devices_in_nspace : dict</span>
<span class="sd">        Dictionary of devices in namespace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plans_in_nspace</span> <span class="o">=</span> <span class="n">plans_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">)</span>
    <span class="n">devices_in_nspace</span> <span class="o">=</span> <span class="n">devices_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">)</span>

    <span class="n">existing_devices</span> <span class="o">=</span> <span class="n">_prepare_devices</span><span class="p">(</span><span class="n">devices_in_nspace</span><span class="p">)</span>
    <span class="n">existing_plans</span> <span class="o">=</span> <span class="n">_prepare_plans</span><span class="p">(</span><span class="n">plans_in_nspace</span><span class="p">,</span> <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">existing_plans</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">,</span> <span class="n">plans_in_nspace</span><span class="p">,</span> <span class="n">devices_in_nspace</span>


<span class="k">def</span> <span class="nf">save_existing_plans_and_devices</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">existing_plans</span><span class="p">,</span>
    <span class="n">existing_devices</span><span class="p">,</span>
    <span class="n">file_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save dictionaries of existing plans and devices to YAML file. The dictionaries of existing</span>
<span class="sd">    plans and devices must be in the form returned by ``existing_plans_and_devices_from_nspace``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    existing_plans : dict</span>
<span class="sd">        dictionary of existing plans (key - plan name, value - plan description)</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        dictionary of existing devices (key - device name, value - device description)</span>
<span class="sd">    startup_script_path : str or None</span>
<span class="sd">        name of the startup script</span>
<span class="sd">    file_dir : str or None</span>
<span class="sd">        path to the directory where the file is to be created. None - create file in current directory.</span>
<span class="sd">    file_name : str</span>
<span class="sd">        name of the output YAML file, None - default file name is used</span>
<span class="sd">    overwrite : boolean</span>
<span class="sd">        overwrite the file if it already exists</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">existing_plans_and_devices</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;existing_plans&quot;</span><span class="p">:</span> <span class="n">existing_plans</span><span class="p">,</span>
        <span class="s2">&quot;existing_devices&quot;</span><span class="p">:</span> <span class="n">existing_devices</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; already exists. File overwriting is disabled.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# This file is automatically generated. Edit at your own risk.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">existing_plans_and_devices</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gen_list_of_plans_and_devices</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">startup_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">startup_module_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">startup_script_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the list of plans and devices from a collection of startup files, python module or</span>
<span class="sd">    a script. Only one source of startup code should be specified, otherwise an exception will be</span>
<span class="sd">    raised.</span>

<span class="sd">    If ``file_name`` is specified, it is used as a name for the output file, otherwise</span>
<span class="sd">    the default file name ``existing_plans_and_devices.yaml`` is used. The file will be saved</span>
<span class="sd">    to ``file_dir`` or current directory if ``file_dir`` is not specified or ``None``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    startup_dir: str or None</span>
<span class="sd">        path to the directory that contains a collection of startup files (IPython-style)</span>
<span class="sd">    startup_module_name: str or None</span>
<span class="sd">        name of the startup module to load</span>
<span class="sd">    startup_script_path: str or None</span>
<span class="sd">        name of the startup script</span>
<span class="sd">    file_dir: str or None</span>
<span class="sd">        path to the directory where the file is to be created. None - create file in current directory.</span>
<span class="sd">    file_name: str</span>
<span class="sd">        name of the output YAML file, None - default file name is used</span>
<span class="sd">    overwrite: boolean</span>
<span class="sd">        overwrite the file if it already exists</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        Error occurred while creating or saving the lists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.profile_tools</span> <span class="kn">import</span> <span class="n">set_re_worker_active</span><span class="p">,</span> <span class="n">clear_re_worker_active</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="s2">&quot;existing_plans_and_devices.yaml&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">[</span><span class="n">startup_dir</span><span class="p">,</span> <span class="n">startup_module_name</span><span class="p">,</span> <span class="n">startup_script_path</span><span class="p">]])</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source of the startup code was not specified or multiple sources were specified.&quot;</span><span class="p">)</span>

        <span class="n">set_re_worker_active</span><span class="p">()</span>

        <span class="n">nspace</span> <span class="o">=</span> <span class="n">load_worker_startup_code</span><span class="p">(</span>
            <span class="n">startup_dir</span><span class="o">=</span><span class="n">startup_dir</span><span class="p">,</span>
            <span class="n">startup_module_name</span><span class="o">=</span><span class="n">startup_module_name</span><span class="p">,</span>
            <span class="n">startup_script_path</span><span class="o">=</span><span class="n">startup_script_path</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">existing_plans</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">existing_plans_and_devices_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="o">=</span><span class="n">nspace</span><span class="p">)</span>

        <span class="n">save_existing_plans_and_devices</span><span class="p">(</span>
            <span class="n">existing_plans</span><span class="o">=</span><span class="n">existing_plans</span><span class="p">,</span>
            <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span>
            <span class="n">file_dir</span><span class="o">=</span><span class="n">file_dir</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create the list of plans and devices: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">clear_re_worker_active</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">gen_list_of_plans_and_devices_cli</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &#39;qserver-list-plans-devices&#39;</span>
<span class="sd">    CLI tool for generating the list of existing plans and devices based on profile collection.</span>
<span class="sd">    The tool is supposed to be called as &#39;qserver-list-plans-devices&#39; from command line.</span>
<span class="sd">    The function will ALWAYS overwrite the existing list of plans and devices (the list</span>
<span class="sd">    is automatically generated, so overwriting (updating) should be a safe operation that doesn&#39;t</span>
<span class="sd">    lead to loss configuration data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;bluesky_queueserver&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">formatter</span><span class="p">(</span><span class="n">prog</span><span class="p">):</span>
        <span class="c1"># Set maximum width such that printed help mostly fits in the RTD theme code block (documentation).</span>
        <span class="k">return</span> <span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">max_help_position</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Bluesky-QServer:</span><span class="se">\n</span><span class="s2">CLI tool for generating the list of plans and devices &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;from beamline startup scripts.</span><span class="se">\n</span><span class="s2">bluesky-queueserver version </span><span class="si">{</span><span class="n">qserver_version</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">formatter</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--file-dir&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;file_dir&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory name where the list of plans and devices is saved. By default, the list is saved &quot;</span>
        <span class="s2">&quot;to the file &#39;existing_plans_and_devices.yaml&#39; in the current directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--file-name&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;file_name&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the file where the list of plans and devices is saved. Default file name: &quot;</span>
        <span class="s2">&quot;&#39;existing_plans_and_devices.yaml&#39;.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--startup-dir&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;startup_dir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to directory that contains a set of startup files (*.py and *.ipy). All the scripts &quot;</span>
        <span class="s2">&quot;in the directory will be sorted in alphabetical order of their names and loaded in &quot;</span>
        <span class="s2">&quot;the Run Engine Worker environment. The set of startup files may be located in any accessible &quot;</span>
        <span class="s2">&quot;directory. For example, &#39;qserver-list-plans-devices --startup-dir .&#39; loads startup &quot;</span>
        <span class="s2">&quot;files from the current directory and saves the lists to the file in current directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--startup-module&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;startup_module_name&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The name of the module that contains the startup code. The module must be installed &quot;</span>
        <span class="s2">&quot; in the current environment For example, &#39;qserver-list-plans-devices &quot;</span>
        <span class="s2">&quot;--startup-module some.startup.module&#39; loads startup code from the module &#39;some.startup.module&#39; &quot;</span>
        <span class="s2">&quot;and saves results to the file in the current directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--startup-script&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;startup_script_path&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path to the script with startup code. For example, &quot;</span>
        <span class="s2">&quot;&#39;qserver-list-plans-devices --startup-script ~/startup/scripts/script.py&#39; loads &quot;</span>
        <span class="s2">&quot;startup code from the script and saves the results to the file in the current directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">file_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file_dir</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file_name</span>
    <span class="n">startup_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">startup_dir</span>
    <span class="n">startup_module_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">startup_module_name</span>
    <span class="n">startup_script_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">startup_script_path</span>

    <span class="k">if</span> <span class="n">file_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">file_dir</span><span class="p">)</span>
        <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_dir</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">gen_list_of_plans_and_devices</span><span class="p">(</span>
            <span class="n">startup_dir</span><span class="o">=</span><span class="n">startup_dir</span><span class="p">,</span>
            <span class="n">startup_module_name</span><span class="o">=</span><span class="n">startup_module_name</span><span class="p">,</span>
            <span class="n">startup_script_path</span><span class="o">=</span><span class="n">startup_script_path</span><span class="p">,</span>
            <span class="n">file_dir</span><span class="o">=</span><span class="n">file_dir</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The list of existing plans and devices was created successfully.&quot;</span><span class="p">)</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to create the list of plans and devices: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">exit_code</span>


<span class="k">def</span> <span class="nf">load_existing_plans_and_devices</span><span class="p">(</span><span class="n">path_to_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the lists of allowed plans and devices from YAML file. Returns empty lists</span>
<span class="sd">    if `path_to_file` is None or &quot;&quot; or the file does not exist or corrupt.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_to_file: str on None</span>
<span class="sd">        Full path to .yaml file that contains the lists.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (dict, dict)</span>
<span class="sd">        List of allowed plans and list of allowed devices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;List of plans and devices is not loaded.&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path_to_file</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> File path is not specified.&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> File &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">existing_plans_and_devices</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> File &#39;</span><span class="si">%s</span><span class="s2">&#39; has invalid YAML: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="n">existing_plans_and_devices</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">existing_plans_and_devices</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> The file &#39;</span><span class="si">%s</span><span class="s2">&#39; has invalid format or empty.&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="n">existing_plans</span> <span class="o">=</span> <span class="n">existing_plans_and_devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;existing_plans&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">existing_devices</span> <span class="o">=</span> <span class="n">existing_plans_and_devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;existing_devices&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">return</span> <span class="n">existing_plans</span><span class="p">,</span> <span class="n">existing_devices</span>


<span class="k">def</span> <span class="nf">compare_existing_plans_and_devices</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">existing_plans</span><span class="p">,</span>
    <span class="n">existing_devices</span><span class="p">,</span>
    <span class="n">existing_plans_ref</span><span class="p">,</span>
    <span class="n">existing_devices_ref</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares the lists of existing plans and devices with the reference lists. Returns ``False``</span>
<span class="sd">    if the exception is raised while comparing the lists. (Consistent exception handling is</span>
<span class="sd">    the only reason we need this function.)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    existing_plans : dict</span>
<span class="sd">        The updated list (dictionary) of descriptions of the existing plans.</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        The updated list (dictionary) of descriptions of the existing devices.</span>
<span class="sd">    existing_plans_ref : dict or None</span>
<span class="sd">        The reference list (dictionary) of descriptions of the existing plans.</span>
<span class="sd">    existing_devices_ref : dict or None</span>
<span class="sd">        The reference list (dictionary) of descriptions of the existing devices.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        ``True`` - the lists are equal, ``False`` otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lists_equal</span> <span class="o">=</span> <span class="p">(</span><span class="n">existing_plans</span> <span class="o">==</span> <span class="n">existing_plans_ref</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">existing_devices</span> <span class="o">==</span> <span class="n">existing_devices_ref</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c1"># If the lists (dictionaries) of plans and devices can not be compared, then save the new lists.</span>
        <span class="c1">#   This issue should be investigated if it is repeated regularly.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to compare existing plans or existing devices: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="n">lists_equal</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">lists_equal</span>


<span class="k">def</span> <span class="nf">update_existing_plans_and_devices</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">path_to_file</span><span class="p">,</span>
    <span class="n">existing_plans</span><span class="p">,</span>
    <span class="n">existing_devices</span><span class="p">,</span>
    <span class="n">existing_plans_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">existing_devices_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">always_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the lists of existing plans and devices stored in the file ``path_to_file`` on disk if</span>
<span class="sd">    the lists are different from the reference lists. The reference lists can be passed to the function</span>
<span class="sd">    or loaded from the file if ``existing_plans_ref`` or ``existing_devices_ref`` are ``None``.</span>
<span class="sd">    If ``always_save`` is False, then the descriptions are updated only if the lists have changed,</span>
<span class="sd">    otherwise the lists are always saved. The function will never modified files in the directory</span>
<span class="sd">    with startup scripts, which is part of the repository or distributed package.</span>

<span class="sd">    This function never raises exceptions by design, since successful updating of stored lists of plans</span>
<span class="sd">    and devices is not considered critical for executing plans. If the function regularly generates</span>
<span class="sd">    warnings or error messages, the issue must be investigated.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Lists of plans are devices are represented as Python dictionaries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_to_file : str</span>
<span class="sd">        Path to file that contains the lists of existing plans and devices</span>
<span class="sd">    existing_plans : dict</span>
<span class="sd">        The updated list (dictionary) of descriptions of the existing plans.</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        The updated list (dictionary) of descriptions of the existing devices.</span>
<span class="sd">    existing_plans_ref : dict or None</span>
<span class="sd">        The reference list (dictionary) of descriptions of the existing plans.</span>
<span class="sd">    existing_devices_ref : dict or None</span>
<span class="sd">        The reference list (dictionary) of descriptions of the existing devices.</span>
<span class="sd">    always_save : boolean</span>
<span class="sd">        If ``False`` then save lists of plans and devices only if it is different</span>
<span class="sd">        from reference lists. Always save the lists to disk if ``True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        ``True`` if the lists of existing plans and devices is different from the reference</span>
<span class="sd">        lists or if ``always_save`` is ``True``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">always_save</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">existing_plans_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">existing_devices_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ep</span><span class="p">,</span> <span class="n">ed</span> <span class="o">=</span> <span class="n">load_existing_plans_and_devices</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_plans_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ep</span> <span class="o">=</span> <span class="n">existing_plans_ref</span>
        <span class="k">if</span> <span class="n">existing_devices_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="n">existing_devices_ref</span>

        <span class="n">changes_exist</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">compare_existing_plans_and_devices</span><span class="p">(</span>
            <span class="n">existing_plans</span><span class="o">=</span><span class="n">existing_plans</span><span class="p">,</span>
            <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span>
            <span class="n">existing_plans_ref</span><span class="o">=</span><span class="n">ep</span><span class="p">,</span>
            <span class="n">existing_devices_ref</span><span class="o">=</span><span class="n">ed</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">changes_exist</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">changes_exist</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating the list of existing plans and devices in the file &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">normalize_path</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Normalize path to make it easier to compare to other paths</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fpath</span><span class="p">)))</span>

        <span class="n">default_startup_dir</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">get_default_startup_dir</span><span class="p">())</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path_is_default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonpath</span><span class="p">([</span><span class="n">default_startup_dir</span><span class="p">,</span> <span class="n">file_path</span><span class="p">])</span> <span class="o">==</span> <span class="n">default_startup_dir</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">path_is_default</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">path_is_default</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;The file &#39;</span><span class="si">%s</span><span class="s2">&#39; is located in the directory, which is part of the package and can not be updated&quot;</span><span class="p">,</span>
                <span class="n">path_to_file</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Saving the updated plans and devices is not critical for real-time operation of the queue server.</span>
            <span class="c1">#   Plans can still be executed, so the error can be ignored, but it should be investigated, because</span>
            <span class="c1">#   some functionality may not be working properly.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">save_existing_plans_and_devices</span><span class="p">(</span>
                    <span class="n">existing_plans</span><span class="o">=</span><span class="n">existing_plans</span><span class="p">,</span>
                    <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span>
                    <span class="n">file_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">),</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">),</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to save lists of existing plans and device to file &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">changes_exist</span>


<span class="n">_user_group_permission_schema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">],</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;user_groups&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;allowed_plans&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;forbidden_plans&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;allowed_devices&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;forbidden_devices&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;allowed_functions&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;forbidden_functions&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_validate_user_group_permissions_schema</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate user group permissions schema. Raises exception if validation fails.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    user_group_permissions: dict</span>
<span class="sd">        A dictionary with user group permissions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jsonschema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">user_group_permissions</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">_user_group_permission_schema</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">validate_user_group_permissions</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the dictionary with user group permissions. Exception is raised errors are detected.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    user_group_permissions: dict</span>
<span class="sd">        The dictionary with user group permissions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User group permissions: Invalid type &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;, must be &#39;dict&#39;&quot;</span><span class="p">)</span>

    <span class="n">_validate_user_group_permissions_schema</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;root&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;User group permissions: Missing required user group: &#39;root&#39;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_user_group_permissions</span><span class="p">(</span><span class="n">path_to_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the data on allowed plans and devices for user groups. User group &#39;root&#39;</span>
<span class="sd">    is required. Exception is raised in user group &#39;root&#39; is missing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_to_file: str</span>
<span class="sd">        Full path to YAML file that contains user data permissions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Data structure with user permissions. Returns ``{}`` if path is an empty string</span>
<span class="sd">        or None.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        Error while reading the YAML file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path_to_file</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">path_to_file</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">user_group_permissions</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

        <span class="n">validate_user_group_permissions</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;root&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Missing required user group: &#39;root&#39;&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error while loading user group permissions from file &#39;</span><span class="si">{</span><span class="n">path_to_file</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">user_group_permissions</span>


<span class="k">def</span> <span class="nf">_check_if_item_allowed</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span> <span class="n">allow_patterns</span><span class="p">,</span> <span class="n">disallow_patterns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if an item with ``item_name`` is allowed based on ``allow_patterns``</span>
<span class="sd">    and ``disallow_patterns``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    item_name: str</span>
<span class="sd">        Name of the item.</span>
<span class="sd">    allow_patterns: list(str)</span>
<span class="sd">        Selected item should match at least one of the re patterns. If the value is ``[None]``</span>
<span class="sd">        then all items are selected. If ``[]``, then no items are selected.</span>
<span class="sd">    disallow_patterns: list(str)</span>
<span class="sd">        Items are deselected based on re patterns in the list: if an item matches at least one</span>
<span class="sd">        of the patterns, it is deselected. If the value is ``[None]`` or ``[]`` then no items</span>
<span class="sd">        are deselected.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        Indicates if the item is permitted based on ``allow_patterns`` and ``disallow_patterns``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">item_is_allowed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">allow_patterns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">allow_patterns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item_is_allowed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">allow_patterns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">item_name</span><span class="p">):</span>
                    <span class="n">item_is_allowed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

    <span class="k">if</span> <span class="n">item_is_allowed</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">disallow_patterns</span> <span class="ow">and</span> <span class="p">(</span><span class="n">disallow_patterns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">disallow_patterns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">item_name</span><span class="p">):</span>
                    <span class="n">item_is_allowed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>

    <span class="k">return</span> <span class="n">item_is_allowed</span>


<span class="k">def</span> <span class="nf">check_if_function_allowed</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">user_group_permissions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the function with name ``function_name`` is allowed for users of ``group_name`` group.</span>
<span class="sd">    The function first checks if the functio name passes root permissions and then permissions</span>
<span class="sd">    for the specific group.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    function_name: str</span>
<span class="sd">        Function name to check</span>
<span class="sd">    group_name: str</span>
<span class="sd">        User group name. Permissions must be defined for this group.</span>
<span class="sd">    user_group_permissions: dict or None</span>
<span class="sd">        Reference to a dictionary, which contains the defined user group permissions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        Indicates if the user that belong to ``user_group`` are allowed to run the function.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    KeyError</span>
<span class="sd">        ``user_group_permissions`` do not contain ``user_groups`` key or permissions for</span>
<span class="sd">        ``group_name`` group are not defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_group_permissions</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s2">&quot;user_groups&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_group_permissions</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;User group permissions dictionary does not contain &#39;user_groups&#39; key&quot;</span><span class="p">)</span>

    <span class="n">user_groups</span> <span class="o">=</span> <span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;root&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No permissions are defined for user group &#39;root&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No permissions are defined for user group </span><span class="si">{</span><span class="n">group_name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">root_allow_patterns</span> <span class="o">=</span> <span class="n">user_groups</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_functions&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">root_disallow_patterns</span> <span class="o">=</span> <span class="n">user_groups</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_functions&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">group_allow_patterns</span> <span class="o">=</span> <span class="n">user_groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_functions&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">group_disallow_patterns</span> <span class="o">=</span> <span class="n">user_groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_functions&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">return</span> <span class="n">_check_if_item_allowed</span><span class="p">(</span>
        <span class="n">function_name</span><span class="p">,</span>
        <span class="n">root_allow_patterns</span><span class="p">,</span>
        <span class="n">root_disallow_patterns</span><span class="p">,</span>
    <span class="p">)</span> <span class="ow">and</span> <span class="n">_check_if_item_allowed</span><span class="p">(</span>
        <span class="n">function_name</span><span class="p">,</span>
        <span class="n">group_allow_patterns</span><span class="p">,</span>
        <span class="n">group_disallow_patterns</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_select_allowed_items</span><span class="p">(</span><span class="n">item_dict</span><span class="p">,</span> <span class="n">allow_patterns</span><span class="p">,</span> <span class="n">disallow_patterns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the dictionary of items selected from `item_dict` such that item names</span>
<span class="sd">    satisfy re patterns in `allow_patterns` and not satisfy patterns in `disallow_patterns`.</span>
<span class="sd">    The function does not modify the dictionary, but creates a new dictionary with</span>
<span class="sd">    selected items, where item values are deep copies of the values of the original</span>
<span class="sd">    dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    item_dict: dict</span>
<span class="sd">        Dictionary of items.</span>
<span class="sd">    allow_patterns: list(str)</span>
<span class="sd">        Selected item should match at least one of the re patterns. If the value is ``[None]``</span>
<span class="sd">        then all items are selected. If ``[]``, then no items are selected.</span>
<span class="sd">    disallow_patterns: list(str)</span>
<span class="sd">        Items are deselected based on re patterns in the list: if an item matches at least one</span>
<span class="sd">        of the patterns, it is deselected. If the value is ``[None]`` or ``[]`` then no items</span>
<span class="sd">        are deselected.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary of the selected items.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">items_selected</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="n">item_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_check_if_item_allowed</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span> <span class="n">allow_patterns</span><span class="p">,</span> <span class="n">disallow_patterns</span><span class="p">):</span>
            <span class="n">items_selected</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item_dict</span><span class="p">[</span><span class="n">item_name</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">items_selected</span>


<span class="k">def</span> <span class="nf">load_allowed_plans_and_devices</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">path_existing_plans_and_devices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">path_user_group_permissions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">existing_plans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">existing_devices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">user_group_permissions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate dictionaries of allowed plans and devices for each user group. If there are no user</span>
<span class="sd">    groups defined (path is None), then output dictionaries will have one user group &#39;root&#39;</span>
<span class="sd">    with all existing plans and devices allowed. The function is using the lists (dict) of</span>
<span class="sd">    existing plans and devices passed as parameters. If the lists are not passed (or ``None``),</span>
<span class="sd">    then they are loaded from the file ``path_existing_plans_and_devices``.</span>
<span class="sd">    If the lists of plans and devices do not exist (path_existing_plans_and_devices is ``None``</span>
<span class="sd">    or points to non-existing file), then empty dictionaries are returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_existing_plans_and_devices: str or None</span>
<span class="sd">        Full path to YAML file, which contains dictionaries of existing plans and devices.</span>
<span class="sd">        Raises an exception if the file does not exist. If ``None`` or the file contains</span>
<span class="sd">        no plans and/or devices, then empty dictionaries of the allowed plans and devices</span>
<span class="sd">        are returned for all groups.</span>
<span class="sd">    path_user_group_permissions: str or None</span>
<span class="sd">        Full path to YAML file, which contains information on user group permissions.</span>
<span class="sd">        Exception is raised if the file does not exist. The path is ignored if</span>
<span class="sd">        ``user_group_permissions`` is set. If both ``path_user_group_permissions`` is ``None``</span>
<span class="sd">        and ``user_group_permissions`` is ``None`` or ``{}``, then dictionaries of allowed</span>
<span class="sd">        plans and devices will contain one group &#39;root&#39; with all existing devices and plans</span>
<span class="sd">        set as allowed.</span>
<span class="sd">    existing_plans: dict or None</span>
<span class="sd">        List (dict) of the existing plans. If ``None``, then the list is loaded from</span>
<span class="sd">        the file ``path_existing_plans_and_devices``.</span>
<span class="sd">    existing_devices: dict or None</span>
<span class="sd">        List (dict) of the existing devices. If ``None``, then the list is loaded from</span>
<span class="sd">        the file ``path_existing_plans_and_devices``.</span>
<span class="sd">    user_group_permissions: str or None</span>
<span class="sd">        Dictionary with user group permissions. If ``None``, then permissions are loaded</span>
<span class="sd">        from the file ``path_user_group_permissions``. If ``{}``, then dictionaries of allowed</span>
<span class="sd">        plans and devices will contain one group &#39;root&#39; with all existing devices and plans</span>
<span class="sd">        set as allowed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict, dict</span>
<span class="sd">        Dictionaries of allowed plans and devices. Dictionary keys are names of the user groups.</span>
<span class="sd">        Dictionaries are ``{}`` if no data on existing plans and devices is provided.</span>
<span class="sd">        Dictionaries contain one group (``root``) if no user perission data is provided.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user_group_permissions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user_group_permissions</span> <span class="o">=</span> <span class="n">load_user_group_permissions</span><span class="p">(</span><span class="n">path_user_group_permissions</span><span class="p">)</span>

        <span class="c1"># Data from the file is loaded only if ``existing_plans`` or ``existing_devices`` is ``None``.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">existing_plans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">existing_devices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ep</span><span class="p">,</span> <span class="n">ed</span> <span class="o">=</span> <span class="n">load_existing_plans_and_devices</span><span class="p">(</span><span class="n">path_existing_plans_and_devices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_plans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">existing_plans</span> <span class="o">=</span> <span class="n">ep</span>
        <span class="k">if</span> <span class="n">existing_devices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">existing_devices</span> <span class="o">=</span> <span class="n">ed</span>

        <span class="c1"># Detect some possible errors</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_group_permissions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No user permissions are specified&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;user_group_permissions&#39; has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead of &#39;dict&#39;&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;user_groups&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_group_permissions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No user groups are defined: &#39;user_groups&#39; keys is not in &#39;user_group_permissions&#39;&quot;</span><span class="p">)</span>

        <span class="n">user_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># First filter the plans and devices based on the permissions for &#39;root&#39; user group.</span>
        <span class="c1">#   The &#39;root&#39; user group permissions should be used to exclude all &#39;junk&#39;, i.e.</span>
        <span class="c1">#   unused/outdated/not functioning plans and devices collected from namespace, from</span>
        <span class="c1">#   the lists available to ALL the users.</span>
        <span class="n">plans_root</span><span class="p">,</span> <span class="n">devices_root</span> <span class="o">=</span> <span class="n">existing_plans</span><span class="p">,</span> <span class="n">existing_devices</span>
        <span class="k">if</span> <span class="s2">&quot;root&quot;</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">:</span>
            <span class="n">group_permissions_root</span> <span class="o">=</span> <span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">existing_devices</span><span class="p">:</span>
                <span class="n">devices_root</span> <span class="o">=</span> <span class="n">_select_allowed_items</span><span class="p">(</span>
                    <span class="n">existing_devices</span><span class="p">,</span>
                    <span class="n">group_permissions_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_devices&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="n">group_permissions_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_devices&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">existing_plans</span><span class="p">:</span>
                <span class="n">plans_root</span> <span class="o">=</span> <span class="n">_select_allowed_items</span><span class="p">(</span>
                    <span class="n">existing_plans</span><span class="p">,</span>
                    <span class="n">group_permissions_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_plans&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="n">group_permissions_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_plans&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="p">)</span>

        <span class="c1"># Now create lists of allowed devices and plans based on the lists for the &#39;root&#39; user group</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">:</span>
            <span class="n">selected_devices</span><span class="p">,</span> <span class="n">selected_plans</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
                <span class="n">selected_devices</span> <span class="o">=</span> <span class="n">devices_root</span>
                <span class="n">selected_plans</span> <span class="o">=</span> <span class="n">plans_root</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group_permissions</span> <span class="o">=</span> <span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">][</span><span class="n">group</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">existing_devices</span><span class="p">:</span>
                    <span class="n">selected_devices</span> <span class="o">=</span> <span class="n">_select_allowed_items</span><span class="p">(</span>
                        <span class="n">devices_root</span><span class="p">,</span>
                        <span class="n">group_permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_devices&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="n">group_permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_devices&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">existing_plans</span><span class="p">:</span>
                    <span class="n">selected_plans</span> <span class="o">=</span> <span class="n">_select_allowed_items</span><span class="p">(</span>
                        <span class="n">plans_root</span><span class="p">,</span>
                        <span class="n">group_permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_plans&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="n">group_permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_plans&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="p">)</span>

            <span class="n">selected_plans</span> <span class="o">=</span> <span class="n">_filter_allowed_plans</span><span class="p">(</span><span class="n">allowed_plans</span><span class="o">=</span><span class="n">selected_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="o">=</span><span class="n">selected_devices</span><span class="p">)</span>

            <span class="n">allowed_devices</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_devices</span>
            <span class="n">allowed_plans</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_plans</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error occurred while generating the list of allowed plans and devices: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="c1"># The &#39;default&#39; lists in case error occurred while generating lists</span>
        <span class="n">allowed_plans</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">existing_plans</span>
        <span class="n">allowed_devices</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">existing_devices</span>

    <span class="k">return</span> <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span>


<span class="k">def</span> <span class="nf">load_profile_collection_from_ipython</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load profile collection from IPython. Useful utility function that may be used to</span>
<span class="sd">    test if a profile collection can be loaded from IPython.</span>
<span class="sd">    Manually run this function from IPython:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from bluesky_queueserver.manager.profile_ops import load_profile_collection_from_ipython</span>
<span class="sd">        load_profile_collection_from_ipython()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>  <span class="c1"># noqa F821</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.py&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.ipy&quot;</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing &#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&#39; in TravisCI&quot;</span><span class="p">)</span>
        <span class="n">ip</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_exec_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Profile collection was loaded successfully.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="format_text_descriptions"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.format_text_descriptions.html#bluesky_queueserver.format_text_descriptions">[docs]</a><span class="k">def</span> <span class="nf">format_text_descriptions</span><span class="p">(</span><span class="n">item_parameters</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">use_html</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format parameter descriptions for a plan from the list of allowed plans.</span>
<span class="sd">    Returns description of the plan and each parameter represented as formatted strings</span>
<span class="sd">    containing plan name/description and parameter name/type/default/min/max/step/description.</span>
<span class="sd">    The text is prepared for presentation in user interfaces. The descriptions are</span>
<span class="sd">    represented as a dictionary:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        {</span>
<span class="sd">            &quot;description&quot;: &quot;Multiline formatted text description of the plan&quot;,</span>
<span class="sd">            &quot;parameters&quot;: {</span>
<span class="sd">                &quot;param_name1&quot;: &quot;Multiline formatted description&quot;,</span>
<span class="sd">                &quot;param_name2&quot;: &quot;Multiline formatted description&quot;,</span>
<span class="sd">                &quot;param_name3&quot;: &quot;Multiline formatted description&quot;,</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    item_parameters : dict</span>
<span class="sd">        A dictionary of item parameters, e.g. an element from the list of existing or allowed plans.</span>
<span class="sd">    use_html : boolean</span>
<span class="sd">        Select if the formatted text should be returned as plain text (default) or HTML.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The dictionary that contains formatted descriptions for the plan and its parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">item_parameters</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">start_bold</span> <span class="o">=</span> <span class="s2">&quot;&lt;b&gt;&quot;</span> <span class="k">if</span> <span class="n">use_html</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">stop_bold</span> <span class="o">=</span> <span class="s2">&quot;&lt;/b&gt;&quot;</span> <span class="k">if</span> <span class="n">use_html</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">start_it</span> <span class="o">=</span> <span class="s2">&quot;&lt;i&gt;&quot;</span> <span class="k">if</span> <span class="n">use_html</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">stop_it</span> <span class="o">=</span> <span class="s2">&quot;&lt;/i&gt;&quot;</span> <span class="k">if</span> <span class="n">use_html</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">new_line</span> <span class="o">=</span> <span class="s2">&quot;&lt;br&gt;&quot;</span> <span class="k">if</span> <span class="n">use_html</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">not_available</span> <span class="o">=</span> <span class="s2">&quot;Description is not available&quot;</span>

    <span class="n">descriptions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">item_name</span> <span class="o">=</span> <span class="n">item_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">item_description</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">item_description</span> <span class="o">=</span> <span class="n">item_description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Name:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">item_name</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">item_description</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_line</span><span class="si">}{</span><span class="n">item_description</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">descriptions</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="k">if</span> <span class="n">s</span> <span class="k">else</span> <span class="n">not_available</span>

    <span class="n">descriptions</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">item_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">p_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>

        <span class="n">p_type</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">p_custom_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;annotation&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="n">p_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="s2">&quot;enums&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
                        <span class="n">p_custom_types</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ct</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">ct</span><span class="p">])))</span>

        <span class="n">p_default</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>

        <span class="n">p_min</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">p_max</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">p_step</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">p_description</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">p_description</span> <span class="o">=</span> <span class="n">p_description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Name:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_name</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}{</span><span class="n">new_line</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Type:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_type</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}{</span><span class="n">new_line</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ct_items</span> <span class="ow">in</span> <span class="n">p_custom_types</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">ct</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ct_items</span><span class="si">}{</span><span class="n">new_line</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Default:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_default</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_line</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">insert_space</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">p_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Min:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_min</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">insert_space</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">p_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">insert_space</span><span class="p">:</span>
                    <span class="n">desc</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>
                <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Max:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_max</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">insert_space</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">p_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">insert_space</span><span class="p">:</span>
                    <span class="n">desc</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>
                <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Step:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_step</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">p_description</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_line</span><span class="si">}{</span><span class="n">p_description</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">descriptions</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span> <span class="k">if</span> <span class="n">desc</span> <span class="k">else</span> <span class="n">not_available</span>

    <span class="k">return</span> <span class="n">descriptions</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2021, Brookhaven National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>