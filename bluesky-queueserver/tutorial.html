<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basic Tutorials &mdash; bluesky-queueserver 0.post1+g64aa1f6 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Release History" href="release_history.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> bluesky-queueserver
          </a>
              <div class="version">
                0.post1+g64aa1f6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Basic Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#starting-the-queue-server">Starting the Queue Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="#opening-and-closing-re-worker-environment">Opening and Closing RE Worker Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-items-to-queue">Adding Items to Queue</a></li>
<li class="toctree-l2"><a class="reference internal" href="#starting-and-stopping-the-queue">Starting and Stopping the Queue</a></li>
<li class="toctree-l2"><a class="reference internal" href="#interacting-with-run-engine">Interacting with Run Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-re-manager-with-custom-startup-code">Running RE Manager with Custom Startup Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#manually-generating-lists-of-existing-plans-and-devices">Manually Generating Lists of Existing Plans and Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="#remote-monitoring-of-re-manager-console-output">Remote Monitoring of RE Manager Console Output</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="release_history.html">Release History</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction_for_users.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="features_and_config.html">Features and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow.html">Submitting and Managing Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="startup_code.html">Organizing Bluesky Startup Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="ipython.html">Using IPython Startup Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="item_validation.html">Validation of Queue Items</a></li>
<li class="toctree-l1"><a class="reference internal" href="plan_annotation.html">Annotating Bluesky Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli_tools.html">Command-Line Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application Developer's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interacting_with_qs.html">Interacting with Queue Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="re_manager_api.html">Run Engine Manager API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">bluesky-queueserver</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Basic Tutorials</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="basic-tutorials">
<h1>Basic Tutorials<a class="headerlink" href="#basic-tutorials" title="Permalink to this headline">¶</a></h1>
<p>The purpose of the tutorials in this section is to explore basic features of the Queue Server.
The tutorials also contain brief explanations of Queue Server features and API
and recommendations on how and when they should be used.</p>
<p>Most tutorials require two terminals:
one terminal is used to start Run Engine (RE) manager and display logging
messages and console output from plans; the other terminal is used to interact
with RE Manager by running CLI commands.</p>
<p>The RE Manager is the central component of the Queue Server, which
maintains the queue of plans, creates RE Worker environment (a process where plans are
executed) and provides flexible low level 0MQ API for client applications.
The following tutorials provide instructions on how to interact with RE Manager
using <code class="docutils literal notranslate"><span class="pre">qserver</span></code> CLI tool, which may be considered a basic client application.
<cite>qserver</cite> functionality is limited to sending single 0MQ API requests and
displaying received responses, but it provides direct access
to almost every low level API (except batch queue operations). Use <code class="docutils literal notranslate"><span class="pre">qserver</span> <span class="pre">-h</span></code>
to display brief help and full set of options or read the manual at <a class="reference internal" href="cli_tools.html#qserver-cli"><span class="std std-ref">qserver</span></a>.</p>
<p>In production systems, users are more likely to interact with RE Manager
using custom GUI applications or IPython API (currently under development),
but <code class="docutils literal notranslate"><span class="pre">qserver</span></code> may still be a convenient tool for exploring or demonstrating
Queue Server features or testing and debugging deployed systems.
The instructions on how to interact with RE Manager using <code class="docutils literal notranslate"><span class="pre">qserver</span></code> tool are
also applicable to low level 0MQ API, which could be used in Python programs.
Lists of used 0MQ API with links to documentation are included at the end of
each tutorial.</p>
<section id="starting-the-queue-server">
<span id="tutorial-starting-queue-server"></span><h2>Starting the Queue Server<a class="headerlink" href="#starting-the-queue-server" title="Permalink to this headline">¶</a></h2>
<p>In the first terminal, start RE Manager as a console application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ start-re-manager
[I 2022-02-17 06:54:18,077 bluesky_queueserver.manager.manager] Starting ZMQ server at &#39;tcp://*:60615&#39;
[I 2022-02-17 06:54:18,077 bluesky_queueserver.manager.manager] ZMQ control channels: encryption disabled
[I 2022-02-17 06:54:18,080 bluesky_queueserver.manager.manager] Starting RE Manager process
[I 2022-02-17 06:54:18,096 bluesky_queueserver.manager.manager] Loading the lists of allowed plans and devices ...
[I 2022-02-17 06:54:18,341 bluesky_queueserver.manager.manager] Starting ZeroMQ server ...
[I 2022-02-17 06:54:18,343 bluesky_queueserver.manager.manager] ZeroMQ server is waiting on tcp://*:60615
</pre></div>
</div>
<p>RE Manager functionality may be customized using CLI parameters. The default settings
are selected specifically for running simple demonstrations, so RE Manager may be started
without parameters in most of the tutorials. Type <code class="docutils literal notranslate"><span class="pre">start-re-manager</span> <span class="pre">-h</span></code> to display the
full set of supported parameters. More detailed description may be found in
<a class="reference internal" href="cli_tools.html#start-re-manager-cli"><span class="std std-ref">the application manual</span></a>.</p>
<p>The console output of RE Manager contains logging messages of the server and Bluesky and
text output of the executed plans (such as Live Tables). RE Manager may be configured
to publish console output to 0MQ socket so that it could be streamed to other
applications (see <a class="reference internal" href="#remote-monitoring-tutorial"><span class="std std-ref">Remote Monitoring of RE Manager Console Output</span></a>). Production deployments
of the Queue Server are likely to run RE Manager as a service,
but starting it as an console application is very simple and recommended for tutorials,
demonstrations and software development and testing.</p>
<p>The easiest way to test if the Queue Server is running and accessible is to call the <code class="docutils literal notranslate"><span class="pre">status</span></code> API:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver status
06:55:49 - MESSAGE:
{&#39;devices_allowed_uid&#39;: &#39;42ebeb34-cc00-41ff-96ec-9cb4210d0b10&#39;,
&#39;devices_existing_uid&#39;: &#39;adc31393-3604-4765-b7c0-be25da34b9ec&#39;,
&#39;items_in_history&#39;: 6,
&#39;items_in_queue&#39;: 5,
&#39;manager_state&#39;: &#39;idle&#39;,
&#39;msg&#39;: &#39;RE Manager&#39;,
&#39;pause_pending&#39;: False,
&#39;plan_history_uid&#39;: &#39;658ac3e5-ece3-4947-833f-293f8ec27687&#39;,
&#39;plan_queue_mode&#39;: {&#39;loop&#39;: False},
&#39;plan_queue_uid&#39;: &#39;d409d889-1788-4da6-8af8-05456f63401c&#39;,
&#39;plans_allowed_uid&#39;: &#39;18a7fcf5-fba7-41e8-9872-4379f0537ec9&#39;,
&#39;plans_existing_uid&#39;: &#39;ebad3d13-2106-4e38-89b3-2bc513f3576a&#39;,
&#39;queue_stop_pending&#39;: False,
&#39;re_state&#39;: None,
&#39;run_list_uid&#39;: &#39;e9d8449a-4635-42a0-bf8f-2af87d020e67&#39;,
&#39;running_item_uid&#39;: None,
&#39;task_results_uid&#39;: &#39;b281bed4-2b90-4f31-b8c7-64f2626927f1&#39;,
&#39;worker_background_tasks&#39;: 0,
&#39;worker_environment_exists&#39;: False,
&#39;worker_environment_state&#39;: &#39;closed&#39;}
</pre></div>
</div>
<p>The server always accepts <code class="docutils literal notranslate"><span class="pre">status</span></code> API requests and returns the set of parameters
that reflects current state of RE Manager. For example, <code class="docutils literal notranslate"><span class="pre">'manager_state':</span> <span class="pre">'idle'</span></code>
indicates current state of RE Manager and <code class="docutils literal notranslate"><span class="pre">'worker_environment_exists':</span> <span class="pre">False</span></code> indicates
if RE Worker environment is open and the server is ready to execute plans (currently
the environment does not exist). Timeout occurs if the server is not accessible or does
not respond in time. The detailed reference to RE Manager API could be found in
the section <a class="reference internal" href="re_manager_api.html#supported-methods-for-0mq-api"><span class="std std-ref">Supported Methods For ZMQ Communication API</span></a>. For example, documentation for
the <code class="docutils literal notranslate"><span class="pre">status</span></code> API can be found <a class="reference internal" href="re_manager_api.html#method-status"><span class="std std-ref">here</span></a>.</p>
<p>RE Manager application can be stopped at any time by activating pressing <code class="docutils literal notranslate"><span class="pre">Ctrl-C</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When RE Manager is closed using <code class="docutils literal notranslate"><span class="pre">Ctrl-C</span></code> key combination, execution of any plans, tasks,
queue operations etc. is interrupted without warning or asking for confirmation.
There is no risk of accidentally stopping RE Manager when it is running as a service.</p>
</div>
<p>API used in this tutorial: <a class="reference internal" href="re_manager_api.html#method-status"><span class="std std-ref">‘status’</span></a>.</p>
</section>
<section id="opening-and-closing-re-worker-environment">
<span id="tutorial-opening-closing-re-worker-environment"></span><h2>Opening and Closing RE Worker Environment<a class="headerlink" href="#opening-and-closing-re-worker-environment" title="Permalink to this headline">¶</a></h2>
<p>Start RE Manager using instructions given in <a class="reference internal" href="#tutorial-starting-queue-server"><span class="std std-ref">Starting the Queue Server</span></a>.</p>
<p>In response to the request to open RE Worker Environment, RE Manager creates
a new RE Worker process (for executing Bluesky plans), configures Run Engine and
loads startup code in the RE Worker namespace. RE Manager may load startup code
represented as a set of startup files (IPython style), Python script or module.
<code class="docutils literal notranslate"><span class="pre">bluesky-queueserver</span></code> package includes
<a class="reference external" href="https://github.com/bluesky/bluesky-queueserver/tree/main/bluesky_queueserver/profile_collection_sim">a set of startup files</a>
with simulated devices and plans sufficient for simple demos. RE Manager
is loading the built-in startup code unless alternative location is specified
(see <a class="reference internal" href="#tutorial-running-custom-startup-code"><span class="std std-ref">Running RE Manager with Custom Startup Code</span></a>).</p>
<p>Open the RE Worker environment using <code class="docutils literal notranslate"><span class="pre">qserver</span></code> CLI tool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver environment open
07:06:00 - MESSAGE:
{&#39;msg&#39;: &#39;&#39;, &#39;success&#39;: True}
</pre></div>
</div>
<p>The returned parameters include the flag, which indicates if the request was
accepted by the server (<code class="docutils literal notranslate"><span class="pre">'success':</span> <span class="pre">True</span></code>) and the error message (<code class="docutils literal notranslate"><span class="pre">'msg':</span> <span class="pre">''</span></code>),
which is an empty string if the request is accepted. The API request only initiates
the process of opening the environment, which may take significant time.
The returned result <code class="docutils literal notranslate"><span class="pre">'success':</span> <span class="pre">True</span></code> does not mean that the environment was successfully loaded
or loaded at all. To find if the environment was loaded, check the status of RE Manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver status
07:15:15 - MESSAGE:
{ ...
&#39;manager_state&#39;: &#39;idle&#39;,
  ...
&#39;worker_environment_exists&#39;: True,
&#39;worker_environment_state&#39;: &#39;idle&#39;}
</pre></div>
</div>
<p>The most likely reason for failure to open an environment is an exception raised in the startup
code. Search the console output of RE Manager for error messages and traceback.</p>
<p>Repeated requests to open the environment are rejected by the server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver environment open
07:47:59 - MESSAGE:
{&#39;msg&#39;: &#39;RE Worker environment already exists.&#39;, &#39;success&#39;: False}
</pre></div>
</div>
<p>The environment must be opened before executing any plans. The request to start
the plan queue is rejected if the environment closed. All queue operations,
including adding/removing/moving plans, do not require open environment.
The process of opening an environment may indirectly affect the queue operations,
because it involves generating new lists of existing/allowed plans and devices
based on loaded startup scripts (see <a class="reference internal" href="item_validation.html#plan-validation"><span class="std std-ref">Validation of Plans</span></a>).</p>
<p>The operation of closing RE Worker environment involves orderly exit from
the message processing loop and closing the worker process.
Closing the environment is safe, since it may be executed only
if no plans or foreground tasks are running. The requests are rejected
if the environment is busy.</p>
<p>Close the RE Worker environment using <code class="docutils literal notranslate"><span class="pre">qserver</span></code> CLI tool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver environment close
07:48:53 - MESSAGE:
{&#39;msg&#39;: &#39;&#39;, &#39;success&#39;: True}
</pre></div>
</div>
<p>The API request only initiates the process of closing the environment. Check RE Manager status
to determine if the environment was closed successfully:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver status
07:15:15 - MESSAGE:
{ ...
&#39;manager_state&#39;: &#39;idle&#39;,
  ...
&#39;worker_environment_exists&#39;: False,
&#39;worker_environment_state&#39;: &#39;closed&#39;}
</pre></div>
</div>
<p>Repeated requests to close the environment are rejected:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver environment close
07:49:46 - MESSAGE:
{&#39;msg&#39;: &#39;RE Worker environment does not exist.&#39;, &#39;success&#39;: False}
</pre></div>
</div>
<p>RE Worker Environment is designed to run user code in the form of Bluesky plans or user defined
functions. If the main thread gets stuck in an infinite loop or inifinite wait (e.g. waits for
non-responding PV without timeout), the environment may become unresponsive and can not be closed.
This may cause substantial inconvenience during remote operation of the beamline. RE Manager
supports an API that allow to recover from this state by destroying an unresponsive environment
(killing the RE Worker process). After the environment is destroyed, a new environment may be opened
and operation resumed. The operation of destroying an environment is unsafe, and accidentally
sending the request during normal operation kills any running plans or tasks.</p>
<p>The process of destroying the RE Worker environment is initiated using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver environment destroy
07:50:25 - MESSAGE:
{&#39;msg&#39;: &#39;&#39;, &#39;success&#39;: True}
</pre></div>
</div>
<p>It may take a little time for the operation to complete. Check the status to verify that
the environment is in closed state and RE Manager is idle.</p>
<p>API used in this tutorial: <a class="reference internal" href="re_manager_api.html#method-status"><span class="std std-ref">‘status’</span></a>, <a class="reference internal" href="re_manager_api.html#method-environment-open"><span class="std std-ref">‘environment_open’</span></a>,
<a class="reference internal" href="re_manager_api.html#method-environment-close"><span class="std std-ref">‘environment_close’</span></a>, <a class="reference internal" href="re_manager_api.html#method-environment-destroy"><span class="std std-ref">‘environment_destroy’</span></a>.</p>
</section>
<section id="adding-items-to-queue">
<span id="tutorial-adding-queue-items"></span><h2>Adding Items to Queue<a class="headerlink" href="#adding-items-to-queue" title="Permalink to this headline">¶</a></h2>
<p>Queue operations, such as adding and removing items, replacing or moving existing items,
may be performed at any time. The environment does not need to be opened to manipulate the queue.
Queue Server performs validation of the submitted plans and rejects plans that do not exist or
the plans that are not allowed to be executed by the user. Plans may accept devices
as parameter values. The devices must be in the list of allowed devices for the user
submitting the plan, otherwise the plan is rejected (if plan parameters are validated) or
fail during plan execution.</p>
<p>Start RE Manager using instructions given in <a class="reference internal" href="#tutorial-starting-queue-server"><span class="std std-ref">Starting the Queue Server</span></a>.</p>
<p>Display the lists of allowed plans and devices. Note that the plans <code class="docutils literal notranslate"><span class="pre">scan</span></code> and <code class="docutils literal notranslate"><span class="pre">count</span></code> are
in the list of allowed plans and <code class="docutils literal notranslate"><span class="pre">det1</span></code>, <code class="docutils literal notranslate"><span class="pre">det2</span></code> and <code class="docutils literal notranslate"><span class="pre">motor</span></code> are in the list of allowed devices.
<cite>qserver</cite> tool displays only the set top-level device names, but subdevice names can also
be used as plan parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver allowed plans
09:27:52 - MESSAGE:
{&#39;msg&#39;: &#39;&#39;,
&#39;plans_allowed&#39;: {&#39;adaptive_scan&#39;: &#39;{...}&#39;,
                  &#39;count&#39;: &#39;{...}&#39;,
                  &#39;count_bundle_test&#39;: &#39;{...}&#39;,
                  ...
                  &#39;relative_inner_product_scan&#39;: &#39;{...}&#39;,
                  &#39;scan&#39;: &#39;{...}&#39;,
                  ...
                  &#39;x2x_scan&#39;: &#39;{...}&#39;},
&#39;plans_allowed_uid&#39;: &#39;18a7fcf5-fba7-41e8-9872-4379f0537ec9&#39;,
&#39;success&#39;: True}

$ qserver allowed devices
09:31:45 - MESSAGE:.;
{&#39;devices_allowed&#39;: {&#39;ab_det&#39;: &#39;{...}&#39;,
                    ...
                    &#39;det&#39;: &#39;{...}&#39;,
                    &#39;det1&#39;: &#39;{...}&#39;,
                    &#39;det2&#39;: &#39;{...}&#39;,
                    &#39;det3&#39;: &#39;{...}&#39;,
                    &#39;det4&#39;: &#39;{...}&#39;,
                    &#39;det5&#39;: &#39;{...}&#39;,
                    ...
                    &#39;motor&#39;: &#39;{...}&#39;,
                    &#39;motor1&#39;: &#39;{...}&#39;,
                    &#39;motor2&#39;: &#39;{...}&#39;,
                    &#39;motor3&#39;: &#39;{...}&#39;,
                    ...
                    &#39;sim_bundle_A&#39;: &#39;{...}&#39;,
                    &#39;sim_bundle_B&#39;: &#39;{...}&#39;},
&#39;devices_allowed_uid&#39;: &#39;42ebeb34-cc00-41ff-96ec-9cb4210d0b10&#39;,
&#39;msg&#39;: &#39;&#39;,
&#39;success&#39;: True}
</pre></div>
</div>
<p>First let’s clear the queue, since it may already contain plans:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue clear
10:08:09 - MESSAGE:
{&#39;msg&#39;: &#39;&#39;, &#39;success&#39;: True}
</pre></div>
</div>
<p>Verify that the number of items in the queue is zero:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver status
10:08:25 - MESSAGE:
{ ...
&#39;items_in_queue&#39;: 0,
... }
</pre></div>
</div>
<p>Load the contents of the queue (<code class="docutils literal notranslate"><span class="pre">item</span></code>), which should be empty at this point:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue get
10:08:35 - MESSAGE:
{&#39;items&#39;: [],
&#39;msg&#39;: &#39;&#39;,
&#39;plan_queue_uid&#39;: &#39;5ae71b0f-c671-4ce3-93bb-b854296dd4f8&#39;,
&#39;running_item&#39;: {},
&#39;success&#39;: True}
</pre></div>
</div>
<p>Now let’s add the plan <code class="docutils literal notranslate"><span class="pre">count([det1,</span> <span class="pre">det2],</span> <span class="pre">num=10,</span> <span class="pre">delay=2)</span></code> to the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue add plan &#39;{&quot;name&quot;: &quot;count&quot;, &quot;args&quot;: [[&quot;det1&quot;, &quot;det2&quot;]], &quot;kwargs&quot;: {&quot;num&quot;: 10, &quot;delay&quot;: 1}}&#39;
10:04:49 - MESSAGE:
{&#39;item&#39;: {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
          &#39;item_type&#39;: &#39;plan&#39;,
          &#39;item_uid&#39;: &#39;0aa7f1be-3923-4d67-ba7b-b19d26ec6291&#39;,
          &#39;kwargs&#39;: {&#39;delay&#39;: 1, &#39;num&#39;: 10},
          &#39;name&#39;: &#39;count&#39;,
          &#39;user&#39;: &#39;qserver-cli&#39;,
          &#39;user_group&#39;: &#39;admin&#39;},
&#39;msg&#39;: &#39;&#39;,
&#39;qsize&#39;: 1,
&#39;success&#39;: True}
</pre></div>
</div>
<p>The submitted plan was accepted by the server and added to the queue. The parameter <code class="docutils literal notranslate"><span class="pre">'qsize':</span> <span class="pre">1</span></code>
shows the new size of the plan queue. Verify the queue size and load the updated queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver status
10:08:25 - MESSAGE:
{ ...
&#39;items_in_queue&#39;: 1,
... }

$ qserver queue get
10:16:43 - MESSAGE:
{&#39;items&#39;: [{&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;af4169c0-1d9c-4412-ad0b-5a232e1b13e7&#39;,
            &#39;kwargs&#39;: {&#39;delay&#39;: 1, &#39;num&#39;: 10},
            &#39;name&#39;: &#39;count&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;}],
&#39;msg&#39;: &#39;&#39;,
&#39;plan_queue_uid&#39;: &#39;dfad1d60-abd9-4bd9-895c-10b7c2dc8897&#39;,
&#39;running_item&#39;: {},
&#39;success&#39;: True}
</pre></div>
</div>
<p>The items are added to the back of the queue by default. Let’s add another plan
<code class="docutils literal notranslate"><span class="pre">scan([det1,</span> <span class="pre">det2],</span> <span class="pre">motor,</span> <span class="pre">-1,</span> <span class="pre">1,</span> <span class="pre">10)</span></code> to the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue add plan &#39;{&quot;name&quot;: &quot;scan&quot;, &quot;args&quot;: [[&quot;det1&quot;, &quot;det2&quot;], &quot;motor&quot;, -1, 1, 10]}&#39;
10:21:37 - MESSAGE:
{&#39;item&#39;: {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;], &#39;motor&#39;, -1, 1, 10],
          &#39;item_type&#39;: &#39;plan&#39;,
          &#39;item_uid&#39;: &#39;17e45208-b8d7-4545-9bd6-d6aa7263adc9&#39;,
          &#39;name&#39;: &#39;scan&#39;,
          &#39;user&#39;: &#39;qserver-cli&#39;,
          &#39;user_group&#39;: &#39;admin&#39;},
&#39;msg&#39;: &#39;&#39;,
&#39;qsize&#39;: 2,
&#39;success&#39;: True}
</pre></div>
</div>
<p>Note that the queue size is now 2. Load the list of queue items and verify that the <code class="docutils literal notranslate"><span class="pre">scan</span></code> plan
is added to the back of the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue get
10:24:24 - MESSAGE:
{&#39;items&#39;: [{&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;af4169c0-1d9c-4412-ad0b-5a232e1b13e7&#39;,
            &#39;kwargs&#39;: {&#39;delay&#39;: 1, &#39;num&#39;: 10},
            &#39;name&#39;: &#39;count&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;},
          {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;], &#39;motor&#39;, -1, 1, 10],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;17e45208-b8d7-4545-9bd6-d6aa7263adc9&#39;,
            &#39;name&#39;: &#39;scan&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;}],
&#39;msg&#39;: &#39;&#39;,
&#39;plan_queue_uid&#39;: &#39;29d6b8fe-7100-4bdc-b348-845cc2728d1b&#39;,
&#39;running_item&#39;: {},
&#39;success&#39;: True}
</pre></div>
</div>
<p>The RE Manager API supports an extensive set of options to define the location of inserted plans.
For example a plan may be inserted to the front of the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue add plan front &#39;{&quot;name&quot;: &quot;scan&quot;, &quot;args&quot;: [[&quot;det1&quot;], &quot;motor&quot;, -2, 2, 5]}&#39;
10:29:09 - MESSAGE:
{&#39;item&#39;: {&#39;args&#39;: [[&#39;det1&#39;], &#39;motor&#39;, -2, 2, 5],
          &#39;item_type&#39;: &#39;plan&#39;,
          &#39;item_uid&#39;: &#39;3a6ae812-5d59-4f05-bfad-67e4f8a798e2&#39;,
          &#39;name&#39;: &#39;scan&#39;,
          &#39;user&#39;: &#39;qserver-cli&#39;,
          &#39;user_group&#39;: &#39;admin&#39;},
&#39;msg&#39;: &#39;&#39;,
&#39;qsize&#39;: 3,
&#39;success&#39;: True}
</pre></div>
</div>
<p>Verify that the new plan was inserted to the front of the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue get
  10:30:00 - MESSAGE:
  {&#39;items&#39;: [{&#39;args&#39;: [[&#39;det1&#39;], &#39;motor&#39;, -2, 2, 5],
              &#39;item_type&#39;: &#39;plan&#39;,
              &#39;item_uid&#39;: &#39;3a6ae812-5d59-4f05-bfad-67e4f8a798e2&#39;,
              &#39;name&#39;: &#39;scan&#39;,
              &#39;user&#39;: &#39;qserver-cli&#39;,
              &#39;user_group&#39;: &#39;admin&#39;},
            {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
              &#39;item_type&#39;: &#39;plan&#39;,
              &#39;item_uid&#39;: &#39;af4169c0-1d9c-4412-ad0b-5a232e1b13e7&#39;,
              &#39;kwargs&#39;: {&#39;delay&#39;: 1, &#39;num&#39;: 10},
              &#39;name&#39;: &#39;count&#39;,
              &#39;user&#39;: &#39;qserver-cli&#39;,
              &#39;user_group&#39;: &#39;admin&#39;},
            {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;], &#39;motor&#39;, -1, 1, 10],
              &#39;item_type&#39;: &#39;plan&#39;,
              &#39;item_uid&#39;: &#39;17e45208-b8d7-4545-9bd6-d6aa7263adc9&#39;,
              &#39;name&#39;: &#39;scan&#39;,
              &#39;user&#39;: &#39;qserver-cli&#39;,
              &#39;user_group&#39;: &#39;admin&#39;}],
  &#39;msg&#39;: &#39;&#39;,
  &#39;plan_queue_uid&#39;: &#39;ba87dce1-c598-4a4a-a801-3e145e9b4365&#39;,
  &#39;running_item&#39;: {},
  &#39;success&#39;: True}
</pre></div>
</div>
<p>The queue may contain instructions that are executed by RE Manager and
control execution of the queue. The only supported instruction is <code class="docutils literal notranslate"><span class="pre">queue_stop</span></code>,
which stops execution of the queue (for example to let the operator change
a sample). The queue can be restarted afterwards. The following
command will insert the instruction before the element at position <code class="docutils literal notranslate"><span class="pre">-2</span></code>
in the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue add instruction -2 queue-stop
10:36:31 - MESSAGE:
{&#39;item&#39;: {&#39;item_type&#39;: &#39;instruction&#39;,
          &#39;item_uid&#39;: &#39;e2fcb2b6-a968-4e36-a345-47416b3814b0&#39;,
          &#39;name&#39;: &#39;queue_stop&#39;,
          &#39;user&#39;: &#39;qserver-cli&#39;,
          &#39;user_group&#39;: &#39;admin&#39;},
&#39;msg&#39;: &#39;&#39;,
&#39;qsize&#39;: 4,
&#39;success&#39;: True}

$ qserver queue get
10:36:40 - MESSAGE:
{&#39;items&#39;: [{&#39;args&#39;: [[&#39;det1&#39;], &#39;motor&#39;, -2, 2, 5],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;3a6ae812-5d59-4f05-bfad-67e4f8a798e2&#39;,
            &#39;name&#39;: &#39;scan&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;},
          {&#39;item_type&#39;: &#39;instruction&#39;,
            &#39;item_uid&#39;: &#39;e2fcb2b6-a968-4e36-a345-47416b3814b0&#39;,
            &#39;name&#39;: &#39;queue_stop&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;},
          {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;af4169c0-1d9c-4412-ad0b-5a232e1b13e7&#39;,
            &#39;kwargs&#39;: {&#39;delay&#39;: 1, &#39;num&#39;: 10},
            &#39;name&#39;: &#39;count&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;},
          {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;], &#39;motor&#39;, -1, 1, 10],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;17e45208-b8d7-4545-9bd6-d6aa7263adc9&#39;,
            &#39;name&#39;: &#39;scan&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;}],
&#39;msg&#39;: &#39;&#39;,
&#39;plan_queue_uid&#39;: &#39;bc66304a-2cd3-430a-acae-1b2152b60dba&#39;,
&#39;running_item&#39;: {},
&#39;success&#39;: True}
</pre></div>
</div>
<p>Note, that using negative indices to address queue items (counting items
from the back of the queue) is more reliable, since queue operations could
be performed while the queue is running and items may be removed from
the front of the queue at any moment. Alternatively, items may be addressed
using <code class="docutils literal notranslate"><span class="pre">item_uid</span></code>, which is never changed by the queue operations.</p>
<p>API used in this tutorial: <a class="reference internal" href="re_manager_api.html#method-status"><span class="std std-ref">‘status’</span></a>, <a class="reference internal" href="re_manager_api.html#method-queue-item-add"><span class="std std-ref">‘queue_item_add’</span></a>,
<a class="reference internal" href="re_manager_api.html#method-queue-get"><span class="std std-ref">‘queue_get’</span></a>, <a class="reference internal" href="re_manager_api.html#method-queue-clear"><span class="std std-ref">‘queue_clear’</span></a>, <a class="reference internal" href="re_manager_api.html#method-plans-allowed"><span class="std std-ref">‘plans_allowed’</span></a>,
<a class="reference internal" href="re_manager_api.html#method-devices-allowed"><span class="std std-ref">‘devices_allowed’</span></a>.</p>
</section>
<section id="starting-and-stopping-the-queue">
<span id="tutorial-starting-stopping-queue"></span><h2>Starting and Stopping the Queue<a class="headerlink" href="#starting-and-stopping-the-queue" title="Permalink to this headline">¶</a></h2>
<p>Start RE Manager using instructions given in <a class="reference internal" href="#tutorial-starting-queue-server"><span class="std std-ref">Starting the Queue Server</span></a>.</p>
<p>Clear the queue and add a few plans to the queue as described in <a class="reference internal" href="#tutorial-adding-queue-items"><span class="std std-ref">Adding Items to Queue</span></a>.
For this tutorial, it is recommended to use plans that take relatively long time
to execute. For example the following plan runs for about 20 seconds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue add plan &#39;{&quot;name&quot;: &quot;count&quot;, &quot;args&quot;: [[&quot;det1&quot;, &quot;det2&quot;]], &quot;kwargs&quot;: {&quot;num&quot;: 10, &quot;delay&quot;: 2}}&#39;
</pre></div>
</div>
<p>In the following example we assume that the queue contains three <code class="docutils literal notranslate"><span class="pre">count</span></code> plans with the queue
execution time about 60 seconds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue get
13:07:40 - MESSAGE:
{&#39;items&#39;: [{&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;fffa482a-f655-4999-9e90-1d6550f67b72&#39;,
            &#39;kwargs&#39;: {&#39;delay&#39;: 2, &#39;num&#39;: 10},
            &#39;name&#39;: &#39;count&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;},
          {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;7426b43b-102f-42f1-a43e-2c3f2b9009a7&#39;,
            &#39;kwargs&#39;: {&#39;delay&#39;: 2, &#39;num&#39;: 10},
            &#39;name&#39;: &#39;count&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;},
          {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;859760ef-51ad-4861-832c-b113b008fa3e&#39;,
            &#39;kwargs&#39;: {&#39;delay&#39;: 2, &#39;num&#39;: 10},
            &#39;name&#39;: &#39;count&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;}],
&#39;msg&#39;: &#39;&#39;,
&#39;plan_queue_uid&#39;: &#39;a20c74fe-0888-4e61-9a37-4fbc9697fe3d&#39;,
&#39;running_item&#39;: {},
&#39;success&#39;: True}
</pre></div>
</div>
<p>Open the environment as described in <a class="reference internal" href="#tutorial-opening-closing-re-worker-environment"><span class="std std-ref">Opening and Closing RE Worker Environment</span></a>.</p>
<p>Every plan that is executed by RE Manager is added to the plan history. The history
is not designed to for long-term storage and must be periodically cleared:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver history clear
11:51:11 - MESSAGE:
{&#39;msg&#39;: &#39;&#39;, &#39;success&#39;: True}
</pre></div>
</div>
<p>The number of items in the history is reported as part RE Manager status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver status
12:01:14 - MESSAGE:
{ ...
&#39;items_in_history&#39;: 0,
&#39;items_in_queue&#39;: 3,
... }
</pre></div>
</div>
<p>Start the queue and observe the logging messages and Live Table displayed in
the terminal running RE Manager (<code class="docutils literal notranslate"><span class="pre">'success':</span> <span class="pre">True</span></code> indicates that the request
was accepted by the server and the queue is about to get started):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue start
12:05:15 - MESSAGE:
{&#39;msg&#39;: &#39;&#39;, &#39;success&#39;: True}
</pre></div>
</div>
<p>While the first plan is still running, check the contents of the queue:
<code class="docutils literal notranslate"><span class="pre">running_item</span></code> is a dictionary of parameters of the currently running plan
and <code class="docutils literal notranslate"><span class="pre">items</span></code> is a list of the plans remaining in the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue get
Arguments: [&#39;queue&#39;, &#39;get&#39;]
13:07:54 - MESSAGE:
{&#39;items&#39;: [{&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;7426b43b-102f-42f1-a43e-2c3f2b9009a7&#39;,
            &#39;kwargs&#39;: {&#39;delay&#39;: 2, &#39;num&#39;: 10},
            &#39;name&#39;: &#39;count&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;},
          {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
            &#39;item_type&#39;: &#39;plan&#39;,
            &#39;item_uid&#39;: &#39;859760ef-51ad-4861-832c-b113b008fa3e&#39;,
            &#39;kwargs&#39;: {&#39;delay&#39;: 2, &#39;num&#39;: 10},
            &#39;name&#39;: &#39;count&#39;,
            &#39;user&#39;: &#39;qserver-cli&#39;,
            &#39;user_group&#39;: &#39;admin&#39;}],
&#39;msg&#39;: &#39;&#39;,
&#39;plan_queue_uid&#39;: &#39;4948d6ba-586c-4a70-a1f9-f933124c1e58&#39;,
&#39;running_item&#39;: {&#39;args&#39;: [[&#39;det1&#39;, &#39;det2&#39;]],
                  &#39;item_type&#39;: &#39;plan&#39;,
                  &#39;item_uid&#39;: &#39;fffa482a-f655-4999-9e90-1d6550f67b72&#39;,
                  &#39;kwargs&#39;: {&#39;delay&#39;: 2, &#39;num&#39;: 10},
                  &#39;name&#39;: &#39;count&#39;,
                  &#39;user&#39;: &#39;qserver-cli&#39;,
                  &#39;user_group&#39;: &#39;admin&#39;},
&#39;success&#39;: True}
</pre></div>
</div>
<p>Once all plans are completed, verify RE Manager status to make sure that
the queue is empty and the correct number of plans were added to history:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver status
12:16:31 - MESSAGE:
{ ...
&#39;items_in_history&#39;: 3,
&#39;items_in_queue&#39;: 0,
... }
</pre></div>
</div>
<p>All functions for manipulating the queue are accessible while the queue is running.
Add a few plans to the queue, start the queue and try adding plans to the queue while
it is running. Check the contents of the queue (<code class="docutils literal notranslate"><span class="pre">qserver</span> <span class="pre">queue</span> <span class="pre">get</span></code>) to observe
changes.</p>
<p>RE Manager supports an API that allows to stop execution of the queue after
completion of the current plan. This API is intended to be used in cases when
the currently running plan should be normally completed, but some intervention
by the operator (e.g. adjustment of the sample) is needed before the next plan
is started. The API call does not influence execution of currently running plan.</p>
<p>Add more plans to the queue and start the queue. While the first plan is running
use the following command to stop the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue stop
2:19:01 - MESSAGE:
{&#39;msg&#39;: &#39;&#39;, &#39;success&#39;: True}
</pre></div>
</div>
<p>While the plan is still running, check that the current state is reflected in
the RE Manager status (<code class="docutils literal notranslate"><span class="pre">queue_stop_pending</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver status
12:19:05 - MESSAGE:
{ ...
&#39;manager_state&#39;: &#39;executing_queue&#39;,
...
&#39;queue_stop_pending&#39;: True,
... }
</pre></div>
</div>
<p>Observe that the queue stops after the current plan is completed. Note, that the
sequence of commands (<code class="docutils literal notranslate"><span class="pre">qserver</span> <span class="pre">queue</span> <span class="pre">start</span></code>, <code class="docutils literal notranslate"><span class="pre">qserver</span> <span class="pre">queue</span> <span class="pre">stop</span></code> and <code class="docutils literal notranslate"><span class="pre">qserver</span> <span class="pre">status</span></code>)
must be issued while the plan is running. Increase the values of <code class="docutils literal notranslate"><span class="pre">num</span></code> or <code class="docutils literal notranslate"><span class="pre">delay</span></code>
plan parameters to make the plan run longer if needed.</p>
<p>Since plans may take long time (potentially hours) to execute and an operator may send the API request
to stop the queue by mistake or change the decision while the plan is running, RE Manager
allows to cancel the pending request to stop the queue. Execute the following commands in rapid
sequence while the plan is still running to observe change in <code class="docutils literal notranslate"><span class="pre">queue_stop_pending</span></code> status
parameter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue start

$ qserver queue stop

$ qserver status
12:41:38 - MESSAGE:
{ ...
&#39;manager_state&#39;: &#39;executing_queue&#39;,
...
&#39;queue_stop_pending&#39;: True,
... }

$ qserver queue stop cancel

$ qserver status
12:41:46 - MESSAGE:
{ ...
&#39;manager_state&#39;: &#39;executing_queue&#39;,
...
&#39;queue_stop_pending&#39;: False,
... }
</pre></div>
</div>
<p>Execution of the plans will continue until the queue is empty.</p>
<p>API used in this tutorial: <a class="reference internal" href="re_manager_api.html#method-status"><span class="std std-ref">‘status’</span></a>, <a class="reference internal" href="re_manager_api.html#method-queue-start"><span class="std std-ref">‘queue_start’</span></a>, <a class="reference internal" href="re_manager_api.html#method-queue-stop"><span class="std std-ref">‘queue_stop’</span></a>,
<a class="reference internal" href="re_manager_api.html#method-queue-stop-cancel"><span class="std std-ref">‘queue_stop_cancel’</span></a>, <a class="reference internal" href="re_manager_api.html#method-history-clear"><span class="std std-ref">‘history_clear’</span></a>.</p>
</section>
<section id="interacting-with-run-engine">
<span id="tutorial-iteracting-with-run-engine"></span><h2>Interacting with Run Engine<a class="headerlink" href="#interacting-with-run-engine" title="Permalink to this headline">¶</a></h2>
<p>RE Manager hides most of the low level details related to execution of plans,
but some functionality relevant to Run Engine monitoring and control is
accessible via 0MQ API:</p>
<ul class="simple">
<li><p>Status parameters: <code class="docutils literal notranslate"><span class="pre">re_state</span></code> indicating current state of the Run Engine and
<code class="docutils literal notranslate"><span class="pre">pause_pending</span></code> which indicates if deferred pause is pending at Run Engine.</p></li>
<li><p>0MQ API for pausing, resuming, stopping, aborting or halting the running plan.
See <a class="reference external" href="https://blueskyproject.io/bluesky/state-machine.html#interruptions">Bluesky documentation</a>
for more detailed information on how Run Engine is handling plan interruptions.</p></li>
</ul>
<p>Run Engine is not instantiated if the RE Worker environment is closed and
<code class="docutils literal notranslate"><span class="pre">re_state</span></code> is always <code class="docutils literal notranslate"><span class="pre">None</span></code> and <code class="docutils literal notranslate"><span class="pre">pause_pending</span></code> is <code class="docutils literal notranslate"><span class="pre">False</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver status
14:59:09 - MESSAGE:
{ ...
&#39;pause_pending&#39;: False,
...
&#39;re_state&#39;: None,
... }
</pre></div>
</div>
<p>If environment is open (see <a class="reference internal" href="#tutorial-opening-closing-re-worker-environment"><span class="std std-ref">Opening and Closing RE Worker Environment</span></a>),
then <code class="docutils literal notranslate"><span class="pre">re_state</span></code> is a string that represents actual state of the Run Engine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver status
16:19:30 - MESSAGE:
{ ...
&#39;pause_pending&#39;: False,
...
&#39;re_state&#39;: &#39;idle&#39;,
... }
</pre></div>
</div>
<p>The operations that interrupt execution of currently running plan are handled by
the Run Engine. RE Manager provides API for initiating plan interruptions, including
pausing the plan, and then resuming, stopping, aborting or halting the paused plan.
Note, that the API for stopping the queue and stopping the paused plan are not related,
except that the queue is automatically stopped if the plan is stopped, aborted, halted
or fails to complete in any other way.</p>
<p>It is assumed that the RE Worker environment is open. Add a plan to the queue.
The following plan runs for one minute and should work well for the demonstration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver queue add plan &#39;{&quot;name&quot;: &quot;count&quot;, &quot;args&quot;: [[&quot;det1&quot;, &quot;det2&quot;]], &quot;kwargs&quot;: {&quot;num&quot;: 6, &quot;delay&quot;: 10}}&#39;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">count</span></code> plan contains a checkpoint before each measurement. The API allow to initiate
deferred and immediate pause. In case of deferred pause (equivalent to single Ctrl-C in IPython)
the plan is executed until the next checkpoint, i.e. the current measurement is completed
and the next measurement is started once the plan is resumed. In case of immediate pause
(double Ctrl-C in IPython) the plan is rolled back to the previous checkpoint and the current
measurement is repeated once the plan is resumed. The plan performs 6 measurments with the
period of 10 seconds between measurements, so it is easy to observer how operations of pausing
and resuming the plans works:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Start the queue
$ qserver queue start

# Request the deferred pause
$ qserver re pause
16:59:59 - MESSAGE:
{&#39;msg&#39;: &#39;&#39;, &#39;success&#39;: True}

# Check status while the plan is still running, but deferred pause is pending
$ qserver status
Arguments: [&#39;status&#39;]
{ ...
&#39;manager_state&#39;: &#39;executing_queue&#39;,
...
&#39;pause_pending&#39;: True,
...
&#39;re_state&#39;: &#39;running&#39;,
...}

# Check status again once the plan is paused (takes a few seconds to reach the next checkpoint)
$ qserver status
17:00:25 - MESSAGE:
{ ...
&#39;manager_state&#39;: &#39;paused&#39;,
...
&#39;pause_pending&#39;: False,
...
&#39;re_state&#39;: &#39;paused&#39;,
...}

# Resume the plan
$ qserver re resume
17:07:08 - MESSAGE:
{&#39;msg&#39;: &#39;&#39;, &#39;success&#39;: True}
</pre></div>
</div>
<p>The output of RE Manager contains the following Live Table. Note, that the measurement #1
was fully completed and not repeated after the plan was resumed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Transient</span> <span class="n">Scan</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">1</span>     <span class="n">Time</span><span class="p">:</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">16</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">53</span>
<span class="n">Persistent</span> <span class="n">Unique</span> <span class="n">Scan</span> <span class="n">ID</span><span class="p">:</span> <span class="s1">&#39;fc9f444e-9a52-4df6-9486-a877f9022528&#39;</span>
<span class="n">New</span> <span class="n">stream</span><span class="p">:</span> <span class="s1">&#39;primary&#39;</span>
<span class="o">+-----------+------------+------------+------------+</span>
<span class="o">|</span>   <span class="n">seq_num</span> <span class="o">|</span>       <span class="n">time</span> <span class="o">|</span>       <span class="n">det2</span> <span class="o">|</span>       <span class="n">det1</span> <span class="o">|</span>
<span class="o">+-----------+------------+------------+------------+</span>
<span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="mi">16</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">53.1</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="p">[</span><span class="n">I</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">16</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">198</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">manager</span><span class="p">]</span> <span class="n">Pausing</span> <span class="n">the</span> <span class="n">queue</span> <span class="p">(</span><span class="n">currently</span> <span class="n">running</span> <span class="n">plan</span><span class="p">)</span> <span class="o">...</span>
<span class="p">[</span><span class="n">I</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">16</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">198</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">worker</span><span class="p">]</span> <span class="n">Pausing</span> <span class="n">Run</span> <span class="n">Engine</span> <span class="o">...</span>
<span class="n">Deferred</span> <span class="n">pause</span> <span class="n">acknowledged</span><span class="o">.</span> <span class="n">Continuing</span> <span class="n">to</span> <span class="n">checkpoint</span><span class="o">.</span>
<span class="n">Pausing</span><span class="o">...</span>
<span class="p">[</span><span class="n">I</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">17</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">08</span><span class="p">,</span><span class="mi">353</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">manager</span><span class="p">]</span> <span class="n">Resuming</span> <span class="n">paused</span> <span class="n">plan</span> <span class="o">...</span>
<span class="p">[</span><span class="n">I</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">17</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">08</span><span class="p">,</span><span class="mi">353</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">worker</span><span class="p">]</span> <span class="n">Run</span> <span class="n">Engine</span><span class="p">:</span> <span class="n">resume</span>
<span class="p">[</span><span class="n">I</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">17</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">08</span><span class="p">,</span><span class="mi">353</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">worker</span><span class="p">]</span> <span class="n">Continue</span> <span class="n">plan</span> <span class="n">execution</span> <span class="k">with</span> <span class="n">the</span> <span class="n">option</span> <span class="s1">&#39;resume&#39;</span>
<span class="o">|</span>         <span class="mi">2</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">08.3</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">3</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">08.3</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">4</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">18.3</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">5</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">28.3</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">6</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">38.3</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="n">Run</span> <span class="n">was</span> <span class="n">closed</span><span class="p">:</span> <span class="s1">&#39;fc9f444e-9a52-4df6-9486-a877f9022528&#39;</span>
<span class="o">+-----------+------------+------------+------------+</span>
<span class="n">generator</span> <span class="n">count</span> <span class="p">[</span><span class="s1">&#39;fc9f444e&#39;</span><span class="p">]</span> <span class="p">(</span><span class="n">scan</span> <span class="n">num</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>The following sequence of commands starts the queue and request immediate pause.
The sequence may be tested with the same plan:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver start
$ qserver re pause immediate
$ qserver re resume
</pre></div>
</div>
<p>In the Live Table, measurement #2 was cancelled when the plan was paused
and repeated after the plan was resumed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Transient</span> <span class="n">Scan</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">2</span>     <span class="n">Time</span><span class="p">:</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">17</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">31</span>
<span class="n">Persistent</span> <span class="n">Unique</span> <span class="n">Scan</span> <span class="n">ID</span><span class="p">:</span> <span class="s1">&#39;76e20bbc-e38c-40ab-a66f-f16745f9baf2&#39;</span>
<span class="n">New</span> <span class="n">stream</span><span class="p">:</span> <span class="s1">&#39;primary&#39;</span>
<span class="o">+-----------+------------+------------+------------+</span>
<span class="o">|</span>   <span class="n">seq_num</span> <span class="o">|</span>       <span class="n">time</span> <span class="o">|</span>       <span class="n">det2</span> <span class="o">|</span>       <span class="n">det1</span> <span class="o">|</span>
<span class="o">+-----------+------------+------------+------------+</span>
<span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mf">31.7</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">2</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mf">41.7</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="p">[</span><span class="n">I</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">17</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span><span class="mi">340</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">manager</span><span class="p">]</span> <span class="n">Pausing</span> <span class="n">the</span> <span class="n">queue</span> <span class="p">(</span><span class="n">currently</span> <span class="n">running</span> <span class="n">plan</span><span class="p">)</span> <span class="o">...</span>
<span class="p">[</span><span class="n">I</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">17</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span><span class="mi">341</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">worker</span><span class="p">]</span> <span class="n">Pausing</span> <span class="n">Run</span> <span class="n">Engine</span> <span class="o">...</span>
<span class="n">Pausing</span><span class="o">...</span>
<span class="p">[</span><span class="n">I</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">17</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">52</span><span class="p">,</span><span class="mi">403</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">manager</span><span class="p">]</span> <span class="n">Resuming</span> <span class="n">paused</span> <span class="n">plan</span> <span class="o">...</span>
<span class="p">[</span><span class="n">I</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">17</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">52</span><span class="p">,</span><span class="mi">403</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">worker</span><span class="p">]</span> <span class="n">Run</span> <span class="n">Engine</span><span class="p">:</span> <span class="n">resume</span>
<span class="p">[</span><span class="n">I</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">17</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">52</span><span class="p">,</span><span class="mi">403</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">worker</span><span class="p">]</span> <span class="n">Continue</span> <span class="n">plan</span> <span class="n">execution</span> <span class="k">with</span> <span class="n">the</span> <span class="n">option</span> <span class="s1">&#39;resume&#39;</span>
<span class="o">|</span>         <span class="mi">2</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mf">52.4</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">3</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">02.4</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">4</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">12.4</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">5</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">22.4</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">6</span> <span class="o">|</span> <span class="mi">17</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">32.5</span> <span class="o">|</span>      <span class="mf">1.765</span> <span class="o">|</span>      <span class="mf">5.000</span> <span class="o">|</span>
<span class="n">Run</span> <span class="n">was</span> <span class="n">closed</span><span class="p">:</span> <span class="s1">&#39;76e20bbc-e38c-40ab-a66f-f16745f9baf2&#39;</span>
<span class="o">+-----------+------------+------------+------------+</span>
<span class="n">generator</span> <span class="n">count</span> <span class="p">[</span><span class="s1">&#39;76e20bbc&#39;</span><span class="p">]</span> <span class="p">(</span><span class="n">scan</span> <span class="n">num</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Once the plan is paused, it can be resumed (as alread demonstrated), stopped, aborted or halted. The
technical difference between the three methods of terminating a plan relatively small, except that
stopped plans is considered successful, aborted and halted plans are considered failed; a new plan
can be started immediately after a plan is stopped or aborted, but the environment needs to be
restarted (closed and opened again) after a plan is halted.</p>
<p>The respective <code class="docutils literal notranslate"><span class="pre">qserver</span></code>
commands are</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver re stop
$ qserver re abort
$ qserver re halt
</pre></div>
</div>
<p>API used in this tutorial: <a class="reference internal" href="re_manager_api.html#method-status"><span class="std std-ref">‘status’</span></a>, <a class="reference internal" href="re_manager_api.html#method-re-pause"><span class="std std-ref">‘re_pause’</span></a>, <a class="reference internal" href="re_manager_api.html#method-re-resume-stop-abort-halt"><span class="std std-ref">‘re_resume’, ‘re_stop’, ‘re_abort’, ‘re_halt’</span></a>.</p>
</section>
<section id="running-re-manager-with-custom-startup-code">
<span id="tutorial-running-custom-startup-code"></span><h2>Running RE Manager with Custom Startup Code<a class="headerlink" href="#running-re-manager-with-custom-startup-code" title="Permalink to this headline">¶</a></h2>
<p>All the tutorials in this section are using a set of built-in startup scripts that provide simulated
devices and simple plans, which are sufficient to explore functionality of the Queue Server.
Any practical application would require starting the server with custom startup scripts
with Ophyd devices that represent real hardware and Bluesky plans that perform useful measurements.
This tutorial provides instructions for configuring the server to load custom IPython-style set
of startup scripts.</p>
<p>Instead of creating new scripts, we will copy the existing startup files in custom directory and
configure the server to load scripts from this directory. Those scripts could be then modified
or replaced custom scripts.</p>
<p><strong>Step 1.</strong> Create a directory for the startup files in a convenient location, e.g. <code class="docutils literal notranslate"><span class="pre">~/qs_startup</span></code>.
The directory should be readable and writable for the user running RE Manager.</p>
<p><strong>Step 2.</strong> Copy startup scripts (only .py files) and <code class="docutils literal notranslate"><span class="pre">user_group_permissions.yaml</span></code> from
<a class="reference external" href="https://github.com/bluesky/bluesky-queueserver/tree/main/bluesky_queueserver/profile_collection_sim">the repository</a>
to <code class="docutils literal notranslate"><span class="pre">~/qs_startup</span></code>. The file <code class="docutils literal notranslate"><span class="pre">existing_plans_and_devices.yaml</span></code> will be generated by RE Manager
as part of the tutorial, so do not copy it. The directory should contain the following files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls
00-ophyd.py  15-plans.py  99-custom.py  user_group_permissions.yaml
</pre></div>
</div>
<p><strong>Step 3.</strong> Start RE Manager by specifying the path to startup directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ start-re-manager --startup-dir ~/qs_startup
[W 2022-02-17 18:43:10,262 bluesky_queueserver.manager.start_manager] The file with the list of allowed plans and devices (&#39;/home/dgavrilov/qs_startup/existing_plans_and_devices.yaml&#39;) does not exist. The manager will be started with empty list. The list will be populated after RE worker environment is opened the first time.
[I 2022-02-17 18:43:10,263 bluesky_queueserver.manager.manager] Starting ZMQ server at &#39;tcp://*:60615&#39;
[I 2022-02-17 18:43:10,263 bluesky_queueserver.manager.manager] ZMQ control channels: encryption disabled
[I 2022-02-17 18:43:10,266 bluesky_queueserver.manager.manager] Starting RE Manager process
[I 2022-02-17 18:43:10,284 bluesky_queueserver.manager.manager] Loading the lists of allowed plans and devices ...
[W 2022-02-17 18:43:10,284 bluesky_queueserver.manager.profile_ops] List of plans and devices is not loaded. File &#39;existing_plans_and_devices.yaml&#39; does not exist.
[I 2022-02-17 18:43:10,285 bluesky_queueserver.manager.manager] Starting ZeroMQ server ...
[I 2022-02-17 18:43:10,285 bluesky_queueserver.manager.manager] ZeroMQ server is waiting on tcp://*:60615
</pre></div>
</div>
<p><strong>Step 4.</strong> Open RE Worker environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver environment open
</pre></div>
</div>
<p><strong>Step 5.</strong> Verify that <code class="docutils literal notranslate"><span class="pre">existing_plans_and_devices.yaml</span></code> file was generated:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls
00-ophyd.py  15-plans.py  99-custom.py  existing_plans_and_devices.yaml  user_group_permissions.yaml
</pre></div>
</div>
<p>RE Manager is ready and plans may be submitted to the queue and executed. If plans or devices are
added or modified, the currently open environment must be closed and opened again to reload
the startup files and generate the new list of existing plans and devices.</p>
<p>In some configurations, it is convenient to place the startup files in the <code class="docutils literal notranslate"><span class="pre">startup</span></code> directory
for one of IPython profiles, so that they could be loaded into IPython. At NSLS-II it is
traditional to use the IPython profile named <code class="docutils literal notranslate"><span class="pre">collection</span></code> to run Bluesky software and
standard location for startup files is <code class="docutils literal notranslate"><span class="pre">~/.ipython/profile_collection/startup</span></code>.
RE Manager may be configured to find the startup files by explicitly specifying the directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ start-re-manager --startup-dir ~/.ipython/profile_collection/startup
</pre></div>
</div>
<p>or by specifying the name of the IPython profile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ start-re-manager --startup-profile collection
</pre></div>
</div>
<p>In addition to IPython-style sets of startup files, RE Manager may be configured to load
the code from a Python script (by specifying path to script file) or from an installed
Python module. The configuration instructions may be found in the section
<a class="reference internal" href="cli_tools.html#location-of-startup-code"><span class="std std-ref">Location of Startup Code</span></a>. Note, that the code for loading IPython-style startup
files performs patching to provide some compatibility with features of IPython.
Patching was implemented mostly to simplify transition from IPython workflow used on beamlines.
Startup scripts are assumed to be written for execution in pure Python environment and
are not patched. Ideally all blocks of code that use IPython features should be disabled
when executed in by the Queue Server (see <a class="reference internal" href="startup_code.html#detecting-if-code-executed-by-re-worker"><span class="std std-ref">Detecting if the Code is Executed by RE Worker</span></a>).</p>
</section>
<section id="manually-generating-lists-of-existing-plans-and-devices">
<span id="tutorial-manual-gen-list-of-plans-devices"></span><h2>Manually Generating Lists of Existing Plans and Devices<a class="headerlink" href="#manually-generating-lists-of-existing-plans-and-devices" title="Permalink to this headline">¶</a></h2>
<p>RE Manager generates or updates the list of existing plans and devices automatically when
RE Worker environment is opened, but in some cases it is convenient to generate
the list manually. For example, the developers wishing to update <code class="docutils literal notranslate"><span class="pre">existing_plans_and_devices.yaml</span></code>
in <a class="reference external" href="https://github.com/bluesky/bluesky-queueserver/tree/main/bluesky_queueserver/profile_collection_sim">the ‘profile_collection_sim’ directory</a>
when the respective startup files are modified have the only option to do it manually (RE Manager
is designed not to automatically modify files in built-in <code class="docutils literal notranslate"><span class="pre">profile_collection_sim</span></code> directory).</p>
<p><strong>Step 1.</strong> Create the directory with startup files and copy startup Python files as
described in <a class="reference internal" href="#tutorial-running-custom-startup-code"><span class="std std-ref">Running RE Manager with Custom Startup Code</span></a>. We will assume that
the files are in the directory <code class="docutils literal notranslate"><span class="pre">~/qt_startup</span></code>. The directory should contain
the following files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls
00-ophyd.py  15-plans.py  99-custom.py
</pre></div>
</div>
<p><strong>Step 2.</strong> Use <code class="docutils literal notranslate"><span class="pre">qserver-list-plans-devices</span></code> CLI tool to generate <code class="docutils literal notranslate"><span class="pre">existing_plans_and_devices.yaml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver-list-plans-devices --startup-dir ~/qs_startup --file-dir ~/qs_startup
</pre></div>
</div>
<p><strong>Step 3.</strong> Check if the file <code class="docutils literal notranslate"><span class="pre">existing_plans_and_devices.yaml</span></code> is created in the directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls
00-ophyd.py  15-plans.py  99-custom.py  existing_plans_and_devices.yaml
</pre></div>
</div>
<p>Alternatively, <code class="docutils literal notranslate"><span class="pre">qserver-list-plans-devices</span></code> may be started from the <code class="docutils literal notranslate"><span class="pre">~/qs_startup</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd ~/qs_startup
$ qserver-list-plans-devices --startup-dir .
</pre></div>
</div>
</section>
<section id="remote-monitoring-of-re-manager-console-output">
<span id="remote-monitoring-tutorial"></span><h2>Remote Monitoring of RE Manager Console Output<a class="headerlink" href="#remote-monitoring-of-re-manager-console-output" title="Permalink to this headline">¶</a></h2>
<p>Queue Server provides a simple <code class="docutils literal notranslate"><span class="pre">qserver-console-monitor</span></code> CLI tool for remote
monitoring of console output of RE Manager. The tool subscribes to messages
published by RE Manager over 0MQ and displays text contents of the messages. The
output of <code class="docutils literal notranslate"><span class="pre">qserver-console-monitor</span></code> is expected to be identical to the output
of RE Manager. There is also an option to disable printing of console output
RE Manager and use the external monitoring application for visualizing of
RE Manager output.</p>
<p>In Terminal 1 start <code class="docutils literal notranslate"><span class="pre">qserver-console-monitor</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qserver-console-monitor
</pre></div>
</div>
<p>In Terminal 2 start RE Manager with console output publishing available:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ start-re-manager --zmq-publish-console ON
</pre></div>
</div>
<p>Use Terminal 3 to run some commands using <code class="docutils literal notranslate"><span class="pre">qserver</span></code> tool. Terminals 1 and 2
must display identical output. Multiple instances of <code class="docutils literal notranslate"><span class="pre">qserver-console-monitor</span></code>
may be running simultaneously and display the same console output.
Experiment with closing (Ctrl-C) and restarting <code class="docutils literal notranslate"><span class="pre">qserver-console-monitor</span></code>.
Notice that all published console output is lost while the monitor is closed.</p>
<p>In Terminal 2, close RE Manager (Ctrl C) and restart it with the option that
disables printing of the console output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ start-re-manager --zmq-publish-console ON --console-output OFF
</pre></div>
</div>
<p>Notice that no output is printed in Terminal2. External monitor (running in
Terminal 1) is needed to visualize the output from RE Manager.</p>
<p>In practice, the client applications are expected to implement the
functionality for subscribing to published RE Manager output and displaying
it to users. The use of <code class="docutils literal notranslate"><span class="pre">qserver-console-monitor</span></code> tool should be limited to
evaluation, testing and debugging of the systems using RE Manager.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="release_history.html" class="btn btn-neutral float-right" title="Release History" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2021, Brookhaven National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>