<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Docker setup &mdash; ophyd  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Relationship to EPICS" href="../explanations/relationship-to-epics.html" />
    <link rel="prev" title="Pseudopositioner" href="pseudopositioner.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> ophyd
          </a>
              <div class="version">
                1.6.4.post2+g7909d08
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/install.html">Installation Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/single-PV.html">Single EPICS PVs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/device.html">Group Signals into Devices</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="pseudopositioner.html">Pseudopositioner</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Docker setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/relationship-to-epics.html">Relationship to EPICS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/area-detector.html">Area Detectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/status.html">Status objects (Futures)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/staging.html">Stage and Unstage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/core.html">Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/builtin-devices.html">Devices with Built-in Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/signals.html">Signals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/positioners.html">Positioners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/logging.html">Debugging and Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/release_notes.html">Release History</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bluesky Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io">Homepage</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bluesky">GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://gitter.im/NSLS-II/DAMA">Gitter</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ophyd</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Docker setup</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/how-to/docker.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="docker-setup">
<h1>Docker setup<a class="headerlink" href="#docker-setup" title="Permalink to this headline">Â¶</a></h1>
<p>You can use Docker to run test IOCs that are convenient for testing without
having to locally build and install EPICS IOCs. Please use the following
Docker links to install and configure Docker:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/">Installing Docker on Ubuntu</a></p></li>
<li><p><a class="reference external" href="https://docs.docker.com/engine/installation/linux/linux-postinstall/">Configuring Docker</a>
(allowing to run as non-root, running at startup, etc.)</p></li>
</ul>
</div></blockquote>
<p>To communicate with the Docker you have set up some environmental variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">export</span> <span class="nv">DOCKER0_IP</span><span class="o">=</span><span class="s2">&quot;172.17.0.1&quot;</span>
<span class="nb">export</span> <span class="nv">EPICS_CA_ADDR_LIST</span><span class="o">=</span><span class="k">$(</span> <span class="nb">echo</span> <span class="nv">$DOCKER0_IP</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/^\([0-9]\+\)\.\([0-9]\+\)\..*$/\1.\2.255.255/&#39;</span> <span class="k">)</span>
<span class="nb">export</span> <span class="nv">EPICS_CA_AUTO_ADDR_LIST</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="nb">export</span> <span class="nv">EPICS_CA_MAX_ARRAY_BYTES</span><span class="o">=</span><span class="m">10000000</span>
</pre></div>
</div>
<p>and to run docker with the correct images (assuming the preceding code block is
saved in <code class="file docutils literal notranslate"><span class="pre">epics_exports.sh</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">SCRIPTS_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">)</span><span class="s2">&quot;</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span> <span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">source</span> <span class="nv">$SCRIPTS_DIR</span>/epics_exports.sh

<span class="nv">MOTOR_DOCKERIMAGE</span><span class="o">=</span><span class="s2">&quot;nsls2/epics-docker:latest&quot;</span>
<span class="nv">PE_DOCKERIMAGE</span><span class="o">=</span><span class="s2">&quot;nsls2/pyepics-docker:latest&quot;</span>
<span class="nv">AD_DOCKERIMAGE</span><span class="o">=</span><span class="s2">&quot;prjemian/synapps-6.1-ad-3.7:latest&quot;</span>

docker pull <span class="si">${</span><span class="nv">MOTOR_DOCKERIMAGE</span><span class="si">}</span>
docker pull <span class="si">${</span><span class="nv">PE_DOCKERIMAGE</span><span class="si">}</span>
docker pull <span class="si">${</span><span class="nv">AD_DOCKERIMAGE</span><span class="si">}</span>

mkdir -p /tmp/ophyd_AD_test/

<span class="c1"># Create YYYY/MM/DD subdirectories.</span>
<span class="c1"># This is required because the images use a version of AD which</span>
<span class="c1"># does not create missing directories.</span>
python <span class="nv">$SCRIPTS_DIR</span>/create_directories.py /tmp/ophyd_AD_test/data1

docker run --rm -d -v /tmp/ophyd_AD_test:/tmp/ophyd_AD_test/ <span class="si">${</span><span class="nv">MOTOR_DOCKERIMAGE</span><span class="si">}</span>
docker run --name<span class="o">=</span>area-detector --rm -dit -v /tmp/ophyd_AD_test:/tmp/ophyd_AD_test/ -e <span class="nv">AD_PREFIX</span><span class="o">=</span><span class="s2">&quot;ADSIM:&quot;</span> <span class="si">${</span><span class="nv">AD_DOCKERIMAGE</span><span class="si">}</span> /bin/bash
sleep <span class="m">1</span>  <span class="c1"># Probably not needed?</span>
docker <span class="nb">exec</span> area-detector iocSimDetector/simDetector.sh start
docker run --rm -d <span class="si">${</span><span class="nv">PE_DOCKERIMAGE</span><span class="si">}</span>
</pre></div>
</div>
<p>Running this multiple times will lead to multiple instances of the
images running.</p>
<p>For EPICS to know where to search for the IOCs you will need to do</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> epics_exports.sh
</pre></div>
</div>
<p>to setup the EPICS environmental variables. To check that it is setup
correctly</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ env <span class="p">|</span> grep -i epics
<span class="nv">EPICS_CA_ADDR_LIST</span><span class="o">=</span><span class="m">172</span>.17.255.255
<span class="nv">EPICS_CA_AUTO_ADDR_LIST</span><span class="o">=</span>no
<span class="nv">EPICS_CA_MAX_ARRAY_BYTES</span><span class="o">=</span><span class="m">10000000</span>
</pre></div>
</div>
<p>To check if it is working, try</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ caget XF:31IDA-OP<span class="o">{</span>Tbl-Ax:X1<span class="o">}</span>Mtr
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may need to install <code class="docutils literal notranslate"><span class="pre">pyepics</span></code>, which installs <code class="docutils literal notranslate"><span class="pre">epics-base</span></code>
and the corresponding <code class="docutils literal notranslate"><span class="pre">caget</span></code> executable:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda install -c lightsource2-tag pyepics
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="pseudopositioner.html" class="btn btn-neutral float-left" title="Pseudopositioner" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../explanations/relationship-to-epics.html" class="btn btn-neutral float-right" title="Relationship to EPICS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014, Brookhaven National Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>